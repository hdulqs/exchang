function create_class(){var superClass,argc=arguments.length,func=function(){};if(argc){superClass=arguments[0];for(var k in superClass.prototype)func.prototype[k]=superClass.prototype[k]}for(var i=1;i<argc;i++){var feature=arguments[i],f=feature.prototype.__construct;f&&(func.prototype.__featureConstructors||(func.prototype.__featureConstructors=[]),func.prototype.__featureConstructors.push(f),delete feature.prototype.__construct);for(var k in feature.prototype)func.prototype[k]=feature.prototype[k];f&&(feature.prototype.__construct=f)}var newClass=function(){if(this.__construct&&this.__construct.apply(this,arguments),this.__featureConstructors){var i,a=this.__featureConstructors,c=a.length;for(i=0;i<c;i++)a[i].apply(this,arguments)}};return func.prototype.__classId=classId++,void 0!=superClass&&(newClass.__super=superClass.prototype,func.prototype.__super=superClass),newClass.prototype=new func,newClass}function is_instance(obj,clazz){var classId=clazz.prototype.__classId;if(obj.__classId==classId)return!0;for(var __super=obj.__super;void 0!=__super;){if(__super.prototype.__classId==classId)return!0;__super=__super.prototype.__super}return!1}function getCoinType(str){return parseInt(str.toString().charAt(8))}function format_time(v){return v<10?"0"+v.toString():v.toString()}function KLineMouseEvent(){$(document).ready(function(){function __resize(){navigator.userAgent.indexOf("Firefox")>=0?setTimeout(on_size,200):on_size()}__resize(),$(window).resize(__resize),$("#chart_overlayCanvas").bind("contextmenu",function(e){return e.cancelBubble=!0,e.returnValue=!1,e.preventDefault(),e.stopPropagation(),!1}),$("#chart_input_interface").submit(function(e){e.preventDefault();var text=$("#chart_input_interface_text").val(),json_text=JSON.parse(text),command=json_text.command,content=json_text.content;switch(command){case"set future list":ChartManager.getInstance().getChart().setFutureList(content);break;case"set current depth":ChartManager.getInstance().getChart().updateDepth(content);break;case"set current future":break;case"set current language":chart_switch_language(content);break;case"set current theme":}}),$("#chart_dropdown_symbols li").click(function(){$("#chart_dropdown_symbols li a").removeClass("selected"),$(this).find("a").addClass("selected"),$(".chart_dropdown_data").removeClass("chart_dropdown-hover"),$(".chart_dropdown_t").removeClass("chart_dropdown-hover");var content=$(this).attr("name");ChartManager.getInstance().getChart().setCurrentFuture(content)}),$("#chart_container .chart_dropdown .chart_dropdown_t").mouseover(function(){var container=$("#chart_container"),title=$(this),dropdown=title.next(),containerLeft=container.offset().left,titleLeft=title.offset().left,containerWidth=container.width(),titleWidth=title.width(),dropdownWidth=dropdown.width(),d=(dropdownWidth-titleWidth)/2<<0;titleLeft-d<containerLeft+4?d=titleLeft-containerLeft-4:d+=titleLeft+titleWidth+d>containerLeft+containerWidth-4?titleLeft+titleWidth+d-(containerLeft+containerWidth-4)+19:4,dropdown.css({"margin-left":-d}),title.addClass("chart_dropdown-hover"),dropdown.addClass("chart_dropdown-hover")}).mouseout(function(){$(this).next().removeClass("chart_dropdown-hover"),$(this).removeClass("chart_dropdown-hover")}),$(".chart_dropdown_data").mouseover(function(){$(this).addClass("chart_dropdown-hover"),$(this).prev().addClass("chart_dropdown-hover")}).mouseout(function(){$(this).prev().removeClass("chart_dropdown-hover"),$(this).removeClass("chart_dropdown-hover")}),$("#chart_btn_parameter_settings").click(function(){$("#chart_parameter_settings").addClass("clicked"),$(".chart_dropdown_data").removeClass("chart_dropdown-hover"),$("#chart_parameter_settings").find("th").each(function(){var name=$(this).html(),index=0,tmp=ChartSettings.get(),value=tmp.indics[name];$(this.nextElementSibling).find("input").each(function(){null!=value&&index<value.length&&$(this).val(value[index]),index++})}),window.parent&window.parent.eventLog({platform:2,eventId:"click_indicatorset_charts"})}),$("#close_settings").click(function(){$("#chart_parameter_settings").removeClass("clicked")}),$("#chart_container .chart_toolbar_tabgroup a").click(function(){switch_period($(this).parent().attr("name"))}),$("#chart_toolbar_periods_vert ul a").click(function(){switch_period($(this).parent().attr("name"))}),$("#chart_show_tools").click(function(){$(this).hasClass("selected")?switch_tools("off"):(switch_tools("on"),window.parent&&window.parent.eventLog({platform:2,eventId:"click_drawline_charts"}))}),$("#chart_toolpanel .chart_toolpanel_button").click(function(){$(".chart_dropdown_data").removeClass("chart_dropdown-hover"),$("#chart_toolpanel .chart_toolpanel_button").removeClass("selected"),$(this).addClass("selected");var name=$(this).children().attr("name");GLOBAL_VAR.chartMgr.setRunningMode(ChartManager.DrawingTool[name])}),$("#chart_show_indicator").click(function(){$(this).hasClass("selected")?switch_indic("off"):(switch_indic("on"),window.parent&&window.parent.eventLog({platform:2,eventId:"click_telindicators_charts"}))}),$("#chart_tabbar li a").click(function(){$("#chart_tabbar li a").removeClass("selected"),$(this).addClass("selected");var name=$(this).attr("name"),tmp=ChartSettings.get();tmp.charts.indics[1]=name,ChartSettings.save(),0==Template.displayVolume?ChartManager.getInstance().getChart().setIndicator(1,name):ChartManager.getInstance().getChart().setIndicator(2,name)}),$("#chart_select_chart_style a").click(function(){$("#chart_select_chart_style a").removeClass("selected"),$(this).addClass("selected");var tmp=ChartSettings.get();tmp.charts.chartStyle=$(this)[0].innerHTML,ChartSettings.save();var mgr=ChartManager.getInstance();mgr.setChartStyle("frame0.k0",$(this).html()),mgr.redraw("All",!0);var chartStyleName=$(this).html(),eventId="";switch(chartStyleName){case"CandleStick":eventId="click_mainpictype_candlestick_charts";break;case"CandleStickHLC":eventId="click_mainpictype_candlestickhlc_charts";break;case"OHLC":eventId="click_mainpictype_ohlc_charts"}""!==eventId&&window.parent&&window.parent.eventLog({platform:2,eventId:eventId})}),$("#chart_dropdown_themes li").click(function(){$("#chart_dropdown_themes li a").removeClass("selected");var name=$(this).attr("name");"chart_themes_dark"==name?switch_theme("dark"):"chart_themes_light"==name&&switch_theme("light")}),$("#chart_select_main_indicator a").click(function(){$("#chart_select_main_indicator a").removeClass("selected"),$(this).addClass("selected");var name=$(this).attr("name"),tmp=ChartSettings.get();tmp.charts.mIndic=name,ChartSettings.save();var mgr=ChartManager.getInstance();mgr.setMainIndicator("frame0.k0",name)||mgr.removeMainIndicator("frame0.k0"),mgr.redraw("All",!0);var eventId="";switch(name){case"MA":eventId="click_mainindicators_ma_charts";break;case"EMA":eventId="click_mainindicators_ema_charts";break;case"BOLL":eventId="click_mainindicators_boll_charts";break;case"SAR":eventId="click_mainindicators_sar_charts";break;case"NONE":eventId="click_mainindicators_off_charts"}""!==eventId&&window.parent&&window.parent.eventLog({platform:2,eventId:eventId})}),$("#chart_toolbar_theme a").click(function(){$("#chart_toolbar_theme a").removeClass("selected"),"dark"==$(this).attr("name")?switch_theme("dark"):"light"==$(this).attr("name")&&switch_theme("light")}),$("#chart_select_theme li a").click(function(){$("#chart_select_theme a").removeClass("selected"),"dark"==$(this).attr("name")?switch_theme("dark"):"light"==$(this).attr("name")&&switch_theme("light")}),$("#chart_enable_tools li a").click(function(){$("#chart_enable_tools a").removeClass("selected"),"on"==$(this).attr("name")?switch_tools("on"):"off"==$(this).attr("name")&&switch_tools("off")}),$("#chart_enable_indicator li a").click(function(){$("#chart_enable_indicator a").removeClass("selected"),"on"==$(this).attr("name")?switch_indic("on"):"off"==$(this).attr("name")&&switch_indic("off")}),$(document).keyup(function(e){46==e.keyCode&&(ChartManager.getInstance().deleteToolObject(),ChartManager.getInstance().redraw("OverlayCanvas",!1))}),$("#chart_overlayCanvas").mousemove(function(e){var r=e.target.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top,mgr=ChartManager.getInstance();1==GLOBAL_VAR.button_down?(mgr.onMouseMove("frame0",x,y,!0),mgr.redraw("All",!0)):(mgr.onMouseMove("frame0",x,y,!1),mgr.redraw("OverlayCanvas"))}).mouseleave(function(e){var r=e.target.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top,mgr=ChartManager.getInstance();mgr.onMouseLeave("frame0",x,y,!1),mgr.redraw("OverlayCanvas")}).mouseup(function(e){if(1==e.which){GLOBAL_VAR.button_down=!1;var r=e.target.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top,mgr=ChartManager.getInstance();mgr.onMouseUp("frame0",x,y),mgr.redraw("All",!0)}}).mousedown(function(e){if(1!=e.which)return ChartManager.getInstance().deleteToolObject(),void ChartManager.getInstance().redraw("OverlayCanvas",!1);GLOBAL_VAR.button_down=!0;var r=e.target.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;ChartManager.getInstance().onMouseDown("frame0",x,y)}),$("#chart_parameter_settings :input").change(function(){var name=$(this).attr("name"),index=0,valueArray=[],mgr=ChartManager.getInstance();if($("#chart_parameter_settings :input").each(function(){if($(this).attr("name")==name){if(""!=$(this).val()&&null!=$(this).val()&&void 0!=$(this).val()){var i=parseInt($(this).val());valueArray.push(i)}index++}}),0!=valueArray.length){mgr.setIndicatorParameters(name,valueArray);var value=mgr.getIndicatorParameters(name),cookieArray=[];index=0,$("#chart_parameter_settings :input").each(function(){$(this).attr("name")==name&&(""!=$(this).val()&&null!=$(this).val()&&void 0!=$(this).val()&&($(this).val(value[index].getValue()),cookieArray.push(value[index].getValue())),index++)});var tmp=ChartSettings.get();tmp.indics[name]=cookieArray,ChartSettings.save(),mgr.redraw("All",!0)}}),$("#chart_parameter_settings button").click(function(){var name=$(this).parents("tr").children("th").html(),index=0,value=ChartManager.getInstance().getIndicatorParameters(name),valueArray=[];$(this).parent().prev().children("input").each(function(){null!=value&&index<value.length&&($(this).val(value[index].getDefaultValue()),valueArray.push(value[index].getDefaultValue())),index++}),ChartManager.getInstance().setIndicatorParameters(name,valueArray);var tmp=ChartSettings.get();tmp.indics[name]=valueArray,ChartSettings.save(),ChartManager.getInstance().redraw("All",!1)})})}function refresh_function(){refresh_counter++;var lang=ChartManager.getInstance().getLanguage();if(refresh_counter>3600){var num=new Number(refresh_counter/3600);"en-us"==lang?$("#chart_updated_time_text").html(num.toFixed(0)+"h"):$("#chart_updated_time_text").html(num.toFixed(0)+"小时")}else if(refresh_counter>60&&refresh_counter<=3600){var num=new Number(refresh_counter/60);"en-us"==lang?$("#chart_updated_time_text").html(num.toFixed(0)+"m"):$("#chart_updated_time_text").html(num.toFixed(0)+"分钟")}else refresh_counter<=60&&("en-us"==lang?$("#chart_updated_time_text").html(refresh_counter+"s"):$("#chart_updated_time_text").html(refresh_counter+"秒"))}function clear_refresh_counter(){window.clearInterval(refresh_handler),refresh_counter=0;var lang=ChartManager.getInstance().getLanguage();"en-us"==lang?$("#chart_updated_time_text").html(refresh_counter+"s"):$("#chart_updated_time_text").html(refresh_counter+"秒"),refresh_handler=setInterval(refresh_function,1e3)}function AbortRequest(){GLOBAL_VAR.G_HTTP_REQUEST&&4!=GLOBAL_VAR.G_HTTP_REQUEST.readyState&&GLOBAL_VAR.G_HTTP_REQUEST.abort()}function TwoSecondThread(){var f=GLOBAL_VAR.chartMgr.getDataSource("frame0.k0").getLastDate();f==-1?GLOBAL_VAR.requestParam=setHttpRequestParam(GLOBAL_VAR.mark_from,GLOBAL_VAR.time_type,"1000",null):GLOBAL_VAR.requestParam=setHttpRequestParam(GLOBAL_VAR.mark_from,GLOBAL_VAR.time_type,null,f.toString()),RequestData()}function readCookie(){ChartSettings.get(),ChartSettings.save();var tmp=ChartSettings.get();ChartManager.getInstance().setChartStyle("frame0.k0",tmp.charts.chartStyle);var period=tmp.charts.period;switch_period(period),$("#chart_period_"+period+"_v a").addClass("selected"),$("#chart_period_"+period+"_h a").addClass("selected"),"close"==tmp.charts.indicsStatus?switch_indic("off"):"open"==tmp.charts.indicsStatus&&switch_indic("on");var main_indic=$("#chart_select_main_indicator");main_indic.find("a").each(function(){$(this).attr("name")==tmp.charts.mIndic&&$(this).addClass("selected")});var chart_style=$("#chart_select_chart_style");chart_style.find("a").each(function(){$(this)[0].innerHTML==tmp.charts.chartStyle&&$(this).addClass("selected")}),ChartManager.getInstance().getChart().setMainIndicator(tmp.charts.mIndic),ChartManager.getInstance().setThemeName("frame0",tmp.theme),switch_tools("off"),"Dark"==tmp.theme?switch_theme("dark"):"Light"==tmp.theme&&switch_theme("light")}function setHttpRequestParam(mark_from,time_type,limit,since){var str="marketFrom="+mark_from+"&type="+time_type;switch(str+=null!=limit?"&limit="+limit:"&since="+since,ChartManager.getInstance().getChart()._contract_unit){case 0:str+="&coinVol=1";break;case 1:str+="&coinVol=0"}return str}function refreshTemplate(){GLOBAL_VAR.chartMgr=DefaultTemplate.loadTemplate("frame0.k0","OKCoin"+GLOBAL_VAR.mark_from+GLOBAL_VAR.time_type,"frame0.order","0.order","frame0.trade","0.trade"),ChartManager.getInstance().redraw("All",!0)}function getRectCrossPt(rect,startPt,endPt){var crossPt,firstPt={x:-1,y:-1},secondPt={x:-1,y:-1},xdiff=endPt.x-startPt.x,ydiff=endPt.y-startPt.y;if(Math.abs(xdiff)<2)return firstPt={x:startPt.x,y:rect.top},secondPt={x:endPt.x,y:rect.bottom},crossPt=[firstPt,secondPt];var k=ydiff/xdiff;return secondPt.x=rect.right,secondPt.y=startPt.y+(rect.right-startPt.x)*k,firstPt.x=rect.left,firstPt.y=startPt.y+(rect.left-startPt.x)*k,crossPt=[firstPt,secondPt]}function chart_switch_language(lang){var tmp=lang.replace(/-/,"_");$("#chart_language_switch_tmp").find("span").each(function(){var name=$(this).attr("name"),attr=$(this).attr(tmp);name="."+name;var obj=$(name)[0];obj&&$(name).each(function(){$(this)[0].innerHTML=attr})}),ChartManager.getInstance().setLanguage(lang),ChartManager.getInstance().getChart().setTitle()}function on_size(){var width=window.innerWidth,height=window.innerHeight,container=$("#chart_container");container.css({width:width+"px",height:height+"px"});var toolBar=$("#chart_toolbar"),toolPanel=$("#chart_toolpanel"),canvasGroup=$("#chart_canvasGroup"),tabBar=$("#chart_tabbar"),toolPanelShown="inline"==toolPanel[0].style.display,tabBarShown="block"==tabBar[0].style.display,toolBarRect={};toolBarRect.x=0,toolBarRect.y=0,toolBarRect.w=width,toolBarRect.h=29;var toolPanelRect={};toolPanelRect.x=0,toolPanelRect.y=toolBarRect.h+1,toolPanelRect.w=toolPanelShown?32:0,toolPanelRect.h=height-toolPanelRect.y;var tabBarRect={};tabBarRect.w=toolPanelShown?width-(toolPanelRect.w+1):width,tabBarRect.h=tabBarShown?22:-1,tabBarRect.x=width-tabBarRect.w,tabBarRect.y=height-(tabBarRect.h+1);var canvasGroupRect={};canvasGroupRect.x=tabBarRect.x,canvasGroupRect.y=toolPanelRect.y,canvasGroupRect.w=tabBarRect.w,canvasGroupRect.h=tabBarRect.y-toolPanelRect.y,toolBar.css({left:toolBarRect.x+"px",top:toolBarRect.y+"px",width:toolBarRect.w+"px",height:toolBarRect.h+"px"}),toolPanelShown&&toolPanel.css({left:toolPanelRect.x+"px",top:toolPanelRect.y+"px",width:toolPanelRect.w+"px",height:toolPanelRect.h+"px"}),canvasGroup.css({left:canvasGroupRect.x+"px",top:canvasGroupRect.y+"px",width:canvasGroupRect.w+"px",height:canvasGroupRect.h+"px"});var mainCanvas=$("#chart_mainCanvas")[0],overlayCanvas=$("#chart_overlayCanvas")[0];mainCanvas.width=canvasGroupRect.w,mainCanvas.height=canvasGroupRect.h,overlayCanvas.width=canvasGroupRect.w,overlayCanvas.height=canvasGroupRect.h,tabBarShown&&tabBar.css({left:tabBarRect.x+"px",top:tabBarRect.y+"px",width:tabBarRect.w+"px",height:tabBarRect.h+"px"});var dlgSettings=$("#chart_parameter_settings");dlgSettings.css({left:width-dlgSettings.width()>>1,top:height-dlgSettings.height()>>1});var dlgLoading=$("#chart_loading");dlgLoading.css({left:width-dlgLoading.width()>>1,top:height-dlgLoading.height()>>2});var domElemCache=$("#chart_dom_elem_cache"),rowTheme=$("#chart_select_theme")[0],rowTools=$("#chart_enable_tools")[0],rowIndic=$("#chart_enable_indicator")[0],dropDownSymbols=$("#chart_dropdown_symbols"),periodsVert=$("#chart_toolbar_periods_vert"),periodsHorz=$("#chart_toolbar_periods_horz")[0],showIndic=$("#chart_show_indicator")[0],showTools=$("#chart_show_tools")[0],selectTheme=$("#chart_toolbar_theme")[0],dropDownSettings=$("#chart_dropdown_settings"),dropDownSymbolsNW=4+dropDownSymbols.find(".chart_dropdown_t")[0].offsetWidth,periodsVertNW=dropDownSymbolsNW+periodsVert[0].offsetWidth,periodsHorzNW=periodsVertNW+periodsHorz.offsetWidth,showIndicNW=periodsHorzNW+showIndic.offsetWidth+4,showToolsNW=showIndicNW+showTools.offsetWidth+4,selectThemeNW=showToolsNW+selectTheme.offsetWidth,dropDownSettingsW=dropDownSettings.find(".chart_dropdown_t")[0].offsetWidth+128;dropDownSymbolsNW+=dropDownSettingsW,periodsVertNW+=dropDownSettingsW,periodsHorzNW+=dropDownSettingsW,showIndicNW+=dropDownSettingsW,showToolsNW+=dropDownSettingsW,selectThemeNW+=dropDownSettingsW,width<periodsHorzNW?domElemCache.append(periodsHorz):periodsVert.after(periodsHorz),width<showIndicNW?(domElemCache.append(showIndic),rowIndic.style.display=""):(dropDownSettings.before(showIndic),rowIndic.style.display="none"),width<showToolsNW?(domElemCache.append(showTools),rowTools.style.display=""):(dropDownSettings.before(showTools),rowTools.style.display="none"),width<selectThemeNW?(domElemCache.append(selectTheme),rowTheme.style.display=""):(dropDownSettings.before(selectTheme),rowTheme.style.display="none"),ChartManager.getInstance().redraw("All",!0)}function mouseWheel(e,delta){return ChartManager.getInstance().scale(delta>0?1:-1),ChartManager.getInstance().redraw("All",!0),!1}function switch_theme(name){$("#chart_toolbar_theme a").removeClass("selected"),$("#chart_select_theme a").removeClass("selected");var eventId="";if("dark"==name){$("#chart_toolbar_theme").find("a").each(function(){"dark"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_select_theme a").each(function(){"dark"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_container").attr("class","dark"),$("#kline_logo").removeClass("kline_logo_weight"),$("#kline_logo").addClass("kline_logo_black"),ChartManager.getInstance().setThemeName("frame0","Dark");var tmp=ChartSettings.get();tmp.theme="Dark",ChartSettings.save(),$("#chart_canvasGroup").removeClass("chart_canvasGroup_whiteLogo"),$("#chart_canvasGroup").addClass("chart_canvasGroup_blackLogo"),eventId="click_theme_black_charts"}else if("light"==name){$("#chart_toolbar_theme").find("a").each(function(){"light"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_select_theme a").each(function(){"light"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_container").attr("class","light"),$("#kline_logo").removeClass("kline_logo_black"),$("#kline_logo").addClass("kline_logo_weight"),ChartManager.getInstance().setThemeName("frame0","Light");var tmp=ChartSettings.get();tmp.theme="Light",ChartSettings.save(),$("#chart_canvasGroup").removeClass("chart_canvasGroup_blackLogo"),$("#chart_canvasGroup").addClass("chart_canvasGroup_whiteLogo"),eventId="click_theme_white_charts"}var a={};a.command="set current theme",a.content=name,$("#chart_output_interface_text").val(JSON.stringify(a)),$("#chart_output_interface_submit").submit(),window._current_theme_change.raise(name),ChartManager.getInstance().redraw(),""!==eventId&&window.parent&&window.parent.eventLog({platform:2,eventId:eventId})}function switch_tools(name){$(".chart_dropdown_data").removeClass("chart_dropdown-hover"),$("#chart_toolpanel .chart_toolpanel_button").removeClass("selected"),$("#chart_enable_tools a").removeClass("selected"),"on"==name?($("#chart_show_tools").addClass("selected"),$("#chart_enable_tools a").each(function(){"on"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_toolpanel")[0].style.display="inline",ChartManager.getInstance()._drawingTool==ChartManager.DrawingTool.Cursor?$("#chart_Cursor").parent().addClass("selected"):ChartManager.getInstance()._drawingTool==ChartManager.DrawingTool.CrossCursor&&$("#chart_CrossCursor").parent().addClass("selected")):"off"==name&&($("#chart_show_tools").removeClass("selected"),$("#chart_enable_tools a").each(function(){"off"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_toolpanel")[0].style.display="none",ChartManager.getInstance().setRunningMode(ChartManager.getInstance()._beforeDrawingTool),ChartManager.getInstance().redraw("All",!0)),on_size()}function switch_indic(name){if($("#chart_enable_indicator a").removeClass("selected"),"on"==name){$("#chart_enable_indicator a").each(function(){"on"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_show_indicator").addClass("selected");var tmp=ChartSettings.get();tmp.charts.indicsStatus="open",ChartSettings.save();var value=tmp.charts.indics[1];0==Template.displayVolume?ChartManager.getInstance().getChart().setIndicator(2,value):ChartManager.getInstance().getChart().setIndicator(2,value),$("#chart_tabbar").find("a").each(function(){$(this).attr("name")==value&&$(this).addClass("selected")}),$("#chart_tabbar")[0].style.display="block"}else if("off"==name){$("#chart_enable_indicator a").each(function(){"off"==$(this).attr("name")&&$(this).addClass("selected")}),$("#chart_show_indicator").removeClass("selected"),ChartManager.getInstance().getChart().setIndicator(2,"NONE");var tmp=ChartSettings.get();tmp.charts.indicsStatus="close",ChartSettings.save(),$("#chart_tabbar")[0].style.display="none",$("#chart_tabbar a").removeClass("selected")}on_size()}function switch_period(name){if($("#chart_container .chart_toolbar_tabgroup a").removeClass("selected"),$("#chart_toolbar_periods_vert ul a").removeClass("selected"),$("#chart_container .chart_toolbar_tabgroup a").each(function(){$(this).parent().attr("name")==name&&$(this).addClass("selected")}),$("#chart_toolbar_periods_vert ul a").each(function(){$(this).parent().attr("name")==name&&$(this).addClass("selected")}),ChartManager.getInstance().showCursor(),calcPeriodWeight(name),"line"==name){ChartManager.getInstance().getChart().strIsLine=!0,ChartManager.getInstance().setChartStyle("frame0.k0","Line"),ChartManager.getInstance().getChart().setCurrentPeriod("01m");var settings=ChartSettings.get();return settings.charts.period=name,ChartSettings.save(),void ChartManager.getInstance().redraw("All",!0)}ChartManager.getInstance().getChart().strIsLine=!1;var p=GLOBAL_VAR.tagMapPeriod[name];ChartManager.getInstance().setChartStyle("frame0.k0",ChartSettings.get().charts.chartStyle),ChartManager.getInstance().getChart().setCurrentPeriod(p);var settings=ChartSettings.get();settings.charts.period=name,ChartSettings.save(),ChartManager.getInstance().redraw("All",!0)}function IsSupportedBrowers(){function isCanvasSupported(){var elem=document.createElement("canvas");return!(!elem.getContext||!elem.getContext("2d"))}return!!isCanvasSupported()}function calcPeriodWeight(period){var index=period;"line"!=period&&(index=GLOBAL_VAR.periodMap[GLOBAL_VAR.tagMapPeriod[period]]);var period_weight=ChartSettings.get().charts.period_weight;for(var i in period_weight)period_weight[i]>period_weight[index]&&(period_weight[i]-=1);period_weight[index]=8,ChartSettings.save(),$("#chart_toolbar_periods_horz").find("li").each(function(){var a=$(this).attr("name"),i=a;"line"!=a&&(i=GLOBAL_VAR.periodMap[GLOBAL_VAR.tagMapPeriod[a]]),0==period_weight[i]?$(this).css("display","none"):$(this).css("display","inline-block")})}var GLOBAL_VAR={KLineAllData:new Object,KLineData:new Object,time_type:"2",mark_from:"11",limit:"1000",requestParam:"marketFrom=11&type=15min&limit=1000",periodMap:null,chartMgr:null,G_HTTP_REQUEST:null,TimeOutId:null,button_down:!1,url:"/api/klineData.do",digits:8};String.prototype.toFixed=function(rate){return Number(this).toFixed(rate)},GLOBAL_VAR.periodMap={"01w":"week","03d":"3day","01d":"day","12h":"12hour","06h":"6hour","04h":"4hour","02h":"2hour","01h":"1hour","30m":"30min","15m":"15min","05m":"5min","03m":"3min","01m":"1min"},GLOBAL_VAR.tagMapPeriod={"1w":"01w","3d":"03d","1d":"01d","12h":"12h","6h":"06h","4h":"04h","2h":"02h","1h":"01h","30m":"30m","15m":"15m","5m":"05m","3m":"03m","1m":"01m"};var classId=0,MEvent=create_class();MEvent.prototype.__construct=function(){this._handlers=[]},MEvent.prototype.addHandler=function(o,f){this._indexOf(o,f)<0&&this._handlers.push({obj:o,func:f})},MEvent.prototype.removeHandler=function(o,f){var i=this._indexOf(o,f);i>=0&&this._handlers.splice(i,1)},MEvent.prototype.raise=function(s,g){var e,i,a=this._handlers,c=a.length;for(i=0;i<c;i++)e=a[i],e.func.call(e.obj,s,g)},MEvent.prototype._indexOf=function(o,f){var e,i,a=this._handlers,c=a.length;for(i=0;i<c;i++)if(e=a[i],o==e.obj&&f==e.func)return i;return-1},String.fromFloat=function(v,fractionDigits){for(var text=v.toFixed(fractionDigits),i=text.length-1;i>=0;i--){if("."==text[i])return text.substring(0,i);if("0"!=text[i])return text.substring(0,i+1)}};var ExprEnv=create_class();ExprEnv.get=function(){return ExprEnv.inst},ExprEnv.set=function(env){ExprEnv.inst=env},ExprEnv.prototype.getDataSource=function(){return this._ds},ExprEnv.prototype.setDataSource=function(ds){return this._ds=ds},ExprEnv.prototype.getFirstIndex=function(){return this._firstIndex},ExprEnv.prototype.setFirstIndex=function(n){return this._firstIndex=n};var Expr=create_class();Expr.prototype.__construct=function(){this._rid=0},Expr.prototype.execute=function(index){},Expr.prototype.reserve=function(rid,count){},Expr.prototype.clear=function(){};var OpenExpr=create_class(Expr),HighExpr=create_class(Expr),LowExpr=create_class(Expr),CloseExpr=create_class(Expr),VolumeExpr=create_class(Expr);OpenExpr.prototype.execute=function(index){return ExprEnv.get()._ds.getDataAt(index).open},HighExpr.prototype.execute=function(index){return ExprEnv.get()._ds.getDataAt(index).high},LowExpr.prototype.execute=function(index){return ExprEnv.get()._ds.getDataAt(index).low},CloseExpr.prototype.execute=function(index){return ExprEnv.get()._ds.getDataAt(index).close},VolumeExpr.prototype.execute=function(index){return ExprEnv.get()._ds.getDataAt(index).volume};var ConstExpr=create_class(Expr);ConstExpr.prototype.__construct=function(v){ConstExpr.__super.__construct.call(this),this._value=v},ConstExpr.prototype.execute=function(index){return this._value};var ParameterExpr=create_class(Expr);ParameterExpr.prototype.__construct=function(name,minValue,maxValue,defaultValue){ParameterExpr.__super.__construct.call(this),this._name=name,this._minValue=minValue,this._maxValue=maxValue,this._value=this._defaultValue=defaultValue},ParameterExpr.prototype.execute=function(index){return this._value},ParameterExpr.prototype.getMinValue=function(){return this._minValue},ParameterExpr.prototype.getMaxValue=function(){return this._maxValue},ParameterExpr.prototype.getDefaultValue=function(){return this._defaultValue},ParameterExpr.prototype.getValue=function(){return this._value},ParameterExpr.prototype.setValue=function(v){0==v?this._value=0:v<this._minValue?this._value=this._minValue:v>this._maxValue?this._value=this._maxValue:this._value=v};var OpAExpr=create_class(Expr),OpABExpr=create_class(Expr),OpABCExpr=create_class(Expr),OpABCDExpr=create_class(Expr);OpAExpr.prototype.__construct=function(a){OpAExpr.__super.__construct.call(this),this._exprA=a},OpAExpr.prototype.reserve=function(rid,count){this._rid<rid&&(this._rid=rid,this._exprA.reserve(rid,count))},OpAExpr.prototype.clear=function(){this._exprA.clear()},OpABExpr.prototype.__construct=function(a,b){OpABExpr.__super.__construct.call(this),this._exprA=a,this._exprB=b},OpABExpr.prototype.reserve=function(rid,count){this._rid<rid&&(this._rid=rid,this._exprA.reserve(rid,count),this._exprB.reserve(rid,count))},OpABExpr.prototype.clear=function(){this._exprA.clear(),this._exprB.clear()},OpABCExpr.prototype.__construct=function(a,b,c){OpABCExpr.__super.__construct.call(this),this._exprA=a,this._exprB=b,this._exprC=c},OpABCExpr.prototype.reserve=function(rid,count){this._rid<rid&&(this._rid=rid,this._exprA.reserve(rid,count),this._exprB.reserve(rid,count),this._exprC.reserve(rid,count))},OpABCExpr.prototype.clear=function(){this._exprA.clear(),this._exprB.clear(),this._exprC.clear()},OpABCDExpr.prototype.__construct=function(a,b,c,d){OpABCDExpr.__super.__construct.call(this),this._exprA=a,this._exprB=b,this._exprC=c,this._exprD=d},OpABCDExpr.prototype.reserve=function(rid,count){this._rid<rid&&(this._rid=rid,this._exprA.reserve(rid,count),this._exprB.reserve(rid,count),this._exprC.reserve(rid,count),this._exprD.reserve(rid,count))},OpABCDExpr.prototype.clear=function(){this._exprA.clear(),this._exprB.clear(),this._exprC.clear(),this._exprD.clear()};var NegExpr=create_class(OpAExpr);NegExpr.prototype.__construct=function(a){NegExpr.__super.__construct.call(this,a)},NegExpr.prototype.execute=function(index){return-this._exprA.execute(index)};var AddExpr=create_class(OpABExpr),SubExpr=create_class(OpABExpr),MulExpr=create_class(OpABExpr),DivExpr=create_class(OpABExpr);AddExpr.prototype.__construct=function(a,b){AddExpr.__super.__construct.call(this,a,b)},SubExpr.prototype.__construct=function(a,b){SubExpr.__super.__construct.call(this,a,b)},MulExpr.prototype.__construct=function(a,b){MulExpr.__super.__construct.call(this,a,b)},DivExpr.prototype.__construct=function(a,b){DivExpr.__super.__construct.call(this,a,b)},AddExpr.prototype.execute=function(index){return this._exprA.execute(index)+this._exprB.execute(index)},SubExpr.prototype.execute=function(index){return this._exprA.execute(index)-this._exprB.execute(index)},MulExpr.prototype.execute=function(index){return this._exprA.execute(index)*this._exprB.execute(index)},DivExpr.prototype.execute=function(index){var a=this._exprA.execute(index),b=this._exprB.execute(index);return 0==a?a:0==b?a>0?1e6:-1e6:a/b};var GtExpr=create_class(OpABExpr),GeExpr=create_class(OpABExpr),LtExpr=create_class(OpABExpr),LeExpr=create_class(OpABExpr),EqExpr=create_class(OpABExpr);GtExpr.prototype.__construct=function(a,b){GtExpr.__super.__construct.call(this,a,b)},GeExpr.prototype.__construct=function(a,b){GeExpr.__super.__construct.call(this,a,b)},LtExpr.prototype.__construct=function(a,b){LtExpr.__super.__construct.call(this,a,b)},LeExpr.prototype.__construct=function(a,b){LeExpr.__super.__construct.call(this,a,b)},EqExpr.prototype.__construct=function(a,b){EqExpr.__super.__construct.call(this,a,b)},GtExpr.prototype.execute=function(index){return this._exprA.execute(index)>this._exprB.execute(index)?1:0},GeExpr.prototype.execute=function(index){return this._exprA.execute(index)>=this._exprB.execute(index)?1:0},LtExpr.prototype.execute=function(index){return this._exprA.execute(index)<this._exprB.execute(index)?1:0},LeExpr.prototype.execute=function(index){return this._exprA.execute(index)<=this._exprB.execute(index)?1:0},EqExpr.prototype.execute=function(index){return this._exprA.execute(index)==this._exprB.execute(index)?1:0};var MaxExpr=create_class(OpABExpr);MaxExpr.prototype.__construct=function(a,b){MaxExpr.__super.__construct.call(this,a,b)},MaxExpr.prototype.execute=function(index){return Math.max(this._exprA.execute(index),this._exprB.execute(index))};var AbsExpr=create_class(OpAExpr);AbsExpr.prototype.__construct=function(a){AbsExpr.__super.__construct.call(this,a)},AbsExpr.prototype.execute=function(index){return Math.abs(this._exprA.execute(index))};var RefExpr=create_class(OpABExpr);RefExpr.prototype.__construct=function(a,b){RefExpr.__super.__construct.call(this,a,b),this._offset=-1},RefExpr.prototype.execute=function(index){if(this._offset<0&&(this._offset=this._exprB.execute(index),this._offset<0))throw"offset < 0";if(index-=this._offset,index<0)throw"index < 0";
var result=this._exprA.execute(index);if(isNaN(result))throw"NaN";return result};var AndExpr=create_class(OpABExpr),OrExpr=create_class(OpABExpr);AndExpr.prototype.__construct=function(a,b){AndExpr.__super.__construct.call(this,a,b)},OrExpr.prototype.__construct=function(a,b){OrExpr.__super.__construct.call(this,a,b)},AndExpr.prototype.execute=function(index){return 0!=this._exprA.execute(index)&&0!=this._exprB.execute(index)?1:0},OrExpr.prototype.execute=function(index){return 0!=this._exprA.execute(index)||0!=this._exprB.execute(index)?1:0};var IfExpr=create_class(OpABCExpr);IfExpr.prototype.__construct=function(a,b,c){IfExpr.__super.__construct.call(this,a,b,c)},IfExpr.prototype.execute=function(index){return 0!=this._exprA.execute(index)?this._exprB.execute(index):this._exprC.execute(index)};var AssignExpr=create_class(OpAExpr);AssignExpr.prototype.__construct=function(name,a){AssignExpr.__super.__construct.call(this,a),this._name=name,this._buf=[]},AssignExpr.prototype.getName=function(){return this._name},AssignExpr.prototype.execute=function(index){return this._buf[index]},AssignExpr.prototype.assign=function(index){if(this._buf[index]=this._exprA.execute(index),ExprEnv.get()._firstIndex>=0&&isNaN(this._buf[index])&&!isNaN(this._buf[index-1]))throw this._name+".assign("+index+"): NaN"},AssignExpr.prototype.reserve=function(rid,count){if(this._rid<rid)for(var c=count;c>0;c--)this._buf.push(NaN);AssignExpr.__super.reserve.call(this,rid,count)},AssignExpr.prototype.clear=function(){AssignExpr.__super.clear.call(this),this._buf=[]};var OutputStyle={None:0,Line:1,VolumeStick:2,MACDStick:3,SARPoint:4},OutputExpr=create_class(AssignExpr);OutputExpr.prototype.__construct=function(name,a,style,color){OutputExpr.__super.__construct.call(this,name,a),this._style=void 0===style?OutputStyle.Line:style,this._color=color},OutputExpr.prototype.getStyle=function(){return this._style},OutputExpr.prototype.getColor=function(){return this._color};var RangeOutputExpr=create_class(OutputExpr);RangeOutputExpr.prototype.__construct=function(name,a,style,color){RangeOutputExpr.__super.__construct.call(this,name,a,style,color)},RangeOutputExpr.prototype.getName=function(){return this._name+this._exprA.getRange()};var RangeExpr=create_class(OpABExpr);RangeExpr.prototype.__construct=function(a,b){RangeExpr.__super.__construct.call(this,a,b),this._range=-1,this._buf=[]},RangeExpr.prototype.getRange=function(){return this._range},RangeExpr.prototype.initRange=function(){this._range=this._exprB.execute(0)},RangeExpr.prototype.execute=function(index){this._range<0&&this.initRange();var rA=this._buf[index].resultA=this._exprA.execute(index),r=this._buf[index].result=this.calcResult(index,rA);return r},RangeExpr.prototype.reserve=function(rid,count){if(this._rid<rid)for(var c=count;c>0;c--)this._buf.push({resultA:NaN,result:NaN});RangeExpr.__super.reserve.call(this,rid,count)},RangeExpr.prototype.clear=function(){RangeExpr.__super.clear.call(this),this._range=-1,this._buf=[]};var HhvExpr=create_class(RangeExpr),LlvExpr=create_class(RangeExpr);HhvExpr.prototype.__construct=function(a,b){HhvExpr.__super.__construct.call(this,a,b)},LlvExpr.prototype.__construct=function(a,b){LlvExpr.__super.__construct.call(this,a,b)},HhvExpr.prototype.calcResult=function(index,resultA){if(0==this._range)return NaN;var first=ExprEnv.get()._firstIndex;if(first<0)return resultA;if(index>first){for(var n=this._range,result=resultA,start=index-n+1,i=Math.max(first,start);i<index;i++){var p=this._buf[i];result<p.resultA&&(result=p.resultA)}return result}return resultA},LlvExpr.prototype.calcResult=function(index,resultA){if(0==this._range)return NaN;var first=ExprEnv.get()._firstIndex;if(first<0)return resultA;if(index>first){for(var n=this._range,result=resultA,start=index-n+1,i=Math.max(first,start);i<index;i++){var p=this._buf[i];result>p.resultA&&(result=p.resultA)}return result}return resultA};var CountExpr=create_class(RangeExpr);CountExpr.prototype.__construct=function(a,b){CountExpr.__super.__construct.call(this,a,b)},CountExpr.prototype.calcResult=function(index,resultA){if(0==this._range)return NaN;var first=ExprEnv.get()._firstIndex;if(first<0)return 0;if(index>=first){var n=this._range-1;n>index-first&&(n=index-first);for(var count=0;n>=0;n--)0!=this._buf[index-n].resultA&&count++;return count}return 0};var SumExpr=create_class(RangeExpr);SumExpr.prototype.__construct=function(a,b){SumExpr.__super.__construct.call(this,a,b)},SumExpr.prototype.calcResult=function(index,resultA){var first=ExprEnv.get()._firstIndex;if(first<0)return resultA;if(index>first){var n=this._range;return 0==n||n>=index+1-first?this._buf[index-1].result+resultA:this._buf[index-1].result+resultA-this._buf[index-n].resultA}return resultA};var StdExpr=create_class(RangeExpr);StdExpr.prototype.__construct=function(a,b){StdExpr.__super.__construct.call(this,a,b)},StdExpr.prototype.calcResult=function(index,resultA){if(0==this._range)return NaN;var stdData=this._stdBuf[index],first=ExprEnv.get()._firstIndex;if(first<0)return stdData.resultMA=resultA,0;if(index>first){var n=this._range;n>=index+1-first?(n=index+1-first,stdData.resultMA=this._stdBuf[index-1].resultMA*(1-1/n)+resultA/n):stdData.resultMA=this._stdBuf[index-1].resultMA+(resultA-this._buf[index-n].resultA)/n;for(var sum=0,i=index-n+1;i<=index;i++)sum+=Math.pow(this._buf[i].resultA-stdData.resultMA,2);return Math.sqrt(sum/n)}return stdData.resultMA=resultA,0},StdExpr.prototype.reserve=function(rid,count){if(this._rid<rid)for(var c=count;c>0;c--)this._stdBuf.push({resultMA:NaN});StdExpr.__super.reserve.call(this,rid,count)},StdExpr.prototype.clear=function(){StdExpr.__super.clear.call(this),this._stdBuf=[]};var MaExpr=create_class(RangeExpr);MaExpr.prototype.__construct=function(a,b){MaExpr.__super.__construct.call(this,a,b)},MaExpr.prototype.calcResult=function(index,resultA){if(0==this._range)return NaN;var first=ExprEnv.get()._firstIndex;if(first<0)return resultA;if(index>first){var n=this._range;return n>=index+1-first?(n=index+1-first,this._buf[index-1].result*(1-1/n)+resultA/n):this._buf[index-1].result+(resultA-this._buf[index-n].resultA)/n}return resultA};var EmaExpr=create_class(RangeExpr);EmaExpr.prototype.__construct=function(a,b){EmaExpr.__super.__construct.call(this,a,b)},EmaExpr.prototype.initRange=function(){EmaExpr.__super.initRange.call(this),this._alpha=2/(this._range+1)},EmaExpr.prototype.calcResult=function(index,resultA){if(0==this._range)return NaN;var first=ExprEnv.get()._firstIndex;if(first<0)return resultA;if(index>first){var prev=this._buf[index-1];return this._alpha*(resultA-prev.result)+prev.result}return resultA};var ExpmemaExpr=create_class(EmaExpr);ExpmemaExpr.prototype.__construct=function(a,b){ExpmemaExpr.__super.__construct.call(this,a,b)},ExpmemaExpr.prototype.calcResult=function(index,resultA){var first=ExprEnv.get()._firstIndex;if(first<0)return resultA;if(index>first){var n=this._range,prev=this._buf[index-1];return n>=index+1-first?(n=index+1-first,prev.result*(1-1/n)+resultA/n):this._alpha*(resultA-prev.result)+prev.result}return resultA};var SmaExpr=create_class(RangeExpr);SmaExpr.prototype.__construct=function(a,b,c){SmaExpr.__super.__construct.call(this,a,b),this._exprC=c,this._mul},SmaExpr.prototype.initRange=function(){SmaExpr.__super.initRange.call(this),this._mul=this._exprC.execute(0)},SmaExpr.prototype.calcResult=function(index,resultA){if(0==this._range)return NaN;var first=ExprEnv.get()._firstIndex;if(first<0)return resultA;if(index>first){var n=this._range;return n>index+1-first&&(n=index+1-first),((n-1)*this._buf[index-1].result+resultA*this._mul)/n}return resultA};var SarExpr=create_class(OpABCDExpr);SarExpr.prototype.__construct=function(a,b,c,d){SarExpr.__super.__construct.call(this,a,b,c,d),this._buf=[],this._range=-1,this._min,this._step,this._max},SarExpr.prototype.execute=function(index){this._range<0&&(this._range=this._exprA.execute(0),this._min=this._exprB.execute(0)/100,this._step=this._exprC.execute(0)/100,this._max=this._exprD.execute(0)/100);var data=this._buf[index],exprEnv=ExprEnv.get(),first=exprEnv._firstIndex;if(first<0)data.longPos=!0,data.sar=exprEnv._ds.getDataAt(index).low,data.ep=exprEnv._ds.getDataAt(index).high,data.af=.02;else{var high=exprEnv._ds.getDataAt(index).high,low=exprEnv._ds.getDataAt(index).low,prev=this._buf[index-1];if(data.sar=prev.sar+prev.af*(prev.ep-prev.sar),prev.longPos){if(data.longPos=!0,high>prev.ep?(data.ep=high,data.af=Math.min(prev.af+this._step,this._max)):(data.ep=prev.ep,data.af=prev.af),data.sar>low){data.longPos=!1;var i=index-this._range+1;for(i=Math.max(i,first);i<index;i++){var h=exprEnv._ds.getDataAt(i).high;high<h&&(high=h)}data.sar=high,data.ep=low,data.af=.02}}else if(data.longPos=!1,low<prev.ep?(data.ep=low,data.af=Math.min(prev.af+this._step,this._max)):(data.ep=prev.ep,data.af=prev.af),data.sar<high){data.longPos=!0;var i=index-this._range+1;for(i=Math.max(i,first);i<index;i++){var l=exprEnv._ds.getDataAt(i).low;low>l&&(low=l)}data.sar=low,data.ep=high,data.af=.02}}return data.sar},SarExpr.prototype.reserve=function(rid,count){if(this._rid<rid)for(var c=count;c>0;c--)this._buf.push({longPos:!0,sar:NaN,ep:NaN,af:NaN});SarExpr.__super.reserve.call(this,rid,count)},SarExpr.prototype.clear=function(){SarExpr.__super.clear.call(this),this._range=-1};var Indicator=create_class();Indicator.prototype.__construct=function(){this._exprEnv=new ExprEnv,this._rid=0,this._params=[],this._assigns=[],this._outputs=[]},Indicator.prototype.addParameter=function(expr){this._params.push(expr)},Indicator.prototype.addAssign=function(expr){this._assigns.push(expr)},Indicator.prototype.addOutput=function(expr){this._outputs.push(expr)},Indicator.prototype.getParameterCount=function(){return this._params.length},Indicator.prototype.getParameterAt=function(index){return this._params[index]},Indicator.prototype.getOutputCount=function(){return this._outputs.length},Indicator.prototype.getOutputAt=function(index){return this._outputs[index]},Indicator.prototype.clear=function(){this._exprEnv.setFirstIndex(-1);var i,cnt;for(cnt=this._assigns.length,i=0;i<cnt;i++)this._assigns[i].clear();for(cnt=this._outputs.length,i=0;i<cnt;i++)this._outputs[i].clear()},Indicator.prototype.reserve=function(count){this._rid++;var i,cnt;for(cnt=this._assigns.length,i=0;i<cnt;i++)this._assigns[i].reserve(this._rid,count);for(cnt=this._outputs.length,i=0;i<cnt;i++)this._outputs[i].reserve(this._rid,count)},Indicator.prototype.execute=function(ds,index){if(!(index<0)){this._exprEnv.setDataSource(ds),ExprEnv.set(this._exprEnv);try{var i,cnt;for(cnt=this._assigns.length,i=0;i<cnt;i++)this._assigns[i].assign(index);for(cnt=this._outputs.length,i=0;i<cnt;i++)this._outputs[i].assign(index);this._exprEnv.getFirstIndex()<0&&this._exprEnv.setFirstIndex(index)}catch(e){if(this._exprEnv.getFirstIndex()>=0)throw alert(e),e}}},Indicator.prototype.getParameters=function(){var i,params=[],cnt=this._params.length;for(i=0;i<cnt;i++)params.push(this._params[i].getValue());return params},Indicator.prototype.setParameters=function(params){if(params instanceof Array&&params.length==this._params.length)for(var i in this._params)this._params[i].setValue(params[i])};var HLCIndicator=create_class(Indicator);HLCIndicator.prototype.__construct=function(){HLCIndicator.__super.__construct.call(this);var M1=new ParameterExpr("M1",2,1e3,60);this.addParameter(M1),this.addOutput(new OutputExpr("HIGH",new HighExpr,OutputStyle.None)),this.addOutput(new OutputExpr("LOW",new LowExpr,OutputStyle.None)),this.addOutput(new OutputExpr("CLOSE",new CloseExpr,OutputStyle.Line,Theme.Color.Indicator0)),this.addOutput(new RangeOutputExpr("MA",new MaExpr(new CloseExpr,M1),OutputStyle.Line,Theme.Color.Indicator1))},HLCIndicator.prototype.getName=function(){return"CLOSE"};var MAIndicator=create_class(Indicator);MAIndicator.prototype.__construct=function(){MAIndicator.__super.__construct.call(this);var M1=new ParameterExpr("M1",2,1e3,7),M2=new ParameterExpr("M2",2,1e3,30),M3=new ParameterExpr("M3",2,1e3,0),M4=new ParameterExpr("M4",2,1e3,0);this.addParameter(M1),this.addParameter(M2),this.addParameter(M3),this.addParameter(M4),this.addOutput(new RangeOutputExpr("MA",new MaExpr(new CloseExpr,M1))),this.addOutput(new RangeOutputExpr("MA",new MaExpr(new CloseExpr,M2))),this.addOutput(new RangeOutputExpr("MA",new MaExpr(new CloseExpr,M3))),this.addOutput(new RangeOutputExpr("MA",new MaExpr(new CloseExpr,M4)))},MAIndicator.prototype.getName=function(){return"MA"};var EMAIndicator=create_class(Indicator);EMAIndicator.prototype.__construct=function(){EMAIndicator.__super.__construct.call(this);var M1=new ParameterExpr("M1",2,1e3,7),M2=new ParameterExpr("M2",2,1e3,30),M3=new ParameterExpr("M3",2,1e3,0),M4=new ParameterExpr("M4",2,1e3,0);this.addParameter(M1),this.addParameter(M2),this.addParameter(M3),this.addParameter(M4),this.addOutput(new RangeOutputExpr("EMA",new EmaExpr(new CloseExpr,M1))),this.addOutput(new RangeOutputExpr("EMA",new EmaExpr(new CloseExpr,M2))),this.addOutput(new RangeOutputExpr("EMA",new EmaExpr(new CloseExpr,M3))),this.addOutput(new RangeOutputExpr("EMA",new EmaExpr(new CloseExpr,M4)))},EMAIndicator.prototype.getName=function(){return"EMA"};var VOLUMEIndicator=create_class(Indicator);VOLUMEIndicator.prototype.__construct=function(){VOLUMEIndicator.__super.__construct.call(this);var M1=new ParameterExpr("M1",2,500,5),M2=new ParameterExpr("M2",2,500,10);this.addParameter(M1),this.addParameter(M2);var VOLUME=new OutputExpr("VOLUME",new VolumeExpr,OutputStyle.VolumeStick,Theme.Color.Text4);this.addOutput(VOLUME),this.addOutput(new RangeOutputExpr("MA",new MaExpr(VOLUME,M1),OutputStyle.Line,Theme.Color.Indicator0)),this.addOutput(new RangeOutputExpr("MA",new MaExpr(VOLUME,M2),OutputStyle.Line,Theme.Color.Indicator1))},VOLUMEIndicator.prototype.getName=function(){return"VOLUME"};var MACDIndicator=create_class(Indicator);MACDIndicator.prototype.__construct=function(){MACDIndicator.__super.__construct.call(this);var SHORT=new ParameterExpr("SHORT",2,200,12),LONG=new ParameterExpr("LONG",2,200,26),MID=new ParameterExpr("MID",2,200,9);this.addParameter(SHORT),this.addParameter(LONG),this.addParameter(MID);var DIF=new OutputExpr("DIF",new SubExpr(new EmaExpr(new CloseExpr,SHORT),new EmaExpr(new CloseExpr,LONG)));this.addOutput(DIF);var DEA=new OutputExpr("DEA",new EmaExpr(DIF,MID));this.addOutput(DEA);var MACD=new OutputExpr("MACD",new MulExpr(new SubExpr(DIF,DEA),new ConstExpr(2)),OutputStyle.MACDStick);this.addOutput(MACD)},MACDIndicator.prototype.getName=function(){return"MACD"};var DMIIndicator=create_class(Indicator);DMIIndicator.prototype.__construct=function(){DMIIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,90,14),MM=new ParameterExpr("MM",2,60,6);this.addParameter(N),this.addParameter(MM);var MTR=new AssignExpr("MTR",new ExpmemaExpr(new MaxExpr(new MaxExpr(new SubExpr(new HighExpr,new LowExpr),new AbsExpr(new SubExpr(new HighExpr,new RefExpr(new CloseExpr,new ConstExpr(1))))),new AbsExpr(new SubExpr(new RefExpr(new CloseExpr,new ConstExpr(1)),new LowExpr))),N));this.addAssign(MTR);var HD=new AssignExpr("HD",new SubExpr(new HighExpr,new RefExpr(new HighExpr,new ConstExpr(1))));this.addAssign(HD);var LD=new AssignExpr("LD",new SubExpr(new RefExpr(new LowExpr,new ConstExpr(1)),new LowExpr));this.addAssign(LD);var DMP=new AssignExpr("DMP",new ExpmemaExpr(new IfExpr(new AndExpr(new GtExpr(HD,new ConstExpr(0)),new GtExpr(HD,LD)),HD,new ConstExpr(0)),N));this.addAssign(DMP);var DMM=new AssignExpr("DMM",new ExpmemaExpr(new IfExpr(new AndExpr(new GtExpr(LD,new ConstExpr(0)),new GtExpr(LD,HD)),LD,new ConstExpr(0)),N));this.addAssign(DMM);var PDI=new OutputExpr("PDI",new MulExpr(new DivExpr(DMP,MTR),new ConstExpr(100)));this.addOutput(PDI);var MDI=new OutputExpr("MDI",new MulExpr(new DivExpr(DMM,MTR),new ConstExpr(100)));this.addOutput(MDI);var ADX=new OutputExpr("ADX",new ExpmemaExpr(new MulExpr(new DivExpr(new AbsExpr(new SubExpr(MDI,PDI)),new AddExpr(MDI,PDI)),new ConstExpr(100)),MM));this.addOutput(ADX);var ADXR=new OutputExpr("ADXR",new ExpmemaExpr(ADX,MM));this.addOutput(ADXR)},DMIIndicator.prototype.getName=function(){return"DMI"};var DMAIndicator=create_class(Indicator);DMAIndicator.prototype.__construct=function(){DMAIndicator.__super.__construct.call(this);var N1=new ParameterExpr("N1",2,60,10),N2=new ParameterExpr("N2",2,250,50),M=new ParameterExpr("M",2,100,10);this.addParameter(N1),this.addParameter(N2),this.addParameter(M);var DIF=new OutputExpr("DIF",new SubExpr(new MaExpr(new CloseExpr,N1),new MaExpr(new CloseExpr,N2)));this.addOutput(DIF);var DIFMA=new OutputExpr("DIFMA",new MaExpr(DIF,M));this.addOutput(DIFMA)},DMAIndicator.prototype.getName=function(){return"DMA"};var TRIXIndicator=create_class(Indicator);TRIXIndicator.prototype.__construct=function(){TRIXIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,100,12),M=new ParameterExpr("M",2,100,9);this.addParameter(N),this.addParameter(M);var MTR=new AssignExpr("MTR",new EmaExpr(new EmaExpr(new EmaExpr(new CloseExpr,N),N),N));this.addAssign(MTR);var TRIX=new OutputExpr("TRIX",new MulExpr(new DivExpr(new SubExpr(MTR,new RefExpr(MTR,new ConstExpr(1))),new RefExpr(MTR,new ConstExpr(1))),new ConstExpr(100)));this.addOutput(TRIX);var MATRIX=new OutputExpr("MATRIX",new MaExpr(TRIX,M));this.addOutput(MATRIX)},TRIXIndicator.prototype.getName=function(){return"TRIX"};var BRARIndicator=create_class(Indicator);BRARIndicator.prototype.__construct=function(){BRARIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,120,26);this.addParameter(N);var REF_CLOSE_1=new AssignExpr("REF_CLOSE_1",new RefExpr(new CloseExpr,new ConstExpr(1)));this.addAssign(REF_CLOSE_1);var BR=new OutputExpr("BR",new MulExpr(new DivExpr(new SumExpr(new MaxExpr(new ConstExpr(0),new SubExpr(new HighExpr,REF_CLOSE_1)),N),new SumExpr(new MaxExpr(new ConstExpr(0),new SubExpr(REF_CLOSE_1,new LowExpr)),N)),new ConstExpr(100)));this.addOutput(BR);var AR=new OutputExpr("AR",new MulExpr(new DivExpr(new SumExpr(new SubExpr(new HighExpr,new OpenExpr),N),new SumExpr(new SubExpr(new OpenExpr,new LowExpr),N)),new ConstExpr(100)));this.addOutput(AR)},BRARIndicator.prototype.getName=function(){return"BRAR"};var VRIndicator=create_class(Indicator);VRIndicator.prototype.__construct=function(){VRIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,100,26),M=new ParameterExpr("M",2,100,6);this.addParameter(N),this.addParameter(M);var REF_CLOSE_1=new AssignExpr("REF_CLOSE_1",new RefExpr(new CloseExpr,new ConstExpr(1)));this.addAssign(REF_CLOSE_1);var TH=new AssignExpr("TH",new SumExpr(new IfExpr(new GtExpr(new CloseExpr,REF_CLOSE_1),new VolumeExpr,new ConstExpr(0)),N));this.addAssign(TH);var TL=new AssignExpr("TL",new SumExpr(new IfExpr(new LtExpr(new CloseExpr,REF_CLOSE_1),new VolumeExpr,new ConstExpr(0)),N));this.addAssign(TL);var TQ=new AssignExpr("TQ",new SumExpr(new IfExpr(new EqExpr(new CloseExpr,REF_CLOSE_1),new VolumeExpr,new ConstExpr(0)),N));this.addAssign(TQ);var VR=new OutputExpr("VR",new MulExpr(new DivExpr(new AddExpr(new MulExpr(TH,new ConstExpr(2)),TQ),new AddExpr(new MulExpr(TL,new ConstExpr(2)),TQ)),new ConstExpr(100)));this.addOutput(VR);var MAVR=new OutputExpr("MAVR",new MaExpr(VR,M));this.addOutput(MAVR)},VRIndicator.prototype.getName=function(){return"VR"};var OBVIndicator=create_class(Indicator);OBVIndicator.prototype.__construct=function(){OBVIndicator.__super.__construct.call(this);var M=new ParameterExpr("M",2,100,30);this.addParameter(M);var REF_CLOSE_1=new AssignExpr("REF_CLOSE_1",new RefExpr(new CloseExpr,new ConstExpr(1)));this.addAssign(REF_CLOSE_1);var VA=new AssignExpr("VA",new IfExpr(new GtExpr(new CloseExpr,REF_CLOSE_1),new VolumeExpr,new NegExpr(new VolumeExpr)));this.addAssign(VA);var OBV=new OutputExpr("OBV",new SumExpr(new IfExpr(new EqExpr(new CloseExpr,REF_CLOSE_1),new ConstExpr(0),VA),new ConstExpr(0)));this.addOutput(OBV);var MAOBV=new OutputExpr("MAOBV",new MaExpr(OBV,M));this.addOutput(MAOBV)},OBVIndicator.prototype.getName=function(){return"OBV"};var EMVIndicator=create_class(Indicator);EMVIndicator.prototype.__construct=function(){EMVIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,90,14),M=new ParameterExpr("M",2,60,9);this.addParameter(N),this.addParameter(M);var VOLUME=new AssignExpr("VOLUME",new DivExpr(new MaExpr(new VolumeExpr,N),new VolumeExpr));this.addAssign(VOLUME);var MID=new AssignExpr("MID",new MulExpr(new DivExpr(new SubExpr(new AddExpr(new HighExpr,new LowExpr),new RefExpr(new AddExpr(new HighExpr,new LowExpr),new ConstExpr(1))),new AddExpr(new HighExpr,new LowExpr)),new ConstExpr(100)));this.addAssign(MID);var EMV=new OutputExpr("EMV",new MaExpr(new DivExpr(new MulExpr(MID,new MulExpr(VOLUME,new SubExpr(new HighExpr,new LowExpr))),new MaExpr(new SubExpr(new HighExpr,new LowExpr),N)),N));this.addOutput(EMV);var MAEMV=new OutputExpr("MAEMV",new MaExpr(EMV,M));this.addOutput(MAEMV)},EMVIndicator.prototype.getName=function(){return"EMV"};var RSIIndicator=create_class(Indicator);RSIIndicator.prototype.__construct=function(){RSIIndicator.__super.__construct.call(this);var N1=new ParameterExpr("N1",2,120,6),N2=new ParameterExpr("N2",2,250,12),N3=new ParameterExpr("N3",2,500,24);this.addParameter(N1),this.addParameter(N2),this.addParameter(N3);var LC=new AssignExpr("LC",new RefExpr(new CloseExpr,new ConstExpr(1)));this.addAssign(LC);var CLOSE_LC=new AssignExpr("CLOSE_LC",new SubExpr(new CloseExpr,LC));this.addAssign(CLOSE_LC),this.addOutput(new OutputExpr("RSI1",new MulExpr(new DivExpr(new SmaExpr(new MaxExpr(CLOSE_LC,new ConstExpr(0)),N1,new ConstExpr(1)),new SmaExpr(new AbsExpr(CLOSE_LC),N1,new ConstExpr(1))),new ConstExpr(100)))),this.addOutput(new OutputExpr("RSI2",new MulExpr(new DivExpr(new SmaExpr(new MaxExpr(CLOSE_LC,new ConstExpr(0)),N2,new ConstExpr(1)),new SmaExpr(new AbsExpr(CLOSE_LC),N2,new ConstExpr(1))),new ConstExpr(100)))),this.addOutput(new OutputExpr("RSI3",new MulExpr(new DivExpr(new SmaExpr(new MaxExpr(CLOSE_LC,new ConstExpr(0)),N3,new ConstExpr(1)),new SmaExpr(new AbsExpr(CLOSE_LC),N3,new ConstExpr(1))),new ConstExpr(100))))},RSIIndicator.prototype.getName=function(){return"RSI"};var WRIndicator=create_class(Indicator);WRIndicator.prototype.__construct=function(){WRIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,100,10),N1=new ParameterExpr("N1",2,100,6);this.addParameter(N),this.addParameter(N1);var HHV=new AssignExpr("HHV",new HhvExpr(new HighExpr,N));this.addAssign(HHV);var HHV1=new AssignExpr("HHV1",new HhvExpr(new HighExpr,N1));this.addAssign(HHV1);var LLV=new AssignExpr("LLV",new LlvExpr(new LowExpr,N));this.addAssign(LLV);var LLV1=new AssignExpr("LLV1",new LlvExpr(new LowExpr,N1));this.addAssign(LLV1);var WR1=new OutputExpr("WR1",new MulExpr(new DivExpr(new SubExpr(HHV,new CloseExpr),new SubExpr(HHV,LLV)),new ConstExpr(100)));this.addOutput(WR1);var WR2=new OutputExpr("WR2",new MulExpr(new DivExpr(new SubExpr(HHV1,new CloseExpr),new SubExpr(HHV1,LLV1)),new ConstExpr(100)));this.addOutput(WR2)},WRIndicator.prototype.getName=function(){return"WR"};var SARIndicator=create_class(Indicator);SARIndicator.prototype.__construct=function(){SARIndicator.__super.__construct.call(this);var N=new ConstExpr(4),MIN=new ConstExpr(2),STEP=new ConstExpr(2),MAX=new ConstExpr(20);this.addOutput(new OutputExpr("SAR",new SarExpr(N,MIN,STEP,MAX),OutputStyle.SARPoint))},SARIndicator.prototype.getName=function(){return"SAR"};var KDJIndicator=create_class(Indicator);KDJIndicator.prototype.__construct=function(){KDJIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,90,9),M1=new ParameterExpr("M1",2,30,3),M2=new ParameterExpr("M2",2,30,3);this.addParameter(N),this.addParameter(M1),this.addParameter(M2);var HHV=new AssignExpr("HHV",new HhvExpr(new HighExpr,N));this.addAssign(HHV);var LLV=new AssignExpr("LLV",new LlvExpr(new LowExpr,N));this.addAssign(LLV);var RSV=new AssignExpr("RSV",new MulExpr(new DivExpr(new SubExpr(new CloseExpr,LLV),new SubExpr(HHV,LLV)),new ConstExpr(100)));this.addAssign(RSV);var K=new OutputExpr("K",new SmaExpr(RSV,M1,new ConstExpr(1)));this.addOutput(K);var D=new OutputExpr("D",new SmaExpr(K,M2,new ConstExpr(1)));this.addOutput(D);var J=new OutputExpr("J",new SubExpr(new MulExpr(K,new ConstExpr(3)),new MulExpr(D,new ConstExpr(2))));this.addOutput(J)},KDJIndicator.prototype.getName=function(){return"KDJ"};var ROCIndicator=create_class(Indicator);ROCIndicator.prototype.__construct=function(){ROCIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,120,12),M=new ParameterExpr("M",2,60,6);this.addParameter(N),this.addParameter(M);var REF_CLOSE_N=new AssignExpr("REF_CLOSE_N",new RefExpr(new CloseExpr,N));this.addAssign(REF_CLOSE_N);var ROC=new OutputExpr("ROC",new MulExpr(new DivExpr(new SubExpr(new CloseExpr,REF_CLOSE_N),REF_CLOSE_N),new ConstExpr(100)));this.addOutput(ROC);var MAROC=new OutputExpr("MAROC",new MaExpr(ROC,M));this.addOutput(MAROC)},ROCIndicator.prototype.getName=function(){return"ROC"};var MTMIndicator=create_class(Indicator);MTMIndicator.prototype.__construct=function(){MTMIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,120,12),M=new ParameterExpr("M",2,60,6);this.addParameter(N),this.addParameter(M);var MTM=new OutputExpr("MTM",new SubExpr(new CloseExpr,new RefExpr(new CloseExpr,N)));this.addOutput(MTM);var MTMMA=new OutputExpr("MTMMA",new MaExpr(MTM,M));this.addOutput(MTMMA)},MTMIndicator.prototype.getName=function(){return"MTM"};var BOLLIndicator=create_class(Indicator);BOLLIndicator.prototype.__construct=function(){BOLLIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,120,20);this.addParameter(N);var STD_CLOSE_N=new AssignExpr("STD_CLOSE_N",new StdExpr(new CloseExpr,N));this.addAssign(STD_CLOSE_N);var BOLL=new OutputExpr("BOLL",new MaExpr(new CloseExpr,N));this.addOutput(BOLL);var UB=new OutputExpr("UB",new AddExpr(BOLL,new MulExpr(new ConstExpr(2),STD_CLOSE_N)));this.addOutput(UB);var LB=new OutputExpr("LB",new SubExpr(BOLL,new MulExpr(new ConstExpr(2),STD_CLOSE_N)));this.addOutput(LB)},BOLLIndicator.prototype.getName=function(){return"BOLL"};var PSYIndicator=create_class(Indicator);PSYIndicator.prototype.__construct=function(){PSYIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",2,100,12),M=new ParameterExpr("M",2,100,6);this.addParameter(N),this.addParameter(M);var PSY=new OutputExpr("PSY",new MulExpr(new DivExpr(new CountExpr(new GtExpr(new CloseExpr,new RefExpr(new CloseExpr,new ConstExpr(1))),N),N),new ConstExpr(100)));this.addOutput(PSY);var PSYMA=new OutputExpr("PSYMA",new MaExpr(PSY,M));this.addOutput(PSYMA)},PSYIndicator.prototype.getName=function(){return"PSY"};var STOCHRSIIndicator=create_class(Indicator);STOCHRSIIndicator.prototype.__construct=function(){STOCHRSIIndicator.__super.__construct.call(this);var N=new ParameterExpr("N",3,100,14),M=new ParameterExpr("M",3,100,14),P1=new ParameterExpr("P1",2,50,3),P2=new ParameterExpr("P2",2,50,3);this.addParameter(N),this.addParameter(M),this.addParameter(P1),this.addParameter(P2);var LC=new AssignExpr("LC",new RefExpr(new CloseExpr,new ConstExpr(1)));this.addAssign(LC);var CLOSE_LC=new AssignExpr("CLOSE_LC",new SubExpr(new CloseExpr,LC));this.addAssign(CLOSE_LC);var RSI=new AssignExpr("RSI",new MulExpr(new DivExpr(new SmaExpr(new MaxExpr(CLOSE_LC,new ConstExpr(0)),N,new ConstExpr(1)),new SmaExpr(new AbsExpr(CLOSE_LC),N,new ConstExpr(1))),new ConstExpr(100)));this.addAssign(RSI);var STOCHRSI=new OutputExpr("STOCHRSI",new MulExpr(new DivExpr(new MaExpr(new SubExpr(RSI,new LlvExpr(RSI,M)),P1),new MaExpr(new SubExpr(new HhvExpr(RSI,M),new LlvExpr(RSI,M)),P1)),new ConstExpr(100)));this.addOutput(STOCHRSI),this.addOutput(new RangeOutputExpr("MA",new MaExpr(STOCHRSI,P2)))},STOCHRSIIndicator.prototype.getName=function(){return"StochRSI"};var Pushing={State:{Uninitial:0,Disable:1,Enable:2},state:0,marketFrom:"",type:"",moneyType:"",coinVol:"",time:"",Response:function(marketFrom,type,coinVol,data){if(Pushing.state==Pushing.State.Enable&&Pushing.marketFrom==marketFrom&&Pushing.type==type&&Pushing.coinVol==coinVol){if(GLOBAL_VAR.KLineData=data,1==ChartManager.getInstance().getChart()._money_type){var rate=ChartManager.getInstance().getChart()._usd_cny_rate;for(var i in GLOBAL_VAR.KLineData){var e=GLOBAL_VAR.KLineData[i];e[1]=parseFloat((e[1]*rate).toFixed(GLOBAL_VAR.digits)),e[2]=parseFloat((e[2]*rate).toFixed(GLOBAL_VAR.digits)),e[3]=parseFloat((e[3]*rate).toFixed(GLOBAL_VAR.digits)),e[4]=parseFloat((e[4]*rate).toFixed(GLOBAL_VAR.digits))}}try{if(!GLOBAL_VAR.chartMgr.updateData("frame0.k0",GLOBAL_VAR.KLineData))return Pushing.Switch(),void ChartManager.getInstance().redraw("All",!0)}catch(_){return Pushing.Switch(),void ChartManager.getInstance().redraw("All",!0)}clear_refresh_counter(),ChartManager.getInstance().redraw("All",!0)}},Start:function(callback){Pushing.state=Pushing.State.Enable,Pushing.PushFrom=callback,ChartManager.getInstance().getChart().updateDataAndDisplay2()},Stop:function(){Pushing.state=Pushing.State.Disable,ChartManager.getInstance().getChart().updateDataAndDisplay2()},Switch:function(){if(Pushing.state!=Pushing.State.Uninitial)if(Pushing.state==Pushing.State.Enable){var chart=ChartManager.getInstance().getChart();Pushing.marketFrom=chart._market_from,Pushing.type=chart._time,Pushing.moneyType=chart._money_type,Pushing.coinVol=chart._contract_unit,GLOBAL_VAR.mark_from=Pushing.marketFrom,GLOBAL_VAR.time_type=Pushing.type;var marketString="";marketString="0"==Pushing.marketFrom?"btc_spot":"3"==Pushing.marketFrom?"ltc_spot":"36"==Pushing.marketFrom?"spot_coin":"17"==Pushing.marketFrom?"btc_index":"18"==Pushing.marketFrom?"ltc_index":Chart.PushNameVar[Pushing.marketFrom];var now="OKCoin."+chart._market_from+"."+chart._time+"."+chart._money_type+"."+chart._contract_unit,org=ChartManager.getInstance().getDataSource("frame0.k0").getName();org!=now&&(chart.setTitle(),ChartManager.getInstance().setCurrentDataSource("frame0.k0",now),ChartManager.getInstance().setNormalMode());var f=GLOBAL_VAR.chartMgr.getDataSource("frame0.k0").getLastDate();if(Pushing.time=f,f!=-1){if(!Pushing.PushFrom)return;var isLine="line"==$("#chart_toolbar_periods_vert ul a.selected").parent().attr("name");Pushing.PushFrom(marketString,Pushing.marketFrom,Pushing.type,Pushing.coinVol,f,isLine),org!=now&&clear_refresh_counter()}else ChartManager.getInstance().getChart().updateDataAndDisplay2()}else ChartManager.getInstance().getChart().updateDataAndDisplay2()}},Chart=create_class();Chart._future_btc_market_num=new Array("0","-1","-1","-1","-1"),Chart._future_ltc_market_num=new Array("1","-1","-1","-1","-1"),Chart.PushNameVar={},Chart.PushNameCon=["spot","this_week","next_week","month","quarter"],Chart.strMarket={"zh-cn":{"01":"当周 BTC ","02":"次周 BTC ","03":"全月 BTC ","04":"季度 BTC ",11:"当周 LTC ",12:"次周 LTC ",13:"全月 LTC ",14:"季度 LTC "},"en-us":{"01":"BTC This Week ","02":"BTC Next Week ","03":"BTC Month ","04":"BTC Quarter ",11:"LTC This Week ",12:"LTC Next Week ",13:"LTC Month ",14:"LTC Quarter "},"zh-tw":{"01":"當周 BTC ","02":"次周 BTC ","03":"全月 BTC ","04":"季度 BTC ",11:"當周 LTC ",12:"次周 LTC ",13:"全月 LTC ",14:"季度 LTC "}},Chart.strPeriod={"zh-cn":{line:"(分时)",0:"(1分钟)",1:"(5分钟)",2:"(15分钟)",9:"(30分钟)",10:"(1小时)",3:"(日线)",4:"(周线)",7:"(3分钟)",11:"(2小时)",12:"(4小时)",13:"(6小时)",14:"(12小时)",15:"(3天)"},"en-us":{line:"(Line)",0:"(1m)",1:"(5m)",2:"(15m)",9:"(30m)",10:"(1h)",3:"(1d)",4:"(1w)",7:"(3m)",11:"(2h)",12:"(4h)",13:"(6h)",14:"(12h)",15:"(3d)"},"zh-tw":{line:"(分時)",0:"(1分钟)",1:"(5分钟)",2:"(15分钟)",9:"(30分钟)",10:"(1小時)",3:"(日线)",4:"(周线)",7:"(3分钟)",11:"(2小時)",12:"(4小時)",13:"(6小時)",14:"(12小時)",15:"(3天)"}},Chart.prototype.__construct=function(){this._data=null,this._charStyle="CandleStick",this._depthData={array:null,asks_count:0,bids_count:0,asks_si:0,asks_ei:0,bids_si:0,bids_ei:0},this._time="2",this._market_from="13",this._usd_cny_rate=1,this._money_type=0,this._contract_unit=1,this.strIsLine=!1,this.strCurrentMarket=20141017001,this.strCurrentMarketType=1;
},Chart.prototype.setTitle=function(){var lang=ChartManager.getInstance().getLanguage(),str="OKCoin ";if("0"==this._market_from)str+="BTC";else if("3"==this._market_from)str+="LTC";else{var _1=getCoinType(this.strCurrentMarket).toString()+this.strCurrentMarketType.toString();str+=Chart.strMarket[lang][_1],str+=this.strCurrentMarket.toString().slice(4,8)}str+=" ",str+=this.strIsLine?Chart.strPeriod[lang].line:Chart.strPeriod[lang][this._time],ChartManager.getInstance().setTitle("frame0.k0",str)},Chart.prototype.setCurrentList=function(){},Chart.prototype.setKlineIndex=function(type){this._market_from=type,this.updateDataAndDisplay()},Chart.prototype.setCurrentCoin=function(coin){this._market_from=coin.toString(),this.updateDataAndDisplay()},Chart.prototype.setFutureList=function(content){var btc=$("#chart_symbols_btc").find("span"),btc_li=$("#chart_symbols_btc").find("li");this.btc_obj={};var ltc=$("#chart_symbols_ltc").find("span"),ltc_li=$("#chart_symbols_ltc").find("li");this.ltc_obj={};for(var i=1;i<=4;i++)this.btc_obj[i.toString()]={},this.btc_obj[i.toString()].id=0,this.btc_obj[i.toString()].type=0,this.btc_obj[i.toString()].text=$(btc[2*i-1]),this.btc_obj[i.toString()].obj=$(btc_li[i-1]),this.btc_obj[i.toString()].obj.css("display","none"),this.btc_obj[i.toString()].obj.attr("name","0"),this.ltc_obj[i.toString()]={},this.ltc_obj[i.toString()].id=0,this.ltc_obj[i.toString()].type=0,this.ltc_obj[i.toString()].text=$(ltc[2*i-1]),this.ltc_obj[i.toString()].obj=$(ltc_li[i-1]),this.ltc_obj[i.toString()].obj.css("display","none"),this.ltc_obj[i.toString()].obj.attr("name","0");for(var i=0;i<content.length;i++){var id=content[i].contractID,type=content[i].type;0==getCoinType(id)?(this.btc_obj[type].id=id,this.btc_obj[type].type=type,this.btc_obj[type].text.html(id.toString().slice(4,8)),this.btc_obj[type].obj.attr("name",id.toString()),this.btc_obj[type].obj.css("display","block"),Chart._future_btc_market_num[type]=id.toString().slice(id.toString().length-2)):1==getCoinType(id)&&(this.ltc_obj[type].id=id,this.ltc_obj[type].type=type,this.ltc_obj[type].text.html(id.toString().slice(4,8)),this.ltc_obj[type].obj.attr("name",id.toString()),this.ltc_obj[type].obj.css("display","block"),Chart._future_ltc_market_num[type]=id.toString().slice(id.toString().length-2))}for(var i=0;i<Chart._future_btc_market_num.length;i++){var tmp=Chart._future_btc_market_num[i].toString();"-1"!=tmp&&(Chart.PushNameVar[tmp]="btc_"+Chart.PushNameCon[i])}for(var i=0;i<Chart._future_ltc_market_num.length;i++){var tmp=Chart._future_ltc_market_num[i].toString();"-1"!=tmp&&(Chart.PushNameVar[tmp]="ltc_"+Chart.PushNameCon[i])}},Chart.prototype.updateDataAndDisplay=function(){Pushing.Switch()},Chart.prototype.updateDataAndDisplay2=function(){GLOBAL_VAR.mark_from=this._market_from,GLOBAL_VAR.time_type=this._time,GLOBAL_VAR.limit="1000",this.setTitle(),ChartManager.getInstance().setCurrentDataSource("frame0.k0","OKCoin."+this._market_from+"."+this._time+"."+this._money_type+"."+this._contract_unit),ChartManager.getInstance().setNormalMode();var f=GLOBAL_VAR.chartMgr.getDataSource("frame0.k0").getLastDate();f==-1?(GLOBAL_VAR.requestParam=setHttpRequestParam(GLOBAL_VAR.mark_from,GLOBAL_VAR.time_type,"1000",null),RequestData(!0)):(GLOBAL_VAR.requestParam=setHttpRequestParam(GLOBAL_VAR.mark_from,GLOBAL_VAR.time_type,null,f.toString()),RequestData()),ChartManager.getInstance().redraw("All",!1)},Chart.prototype.setCurrentFutureNoRaise=function(content){$("#chart_dropdown_symbols li a").removeClass("selected");var _alias=content,_type=0,btc_li=$("#chart_symbols_btc").find("li"),ltc_li=$("#chart_symbols_ltc").find("li");btc_li.each(function(){var str=$(this).attr("name");_alias.toString()==str&&($("#chart_dropdown_symbols .chart_dropdown_t").html($(this).html()),$(this).find("a").addClass("selected"))}),ltc_li.each(function(){var str=$(this).attr("name");_alias.toString()==str&&($("#chart_dropdown_symbols .chart_dropdown_t").html($(this).html()),$(this).find("a").addClass("selected"))});for(var i in this.btc_obj)if(this.btc_obj[i].id==_alias){_type=this.ltc_obj[i].type,this._market_from=Chart._future_btc_market_num[this.btc_obj[i].type],this.strCurrentMarket=_alias,this.strCurrentMarketType=this.btc_obj[i].type,this.setTitle();break}for(var i in this.ltc_obj)if(this.ltc_obj[i].id==_alias){_type=this.ltc_obj[i].type,this._market_from=Chart._future_ltc_market_num[this.ltc_obj[i].type],this.strCurrentMarket=_alias,this.strCurrentMarketType=this.ltc_obj[i].type,this.setTitle();break}this.updateDataAndDisplay()},Chart.prototype.setCurrentFuture=function(content){$("#chart_dropdown_symbols li a").removeClass("selected");var _alias=content,_type=0,btc_li=$("#chart_symbols_btc").find("li"),ltc_li=$("#chart_symbols_ltc").find("li");btc_li.each(function(){var str=$(this).attr("name");_alias.toString()==str&&($("#chart_dropdown_symbols .chart_dropdown_t").html($(this).html()),$(this).find("a").addClass("selected"))}),ltc_li.each(function(){var str=$(this).attr("name");_alias.toString()==str&&($("#chart_dropdown_symbols .chart_dropdown_t").html($(this).html()),$(this).find("a").addClass("selected"))});for(var i in this.btc_obj)if(this.btc_obj[i].id==_alias){_type=this.ltc_obj[i].type,this._market_from=Chart._future_btc_market_num[this.btc_obj[i].type],this.strCurrentMarket=_alias,this.strCurrentMarketType=this.btc_obj[i].type,this.setTitle();break}for(var i in this.ltc_obj)if(this.ltc_obj[i].id==_alias){_type=this.ltc_obj[i].type,this._market_from=Chart._future_ltc_market_num[this.ltc_obj[i].type],this.strCurrentMarket=_alias,this.strCurrentMarketType=this.ltc_obj[i].type,this.setTitle();break}var a={};a.command="set current future",a.content=_alias,$("#chart_output_interface_text").val(JSON.stringify(a)),$("#chart_output_interface_submit").submit(),window._current_future_change.raise(_alias,_type),this.updateDataAndDisplay()},Chart.prototype.setCurrentContractUnit=function(contractUnit){if("btc"==contractUnit){if(0==this._contract_unit)return;this._contract_unit=0}else if("piece"==contractUnit){if(1==this._contract_unit)return;this._contract_unit=1}this.updateDataAndDisplay()},Chart.prototype.setCurrentMoneyType=function(moneyType){if("usd"==moneyType){if(0==this._money_type)return;this._money_type=0}else if("cny"==moneyType){if(1==this._money_type)return;this._money_type=1}this.updateDataAndDisplay()},Chart.prototype.setCurrentPeriod=function(period){this._time=GLOBAL_VAR.periodMap[period],this.updateDataAndDisplay()},Chart.prototype.updateDataSource=function(data){this._data=data,ChartManager.getInstance().updateData("frame0.k0",this._data)},Chart.prototype.updateDepth=function(array){if(null!=array&&array.asks&&array.bids){var _data=this._depthData;_data.array=[];for(var i=0;i<array.asks.length;i++){var data={};data.rate=array.asks[i][0],data.amount=array.asks[i][1],_data.array.push(data)}for(var i=0;i<array.bids.length;i++){var data={};data.rate=array.bids[i][0],data.amount=array.bids[i][1],_data.array.push(data)}_data.asks_count=array.asks.length,_data.bids_count=array.bids.length,_data.asks_si=_data.asks_count-1,_data.asks_ei=0,_data.bids_si=_data.asks_count,_data.bids_ei=_data.asks_count+_data.bids_count-1;for(var i=_data.asks_si;i>=_data.asks_ei;i--)i==_data.asks_si?_data.array[i].amounts=_data.array[i].amount:_data.array[i].amounts=_data.array[i+1].amounts+_data.array[i].amount;for(var i=_data.bids_si;i<=_data.bids_ei;i++)i==_data.bids_si?_data.array[i].amounts=_data.array[i].amount:_data.array[i].amounts=_data.array[i-1].amounts+_data.array[i].amount;ChartManager.getInstance().redraw("All",!1)}},Chart.prototype.setMainIndicator=function(indicName){this._mainIndicator=indicName,"NONE"==indicName?ChartManager.getInstance().removeMainIndicator("frame0.k0"):ChartManager.getInstance().setMainIndicator("frame0.k0",indicName),ChartManager.getInstance().redraw("All",!0)},Chart.prototype.setIndicator=function(index,indicName){if("NONE"==indicName){var index=2;0==Template.displayVolume&&(index=1);var areaName=ChartManager.getInstance().getIndicatorAreaName("frame0.k0",index);""!=areaName&&ChartManager.getInstance().removeIndicator(areaName)}else{var index=2;0==Template.displayVolume&&(index=1);var areaName=ChartManager.getInstance().getIndicatorAreaName("frame0.k0",index);""==areaName?Template.createIndicatorChartComps("frame0.k0",indicName):ChartManager.getInstance().setIndicator(areaName,indicName)}ChartManager.getInstance().redraw("All",!0)},Chart.prototype.addIndicator=function(indicName){ChartManager.getInstance().addIndicator(indicName),ChartManager.getInstance().redraw("All",!0)},Chart.prototype.removeIndicator=function(indicName){var areaName=ChartManager.getInstance().getIndicatorAreaName(2);ChartManager.getInstance().removeIndicator(areaName),ChartManager.getInstance().redraw("All",!0)};var CName=create_class();CName.prototype.__construct=function(name){if(this._names=[],this._comps=[],name instanceof CName)this._names=name._names,this._comps=name._comps;else{var comps=name.split("."),dotNum=comps.length-1;if(dotNum>0){this._comps=comps,this._names.push(comps[0]);for(var i=1;i<=dotNum;i++)this._names.push(this._names[i-1]+"."+comps[i])}else this._comps.push(name),this._names.push(name)}},CName.prototype.getCompAt=function(index){return index>=0&&index<this._comps.length?this._comps[index]:""},CName.prototype.getName=function(index){if(index<0){if(this._names.length>0)return this._names[this._names.length-1]}else if(index<this._names.length)return this._names[index];return""};var NamedObject=create_class();NamedObject.prototype.__construct=function(name){this._name=name,this._nameObj=new CName(name)},NamedObject.prototype.getFrameName=function(){return this._nameObj.getName(0)},NamedObject.prototype.getDataSourceName=function(){return this._nameObj.getName(1)},NamedObject.prototype.getAreaName=function(){return this._nameObj.getName(2)},NamedObject.prototype.getName=function(){return this._nameObj.getName(-1)},NamedObject.prototype.getNameObject=function(){return this._nameObj};var ChartArea=create_class(NamedObject);ChartArea.prototype.__construct=function(name){ChartArea.__super.__construct.call(this,name),this._left=0,this._top=0,this._right=0,this._bottom=0,this._changed=!1,this._highlighted=!1,this._pressed=!1,this._selected=!1,this.Measuring=new MEvent},ChartArea.DockStyle={Left:0,Top:1,Right:2,Bottom:3,Fill:4},ChartArea.prototype.getDockStyle=function(){return this._dockStyle},ChartArea.prototype.setDockStyle=function(dockStyle){this._dockStyle=dockStyle},ChartArea.prototype.getLeft=function(){return this._left},ChartArea.prototype.getTop=function(){return this._top},ChartArea.prototype.setTop=function(v){this._top!=v&&(this._top=v,this._changed=!0)},ChartArea.prototype.getRight=function(){return this._right},ChartArea.prototype.getBottom=function(){return this._bottom},ChartArea.prototype.setBottom=function(v){this._bottom!=v&&(this._bottom=v,this._changed=!0)},ChartArea.prototype.getCenter=function(){return this._left+this._right>>1},ChartArea.prototype.getMiddle=function(){return this._top+this._bottom>>1},ChartArea.prototype.getWidth=function(){return this._right-this._left},ChartArea.prototype.getHeight=function(){return this._bottom-this._top},ChartArea.prototype.getRect=function(){return{X:this._left,Y:this._top,Width:this._right-this._left,Height:this._bottom-this._top}},ChartArea.prototype.contains=function(x,y){return x>=this._left&&x<this._right&&y>=this._top&&y<this._bottom?[this]:null},ChartArea.prototype.getMeasuredWidth=function(){return this._measuredWidth},ChartArea.prototype.getMeasuredHeight=function(){return this._measuredHeight},ChartArea.prototype.setMeasuredDimension=function(width,height){this._measuredWidth=width,this._measuredHeight=height},ChartArea.prototype.measure=function(context,width,height){this._measuredWidth=0,this._measuredHeight=0,this.Measuring.raise(this,{Width:width,Height:height}),0==this._measuredWidth&&0==this._measuredHeight&&this.setMeasuredDimension(width,height)},ChartArea.prototype.layout=function(left,top,right,bottom,forceChange){left<<=0,this._left!=left&&(this._left=left,this._changed=!0),top<<=0,this._top!=top&&(this._top=top,this._changed=!0),right<<=0,this._right!=right&&(this._right=right,this._changed=!0),bottom<<=0,this._bottom!=bottom&&(this._bottom=bottom,this._changed=!0),forceChange&&(this._changed=!0)},ChartArea.prototype.isChanged=function(){return this._changed},ChartArea.prototype.setChanged=function(v){this._changed=v},ChartArea.prototype.isHighlighted=function(){return this._highlighted},ChartArea.prototype.getHighlightedArea=function(){return this._highlighted?this:null},ChartArea.prototype.highlight=function(area){return this._highlighted=this==area,this._highlighted?this:null},ChartArea.prototype.isPressed=function(){return this._pressed},ChartArea.prototype.setPressed=function(v){this._pressed=v},ChartArea.prototype.isSelected=function(){return this._selected},ChartArea.prototype.getSelectedArea=function(){return this._selected?this:null},ChartArea.prototype.select=function(area){return this._selected=this==area,this._selected?this:null},ChartArea.prototype.onMouseMove=function(x,y){return null},ChartArea.prototype.onMouseLeave=function(x,y){},ChartArea.prototype.onMouseDown=function(x,y){return null},ChartArea.prototype.onMouseUp=function(x,y){return null};var MainArea=create_class(ChartArea);MainArea.prototype.__construct=function(name){MainArea.__super.__construct.call(this,name),this._dragStarted=!1,this._oldX=0,this._oldY=0,this._passMoveEventToToolManager=!0},MainArea.prototype.onMouseMove=function(x,y){var mgr=ChartManager.getInstance();if(mgr._capturingMouseArea==this&&0==this._dragStarted&&(Math.abs(this._oldX-x)>1||Math.abs(this._oldY-y)>1)&&(this._dragStarted=!0),this._dragStarted)return mgr.hideCursor(),mgr.onToolMouseDrag(this.getFrameName(),x,y)?this:(mgr.getTimeline(this.getDataSourceName()).move(x-this._oldX),this);if(this._passMoveEventToToolManager&&mgr.onToolMouseMove(this.getFrameName(),x,y))return mgr.hideCursor(),this;switch(mgr._drawingTool){case ChartManager.DrawingTool.Cursor:mgr.showCursor();break;case ChartManager.DrawingTool.CrossCursor:mgr.showCrossCursor(this,x,y)?mgr.hideCursor():mgr.showCursor();break;default:mgr.hideCursor()}return this},MainArea.prototype.onMouseLeave=function(x,y){this._dragStarted=!1,this._passMoveEventToToolManager=!0},MainArea.prototype.onMouseDown=function(x,y){var mgr=ChartManager.getInstance();return mgr.getTimeline(this.getDataSourceName()).startMove(),this._oldX=x,this._oldY=y,this._dragStarted=!1,mgr.onToolMouseDown(this.getFrameName(),x,y)&&(this._passMoveEventToToolManager=!1),this},MainArea.prototype.onMouseUp=function(x,y){var mgr=ChartManager.getInstance(),ret=null;return this._dragStarted&&(this._dragStarted=!1,ret=this),mgr.onToolMouseUp(this.getFrameName(),x,y)&&(ret=this),this._passMoveEventToToolManager=!0,ret};var IndicatorArea=create_class(ChartArea);IndicatorArea.prototype.__construct=function(name){IndicatorArea.__super.__construct.call(this,name),this._dragStarted=!1,this._oldX=0,this._oldY=0},IndicatorArea.prototype.onMouseMove=function(x,y){var mgr=ChartManager.getInstance();if(mgr._capturingMouseArea==this&&0==this._dragStarted&&(this._oldX==x&&this._oldY==y||(this._dragStarted=!0)),this._dragStarted)return mgr.hideCursor(),mgr.getTimeline(this.getDataSourceName()).move(x-this._oldX),this;switch(mgr._drawingTool){case ChartManager.DrawingTool.CrossCursor:mgr.showCrossCursor(this,x,y)?mgr.hideCursor():mgr.showCursor();break;default:mgr.showCursor()}return this},IndicatorArea.prototype.onMouseLeave=function(x,y){this._dragStarted=!1},IndicatorArea.prototype.onMouseDown=function(x,y){var mgr=ChartManager.getInstance();return mgr.getTimeline(this.getDataSourceName()).startMove(),this._oldX=x,this._oldY=y,this._dragStarted=!1,this},IndicatorArea.prototype.onMouseUp=function(x,y){return this._dragStarted?(this._dragStarted=!1,this):null};var MainRangeArea=create_class(ChartArea);MainRangeArea.prototype.__construct=function(name){MainRangeArea.__super.__construct.call(this,name)},MainRangeArea.prototype.onMouseMove=function(x,y){return ChartManager.getInstance().showCursor(),this};var IndicatorRangeArea=create_class(ChartArea);IndicatorRangeArea.prototype.__construct=function(name){IndicatorRangeArea.__super.__construct.call(this,name)},IndicatorRangeArea.prototype.onMouseMove=function(x,y){return ChartManager.getInstance().showCursor(),this};var TimelineArea=create_class(ChartArea);TimelineArea.prototype.__construct=function(name){TimelineArea.__super.__construct.call(this,name)},TimelineArea.prototype.onMouseMove=function(x,y){return ChartManager.getInstance().showCursor(),this};var ChartAreaGroup=create_class(ChartArea);ChartAreaGroup.prototype.__construct=function(name){ChartAreaGroup.__super.__construct.call(this,name),this._areas=[],this._highlightedArea=null,this._selectedArea=null},ChartAreaGroup.prototype.contains=function(x,y){var areas,a,i,cnt=this._areas.length;for(i=0;i<cnt;i++)if(a=this._areas[i],areas=a.contains(x,y),null!=areas)return areas.push(this),areas;return ChartAreaGroup.__super.contains(x,y)},ChartAreaGroup.prototype.getAreaCount=function(){return this._areas.length},ChartAreaGroup.prototype.getAreaAt=function(index){return index<0||index>=this._areas.length?null:this._areas[index]},ChartAreaGroup.prototype.addArea=function(area){this._areas.push(area)},ChartAreaGroup.prototype.removeArea=function(area){var i,cnt=this._areas.length;for(i=0;i<cnt;i++)if(area==this._areas[i]){this._areas.splice(i),this.setChanged(!0);break}},ChartAreaGroup.prototype.getGridColor=function(){return this._gridColor},ChartAreaGroup.prototype.setGridColor=function(c){this._gridColor=c},ChartAreaGroup.prototype.getHighlightedArea=function(){return null!=this._highlightedArea?this._highlightedArea.getHighlightedArea():null},ChartAreaGroup.prototype.highlight=function(area){this._highlightedArea=null;var e,i,cnt=this._areas.length;for(i=0;i<cnt;i++)if(e=this._areas[i].highlight(area),null!=e)return this._highlightedArea=e,this;return null},ChartAreaGroup.prototype.getSelectedArea=function(){return null!=this._selectedArea?this._selectedArea.getSelectedArea():null},ChartAreaGroup.prototype.select=function(area){this._selectedArea=null;var e,i,cnt=this._areas.length;for(i=0;i<cnt;i++)if(e=this._areas[i].select(area),null!=e)return this._selectedArea=e,this;return null},ChartAreaGroup.prototype.onMouseLeave=function(x,y){var i,cnt=this._areas.length;for(i=0;i<cnt;i++)this._areas[i].onMouseLeave(x,y)},ChartAreaGroup.prototype.onMouseUp=function(x,y){var a,i,cnt=this._areas.length;for(i=0;i<cnt;i++)if(a=this._areas[i].onMouseUp(x,y),null!=a)return a;return null};var TableLayout=create_class(ChartAreaGroup);TableLayout.prototype.__construct=function(name){TableLayout.__super.__construct.call(this,name),this._nextRowId=0,this._focusedRowIndex=-1},TableLayout.prototype.getNextRowId=function(){return this._nextRowId++},TableLayout.prototype.measure=function(context,width,height){this.setMeasuredDimension(width,height);var rowH,h,rows,i,prevH=0,totalH=0,rh=[],cnt=this._areas.length;for(i=0;i<cnt;i+=2){if(rowH=this._areas[i].getHeight(),0==rowH){if(0==i){rows=cnt+1>>1;var n=2*rows+5,nh=height/n*2<<0;for(h=height,i=rows-1;i>0;i--)rh.unshift(nh),h-=nh;rh.unshift(h);break}rowH=2==i?prevH/3:prevH}totalH+=rowH,prevH=rowH,rh.push(rowH)}if(totalH>0){var rate=height/totalH;for(rows=cnt+1>>1,h=height,i=rows-1;i>0;i--)rh[i]*=rate,h-=rh[i];rh[0]=h}var nw=8,minRW=64,maxRW=Math.min(240,width>>1),rw=minRW,mgr=ChartManager.getInstance(),timeline=mgr.getTimeline(this.getDataSourceName());if(timeline.getFirstIndex()>=0){var firstIndexes=[];for(rw=minRW;rw<maxRW;rw+=nw)firstIndexes.push(timeline.calcFirstIndex(timeline.calcColumnCount(width-rw)));var iArea,iIndex,lastIndex=timeline.getLastIndex(),dpNames=[".main",".secondary"],minmaxes=new Array(firstIndexes.length);for(iArea=0,iIndex=0,rw=minRW;iArea<this._areas.length&&iIndex<firstIndexes.length;iArea+=2){var area=this._areas[iArea],plotter=mgr.getPlotter(area.getName()+"Range.main");for(var iDp in dpNames){var dp=mgr.getDataProvider(area.getName()+dpNames[iDp]);if(void 0!=dp)for(dp.calcRange(firstIndexes,lastIndex,minmaxes,null);iIndex<firstIndexes.length;){var minW=plotter.getRequiredWidth(context,minmaxes[iIndex].min),maxW=plotter.getRequiredWidth(context,minmaxes[iIndex].max);if(Math.max(minW,maxW)<rw)break;iIndex++,rw+=nw}}}}for(i=1;i<this._areas.length;i+=2)this._areas[i].measure(context,rw,rh[i>>1]);var lw=width-rw;for(i=0;i<this._areas.length;i+=2)this._areas[i].measure(context,lw,rh[i>>1])},TableLayout.prototype.layout=function(left,top,right,bottom,forceChange){if(TableLayout.__super.layout.call(this,left,top,right,bottom,forceChange),!(this._areas.length<1)){var area,b,center=left+this._areas[0].getMeasuredWidth(),t=top;forceChange||(forceChange=this.isChanged());var i,cnt=this._areas.length;for(i=0;i<cnt;i++)area=this._areas[i],b=t+area.getMeasuredHeight(),area.layout(left,t,center,b,forceChange),i++,area=this._areas[i],area.layout(center,t,this.getRight(),b,forceChange),t=b;this.setChanged(!1)}},TableLayout.prototype.drawGrid=function(context){if(!(this._areas.length<1)){var mgr=ChartManager.getInstance(),theme=mgr.getTheme(this.getFrameName());context.fillStyle=theme.getColor(Theme.Color.Grid1),context.fillRect(this._areas[0].getRight(),this.getTop(),1,this.getHeight());var i,cnt=this._areas.length-2;for(i=0;i<cnt;i+=2)context.fillRect(this.getLeft(),this._areas[i].getBottom(),this.getWidth(),1);if(!mgr.getCaptureMouseWheelDirectly())for(i=0,cnt+=2;i<cnt;i+=2)if(this._areas[i].isSelected()){context.strokeStyle=theme.getColor(Theme.Color.Indicator1),context.strokeRect(this.getLeft()+.5,this.getTop()+.5,this.getWidth()-1,this.getHeight()-1);break}}},TableLayout.prototype.highlight=function(area){this._highlightedArea=null;var e,i,cnt=this._areas.length;for(i=0;i<cnt;i++)e=this._areas[i],e==area?(i&=-2,e=this._areas[i],e.highlight(e),this._highlightedArea=e,i++,e=this._areas[i],e.highlight(null),e.highlight(e)):e.highlight(null);return null!=this._highlightedArea?this:null},TableLayout.prototype.select=function(area){this._selectedArea=null;var e,i,cnt=this._areas.length;for(i=0;i<cnt;i++)e=this._areas[i],e==area?(i&=-2,e=this._areas[i],e.select(e),this._selectedArea=e,i++,e=this._areas[i],e.select(e)):e.select(null);return null!=this._selectedArea?this:null},TableLayout.prototype.onMouseMove=function(x,y){if(this._focusedRowIndex>=0){var upper=this._areas[this._focusedRowIndex],lower=this._areas[this._focusedRowIndex+2],d=y-this._oldY;if(0==d)return this;var upperBottom=this._oldUpperBottom+d,lowerTop=this._oldLowerTop+d;return upperBottom-upper.getTop()>=60&&lower.getBottom()-lowerTop>=60&&(upper.setBottom(upperBottom),lower.setTop(lowerTop)),this}var i,cnt=this._areas.length-2;for(i=0;i<cnt;i+=2){var b=this._areas[i].getBottom();if(y>=b-4&&y<b+4)return ChartManager.getInstance().showCursor("n-resize"),this}return null},TableLayout.prototype.onMouseLeave=function(x,y){this._focusedRowIndex=-1},TableLayout.prototype.onMouseDown=function(x,y){var i,cnt=this._areas.length-2;for(i=0;i<cnt;i+=2){var b=this._areas[i].getBottom();if(y>=b-4&&y<b+4)return this._focusedRowIndex=i,this._oldY=y,this._oldUpperBottom=b,this._oldLowerTop=this._areas[i+2].getTop(),this}return null},TableLayout.prototype.onMouseUp=function(x,y){if(this._focusedRowIndex>=0){this._focusedRowIndex=-1;var i,cnt=this._areas.length,height=[];for(i=0;i<cnt;i+=2)height.push(this._areas[i].getHeight());ChartSettings.get().charts.areaHeight=height,ChartSettings.save()}return this};var DockableLayout=create_class(ChartAreaGroup);DockableLayout.prototype.__construct=function(name){DockableLayout.__super.__construct.call(this,name)},DockableLayout.prototype.measure=function(context,width,height){DockableLayout.__super.measure.call(this,context,width,height),width=this.getMeasuredWidth(),height=this.getMeasuredHeight();for(var i in this._areas){var area=this._areas[i];switch(area.measure(context,width,height),area.getDockStyle()){case ChartArea.DockStyle.left:case ChartArea.DockStyle.Right:width-=area.getMeasuredWidth();break;case ChartArea.DockStyle.Top:case ChartArea.DockStyle.Bottom:height-=area.getMeasuredHeight();break;case ChartArea.DockStyle.Fill:width=0,height=0}}},DockableLayout.prototype.layout=function(left,top,right,bottom,forceChange){DockableLayout.__super.layout.call(this,left,top,right,bottom,forceChange),left=this.getLeft(),top=this.getTop(),right=this.getRight(),bottom=this.getBottom();var w,h;forceChange||(forceChange=this.isChanged());for(var i in this._areas){var area=this._areas[i];switch(area.getDockStyle()){case ChartArea.DockStyle.left:w=area.getMeasuredWidth(),area.layout(left,top,left+w,bottom,forceChange),left+=w;break;case ChartArea.DockStyle.Top:h=area.getMeasuredHeight(),area.layout(left,top,right,top+h,forceChange),top+=h;break;case ChartArea.DockStyle.Right:w=area.getMeasuredWidth(),area.layout(right-w,top,right,bottom,forceChange),right-=w;break;case ChartArea.DockStyle.Bottom:h=area.getMeasuredHeight(),area.layout(left,bottom-h,right,bottom,forceChange),bottom-=h;break;case ChartArea.DockStyle.Fill:area.layout(left,top,right,bottom,forceChange),left=right,top=bottom}}this.setChanged(!1)},DockableLayout.prototype.drawGrid=function(context){var mgr=ChartManager.getInstance(),theme=mgr.getTheme(this.getFrameName()),left=this.getLeft(),top=this.getTop(),right=this.getRight(),bottom=this.getBottom();context.fillStyle=theme.getColor(this._gridColor);for(var i in this._areas){var area=this._areas[i];switch(area.getDockStyle()){case ChartArea.DockStyle.Left:context.fillRect(area.getRight(),top,1,bottom-top),left+=area.getWidth();break;case ChartArea.DockStyle.Top:context.fillRect(left,area.getBottom(),right-left,1),top+=area.getHeight();break;case ChartArea.DockStyle.Right:context.fillRect(area.getLeft(),top,1,bottom-top),right-=area.getWidth();break;case ChartArea.DockStyle.Bottom:context.fillRect(left,area.getTop(),right-left,1),bottom-=area.getHeight()}}};var ChartManager=create_class();ChartManager.DrawingTool={Cursor:0,CrossCursor:1,DrawLines:2,DrawFibRetrace:3,DrawFibFans:4,SegLine:5,StraightLine:6,ArrowLine:7,RayLine:8,HoriStraightLine:9,HoriRayLine:10,HoriSegLine:11,VertiStraightLine:12,PriceLine:13,BiParallelLine:14,BiParallelRayLine:15,TriParallelLine:16,BandLine:17},ChartManager._instance=null,ChartManager.getInstance=function(){return null==ChartManager._instance&&(ChartManager._instance=new ChartManager),ChartManager._instance},ChartManager.prototype.__construct=function(){this._dataSources={},this._dataSourceCache={},this._dataProviders={},this._frames={},this._areas={},this._timelines={},this._ranges={},this._plotters={},this._themes={},this._titles={},this._frameMousePos={},this._dsChartStyle={},this._dragStarted=!1,this._oldX=0,this._fakeIndicators={},this._captureMouseWheelDirectly=!0,this._chart={},this._chart.defaultFrame=new Chart,this._drawingTool=ChartManager.DrawingTool.CrossCursor,this._beforeDrawingTool=this._drawingTool,this._language="zh-cn",this._mainCanvas=null,this._overlayCanvas=null,this._mainContext=null,this._overlayContext=null},ChartManager.prototype.redraw=function(layer,refresh){(void 0==layer||refresh)&&(layer="All"),"All"!=layer&&"MainCanvas"!=layer||(refresh&&(this.getFrame("frame0").setChanged(!0),this._mainContext.clearRect(0,0,this._mainCanvas.width,this._mainCanvas.height)),this.layout(this._mainContext,"frame0",0,0,this._mainCanvas.width,this._mainCanvas.height),this.drawMain("frame0",this._mainContext)),"All"!=layer&&"OverlayCanvas"!=layer||(this._overlayContext.clearRect(0,0,this._overlayCanvas.width,this._overlayCanvas.height),this.drawOverlay("frame0",this._overlayContext))},ChartManager.prototype.bindCanvas=function(layer,canvas){"main"==layer?(this._mainCanvas=canvas,this._mainContext=canvas.getContext("2d")):"overlay"==layer&&(this._overlayCanvas=canvas,this._overlayContext=canvas.getContext("2d"),this._captureMouseWheelDirectly&&$(this._overlayCanvas).bind("mousewheel",mouseWheel))},ChartManager.prototype.getCaptureMouseWheelDirectly=function(){return this._captureMouseWheelDirectly},ChartManager.prototype.setCaptureMouseWheelDirectly=function(v){this._captureMouseWheelDirectly=v,v?$(this._overlayCanvas).bind("mousewheel",mouseWheel):$(this._overlayCanvas).unbind("mousewheel")},ChartManager.prototype.getChart=function(nouseParam){return this._chart.defaultFrame},ChartManager.prototype.init=function(){delete this._ranges["frame0.k0.indic1"],delete this._ranges["frame0.k0.indic1Range"],delete this._areas["frame0.k0.indic1"],delete this._areas["frame0.k0.indic1Range"],DefaultTemplate.loadTemplate("frame0.k0","OKCoin","frame0.order","0.order","frame0.trade","0.trade"),this.redraw("All",!0)},ChartManager.prototype.setCurrentDrawingTool=function(paramTool){this._drawingTool=ChartManager.DrawingTool[paramTool],this.setRunningMode(this._drawingTool)},ChartManager.prototype.getLanguage=function(){return this._language},ChartManager.prototype.setLanguage=function(lang){this._language=lang},ChartManager.prototype.setThemeName=function(frameName,themeName){void 0==themeName&&(themeName="Dark");var theme;switch(themeName){case"Light":theme=new LightTheme;break;default:themeName="Dark",theme=new DarkTheme}this._themeName=themeName,this.setTheme(frameName,theme),this.getFrame(frameName).setChanged(!0)},ChartManager.prototype.getChartStyle=function(dsName){var chartStyle=this._dsChartStyle[dsName];return void 0==chartStyle?"CandleStick":chartStyle},ChartManager.prototype.setChartStyle=function(dsName,style){if(this._dsChartStyle[dsName]!=style){var dp,plotter,areaName=dsName+".main",dpName=areaName+".main",plotterName=areaName+".main";switch(style){case"CandleStick":case"CandleStickHLC":case"OHLC":switch(dp=this.getDataProvider(dpName),void 0!=dp&&is_instance(dp,MainDataProvider)||(dp=new MainDataProvider(dpName),this.setDataProvider(dpName,dp),dp.updateData()),this.setMainIndicator(dsName,ChartSettings.get().charts.mIndic),style){case"CandleStick":plotter=new CandlestickPlotter(plotterName);break;case"CandleStickHLC":plotter=new CandlestickHLCPlotter(plotterName);break;case"OHLC":plotter=new OHLCPlotter(plotterName)}this.setPlotter(plotterName,plotter),plotter=new MinMaxPlotter(areaName+".decoration"),this.setPlotter(plotter.getName(),plotter);break;case"Line":dp=new IndicatorDataProvider(dpName),this.setDataProvider(dp.getName(),dp),dp.setIndicator(new HLCIndicator),this.removeMainIndicator(dsName),plotter=new IndicatorPlotter(plotterName),this.setPlotter(plotterName,plotter),this.removePlotter(areaName+".decoration")}this.getArea(plotter.getAreaName()).setChanged(!0),this._dsChartStyle[dsName]=style}},ChartManager.prototype.setNormalMode=function(){this._drawingTool=this._beforeDrawingTool,$(".chart_dropdown_data").removeClass("chart_dropdown-hover"),$("#chart_toolpanel .chart_toolpanel_button").removeClass("selected"),$("#chart_CrossCursor").parent().addClass("selected"),this._drawingTool==ChartManager.DrawingTool.Cursor?(this.showCursor(),$("#mode a").removeClass("selected"),$("#chart_toolpanel .chart_toolpanel_button").removeClass("selected"),$("#chart_Cursor").parent().addClass("selected")):this.hideCursor()},ChartManager.prototype.setRunningMode=function(mode){var pds=this.getDataSource("frame0.k0"),curr_o=pds.getCurrentToolObject();if(null!=curr_o&&curr_o.state!=CToolObject.state.AfterDraw&&pds.delToolObject(),pds.getToolObjectCount()>10)return void this.setNormalMode();switch(this._drawingTool=mode,mode==ChartManager.DrawingTool.Cursor&&this.showCursor(),mode){case ChartManager.DrawingTool.Cursor:this._beforeDrawingTool=mode;break;case ChartManager.DrawingTool.ArrowLine:pds.addToolObject(new CArrowLineObject("frame0.k0"));break;case ChartManager.DrawingTool.BandLine:pds.addToolObject(new CBandLineObject("frame0.k0"));break;case ChartManager.DrawingTool.BiParallelLine:pds.addToolObject(new CBiParallelLineObject("frame0.k0"));
break;case ChartManager.DrawingTool.BiParallelRayLine:pds.addToolObject(new CBiParallelRayLineObject("frame0.k0"));break;case ChartManager.DrawingTool.CrossCursor:this._beforeDrawingTool=mode;break;case ChartManager.DrawingTool.DrawFibFans:pds.addToolObject(new CFibFansObject("frame0.k0"));break;case ChartManager.DrawingTool.DrawFibRetrace:pds.addToolObject(new CFibRetraceObject("frame0.k0"));break;case ChartManager.DrawingTool.DrawLines:pds.addToolObject(new CStraightLineObject("frame0.k0"));break;case ChartManager.DrawingTool.HoriRayLine:pds.addToolObject(new CHoriRayLineObject("frame0.k0"));break;case ChartManager.DrawingTool.HoriSegLine:pds.addToolObject(new CHoriSegLineObject("frame0.k0"));break;case ChartManager.DrawingTool.HoriStraightLine:pds.addToolObject(new CHoriStraightLineObject("frame0.k0"));break;case ChartManager.DrawingTool.PriceLine:pds.addToolObject(new CPriceLineObject("frame0.k0"));break;case ChartManager.DrawingTool.RayLine:pds.addToolObject(new CRayLineObject("frame0.k0"));break;case ChartManager.DrawingTool.SegLine:pds.addToolObject(new CSegLineObject("frame0.k0"));break;case ChartManager.DrawingTool.StraightLine:pds.addToolObject(new CStraightLineObject("frame0.k0"));break;case ChartManager.DrawingTool.TriParallelLine:pds.addToolObject(new CTriParallelLineObject("frame0.k0"));break;case ChartManager.DrawingTool.VertiStraightLine:pds.addToolObject(new CVertiStraightLineObject("frame0.k0"))}},ChartManager.prototype.getTitle=function(dsName){return this._titles[dsName]},ChartManager.prototype.setTitle=function(dsName,title){this._titles[dsName]=title},ChartManager.prototype.setCurrentDataSource=function(dsName,dsAlias){var cached=this.getCachedDataSource(dsAlias);if(null!=cached)this.setDataSource(dsName,cached,!0);else{var ds=this.getDataSource(dsName);null!=ds&&(is_instance(ds,MainDataSource)?cached=new MainDataSource(dsAlias):is_instance(ds,CLiveOrderDataSource)?cached=new CLiveOrderDataSource(dsAlias):is_instance(ds,CLiveTradeDataSource)&&(cached=new CLiveTradeDataSource(dsAlias)),this.setDataSource(dsName,cached,!0),this.setCachedDataSource(dsAlias,cached))}},ChartManager.prototype.getDataSource=function(name){return this._dataSources[name]},ChartManager.prototype.setDataSource=function(name,ds,forceRefresh){this._dataSources[name]=ds,forceRefresh&&this.updateData(name,null)},ChartManager.prototype.getCachedDataSource=function(name){return this._dataSourceCache[name]},ChartManager.prototype.setCachedDataSource=function(name,ds){this._dataSourceCache[name]=ds},ChartManager.prototype.getDataProvider=function(name){return this._dataProviders[name]},ChartManager.prototype.setDataProvider=function(name,dp){this._dataProviders[name]=dp},ChartManager.prototype.removeDataProvider=function(name){delete this._dataProviders[name]},ChartManager.prototype.getFrame=function(name){return this._frames[name]},ChartManager.prototype.setFrame=function(name,frame){this._frames[name]=frame},ChartManager.prototype.removeFrame=function(name){delete this._frames[name]},ChartManager.prototype.getArea=function(name){return this._areas[name]},ChartManager.prototype.setArea=function(name,area){this._areas[name]=area},ChartManager.prototype.removeArea=function(name){delete this._areas[name]},ChartManager.prototype.getTimeline=function(name){return this._timelines[name]},ChartManager.prototype.setTimeline=function(name,timeline){this._timelines[name]=timeline},ChartManager.prototype.removeTimeline=function(name){delete this._timelines[name]},ChartManager.prototype.getRange=function(name){return this._ranges[name]},ChartManager.prototype.setRange=function(name,range){this._ranges[name]=range},ChartManager.prototype.removeRange=function(name){delete this._ranges[name]},ChartManager.prototype.getPlotter=function(name){return this._plotters[name]},ChartManager.prototype.setPlotter=function(name,plotter){this._plotters[name]=plotter},ChartManager.prototype.removePlotter=function(name){delete this._plotters[name]},ChartManager.prototype.getTheme=function(name){return this._themes[name]},ChartManager.prototype.setTheme=function(name,theme){this._themes[name]=theme},ChartManager.prototype.getFrameMousePos=function(name,point){void 0!=this._frameMousePos[name]?(point.x=this._frameMousePos[name].x,point.y=this._frameMousePos[name].y):(point.x=-1,point.y=-1)},ChartManager.prototype.setFrameMousePos=function(name,px,py){this._frameMousePos[name]={x:px,y:py}},ChartManager.prototype.drawArea=function(context,area,plotterNames){var areaName=area.getNameObject().getCompAt(2);if("timeline"==areaName){if(area.getHeight()<20)return}else if(area.getHeight()<30)return;if(!(area.getWidth()<30)){areaName=area.getName();var plotter,i,cnt=plotterNames.length;for(i=0;i<cnt;i++)plotter=this._plotters[areaName+plotterNames[i]],void 0!=plotter&&plotter.Draw(context)}},ChartManager.prototype.drawAreaMain=function(context,area){var plotterNames,ds=this._dataSources[area.getDataSourceName()];plotterNames=ds.getDataCount()<1?[".background"]:[".background",".grid",".main",".secondary"],this.drawArea(context,area,plotterNames),area.setChanged(!1)},ChartManager.prototype.drawAreaOverlay=function(context,area){var plotterNames,ds=this._dataSources[area.getDataSourceName()];plotterNames=ds.getDataCount()<1?[".selection"]:[".decoration",".selection",".info",".tool"],this.drawArea(context,area,plotterNames)},ChartManager.prototype.drawMain=function(frameName,context){if(drawn=!1,!drawn)for(var it in this._areas)this._areas[it].getFrameName()!=frameName||is_instance(this._areas[it],ChartAreaGroup)||this.drawAreaMain(context,this._areas[it]);var e;for(var i in this._timelines)e=this._timelines[i],e.getFrameName()==frameName&&e.setUpdated(!1);for(var i in this._ranges)e=this._ranges[i],e.getFrameName()==frameName&&e.setUpdated(!1);for(var i in this._areas)e=this._areas[i],e.getFrameName()==frameName&&e.setChanged(!1)},ChartManager.prototype.drawOverlay=function(frameName,context){for(var n in this._areas){var area=this._areas[n];is_instance(area,ChartAreaGroup)&&area.getFrameName()==frameName&&area.drawGrid(context)}for(var n in this._areas){var area=this._areas[n];0==is_instance(area,ChartAreaGroup)&&area.getFrameName()==frameName&&this.drawAreaOverlay(context,area)}},ChartManager.prototype.updateData=function(dsName,data){var ds=this.getDataSource(dsName);if(void 0!=ds){if(null!=data){if(!ds.update(data))return!1;if(ds.getUpdateMode()==DataSource.UpdateMode.DoNothing)return!0}else ds.setUpdateMode(DataSource.UpdateMode.Refresh);var timeline=this.getTimeline(dsName);if(void 0!=timeline&&timeline.update(),ds.getDataCount()<1)return!0;var area,areaName,dpNames=[".main",".secondary"];for(var n in this._areas)if(area=this._areas[n],!is_instance(area,ChartAreaGroup)&&area.getDataSourceName()==dsName){areaName=area.getName();for(var i=0;i<dpNames.length;i++){var dp=this.getDataProvider(areaName+dpNames[i]);void 0!=dp&&dp.updateData()}}return!0}},ChartManager.prototype.updateRange=function(dsName){var ds=this.getDataSource(dsName);if(!(ds.getDataCount()<1)){var area,areaName,dpNames=[".main",".secondary"];for(var n in this._areas)if(area=this._areas[n],!is_instance(area,ChartAreaGroup)&&area.getDataSourceName()==dsName){areaName=area.getName();for(var i=0;i<dpNames.length;i++){var dp=this.getDataProvider(areaName+dpNames[i]);void 0!=dp&&dp.updateRange()}var timeline=this.getTimeline(dsName);if(void 0!=timeline&&timeline.getMaxItemCount()>0){var range=this.getRange(areaName);void 0!=range&&range.update()}}}},ChartManager.prototype.layout=function(context,frameName,left,top,right,bottom){var frame=this.getFrame(frameName);frame.measure(context,right-left,bottom-top),frame.layout(left,top,right,bottom);for(var n in this._timelines){var e=this._timelines[n];e.getFrameName()==frameName&&e.onLayout()}for(var n in this._dataSources)n.substring(0,frameName.length)==frameName&&this.updateRange(n)},ChartManager.prototype.SelectRange=function(pArea,y){for(var ee in this._ranges){var _1=this._ranges[ee].getAreaName(),_2=pArea.getName();_1==_2?this._ranges[ee].selectAt(y):this._ranges[ee].unselect()}},ChartManager.prototype.scale=function(s){if(null!=this._highlightedFrame){var hiArea=this._highlightedFrame.getHighlightedArea();if(void 0!=this.getRange(hiArea.getName())){var dsName=hiArea.getDataSourceName(),timeline=this.getTimeline(dsName);null!=timeline&&(timeline.scale(s),this.updateRange(dsName))}}},ChartManager.prototype.showCursor=function(cursor){void 0===cursor&&(cursor="default"),this._mainCanvas.style.cursor=cursor,this._overlayCanvas.style.cursor=cursor},ChartManager.prototype.hideCursor=function(){this._mainCanvas.style.cursor="none",this._overlayCanvas.style.cursor="none"},ChartManager.prototype.showCrossCursor=function(area,x,y){var e=this.getRange(area.getName());return!(void 0==e||(e.selectAt(y),e=this.getTimeline(area.getDataSourceName()),void 0==e||!e.selectAt(x)))},ChartManager.prototype.hideCrossCursor=function(exceptTimeline){if(null!=exceptTimeline)for(var n in this._timelines){var e=this._timelines[n];e!=exceptTimeline&&e.unselect()}else for(var n in this._timelines)this._timelines[n].unselect();for(var n in this._ranges)this._ranges[n].unselect()},ChartManager.prototype.clearHighlight=function(){null!=this._highlightedFrame&&(this._highlightedFrame.highlight(null),this._highlightedFrame=null)},ChartManager.prototype.onToolMouseMove=function(frameName,x,y){var ret=!1;frameName+=".";for(var n in this._dataSources)if(0==n.indexOf(frameName)){var ds=this._dataSources[n];is_instance(ds,MainDataSource)&&ds.toolManager.acceptMouseMoveEvent(x,y)&&(ret=!0)}return ret},ChartManager.prototype.onToolMouseDown=function(frameName,x,y){var ret=!1;frameName+=".";for(var n in this._dataSources)if(0==n.indexOf(frameName)){var ds=this._dataSources[n];is_instance(ds,MainDataSource)&&ds.toolManager.acceptMouseDownEvent(x,y)&&(ret=!0)}return ret},ChartManager.prototype.onToolMouseUp=function(frameName,x,y){var ret=!1;frameName+=".";for(var n in this._dataSources)if(0==n.indexOf(frameName)){var ds=this._dataSources[n];is_instance(ds,MainDataSource)&&ds.toolManager.acceptMouseUpEvent(x,y)&&(ret=!0)}return ret},ChartManager.prototype.onToolMouseDrag=function(frameName,x,y){var ret=!1;frameName+=".";for(var n in this._dataSources)if(0==n.indexOf(frameName)){var ds=this._dataSources[n];is_instance(ds,MainDataSource)&&ds.toolManager.acceptMouseDownMoveEvent(x,y)&&(ret=!0)}return ret},ChartManager.prototype.onMouseMove=function(frameName,x,y,drag){var frame=this.getFrame(frameName);if(void 0!==frame){if(this.setFrameMousePos(frameName,x,y),this.hideCrossCursor(),this._highlightedFrame!=frame&&this.clearHighlight(),null!=this._capturingMouseArea)return void this._capturingMouseArea.onMouseMove(x,y);var areas=frame.contains(x,y);if(null!=areas){var a,i,cnt=areas.length;for(i=cnt-1;i>=0;i--)if(a=areas[i],a=a.onMouseMove(x,y),null!=a)return void(is_instance(a,ChartAreaGroup)||(frame.highlight(a),this._highlightedFrame=frame))}}},ChartManager.prototype.onMouseLeave=function(frameName,x,y,move){var frame=this.getFrame(frameName);void 0!=frame&&(this.setFrameMousePos(frameName,x,y),this.hideCrossCursor(),this.clearHighlight(),null!=this._capturingMouseArea&&(this._capturingMouseArea.onMouseLeave(x,y),this._capturingMouseArea=null),this._dragStarted=!1)},ChartManager.prototype.onMouseDown=function(frameName,x,y){var frame=this.getFrame(frameName);if(void 0!=frame){var areas=frame.contains(x,y);if(null!=areas){var a,i,cnt=areas.length;for(i=cnt-1;i>=0;i--)if(a=areas[i],a=a.onMouseDown(x,y),null!=a)return void(this._capturingMouseArea=a)}}},ChartManager.prototype.onMouseUp=function(frameName,x,y){var frame=this.getFrame(frameName);void 0!=frame&&this._capturingMouseArea&&(null==this._capturingMouseArea.onMouseUp(x,y)&&0==this._dragStarted&&(null!=this._selectedFrame&&this._selectedFrame!=frame&&this._selectedFrame.select(null),this._capturingMouseArea.isSelected()?(this._captureMouseWheelDirectly||$(this._overlayCanvas).unbind("mousewheel"),frame.select(null),this._selectedFrame=null):(this._selectedFrame!=frame&&(this._captureMouseWheelDirectly||$(this._overlayCanvas).bind("mousewheel",mouseWheel)),frame.select(this._capturingMouseArea),this._selectedFrame=frame)),this._capturingMouseArea=null,this._dragStarted=!1)},ChartManager.prototype.deleteToolObject=function(){var pDPTool=this.getDataSource("frame0.k0"),selectObject=pDPTool.getSelectToolObjcet();null!=selectObject&&pDPTool.delSelectToolObject();var currentObject=pDPTool.getCurrentToolObject();null!=currentObject&&currentObject.getState()!=CToolObject.state.AfterDraw&&pDPTool.delToolObject(),this.setNormalMode()},ChartManager.prototype.unloadTemplate=function(frameName){var frame=this.getFrame(frameName);if(void 0!=frame){for(var n in this._dataSources)n.match(frameName+".")&&delete this._dataSources[n];for(var n in this._dataProviders)this._dataProviders[n].getFrameName()==frameName&&delete this._dataProviders[n];delete this._frames[frameName];for(var n in this._areas)this._areas[n].getFrameName()==frameName&&delete this._areas[n];for(var n in this._timelines)this._timelines[n].getFrameName()==frameName&&delete this._timelines[n];for(var n in this._ranges)this._ranges[n].getFrameName()==frameName&&delete this._ranges[n];for(var n in this._plotters)this._plotters[n].getFrameName()==frameName&&delete this._plotters[n];delete this._themes[frameName],delete this._frameMousePos[frameName]}},ChartManager.prototype.createIndicatorAndRange=function(areaName,indicName,notLoadSettings){var indic,range;switch(indicName){case"MA":indic=new MAIndicator,range=new PositiveRange(areaName);break;case"EMA":indic=new EMAIndicator,range=new PositiveRange(areaName);break;case"VOLUME":indic=new VOLUMEIndicator,range=new ZeroBasedPositiveRange(areaName);break;case"MACD":indic=new MACDIndicator,range=new ZeroCenteredRange(areaName);break;case"DMI":indic=new DMIIndicator,range=new PercentageRange(areaName);break;case"DMA":indic=new DMAIndicator,range=new Range(areaName);break;case"TRIX":indic=new TRIXIndicator,range=new Range(areaName);break;case"BRAR":indic=new BRARIndicator,range=new Range(areaName);break;case"VR":indic=new VRIndicator,range=new Range(areaName);break;case"OBV":indic=new OBVIndicator,range=new Range(areaName);break;case"EMV":indic=new EMVIndicator,range=new Range(areaName);break;case"RSI":indic=new RSIIndicator,range=new PercentageRange(areaName);break;case"WR":indic=new WRIndicator,range=new PercentageRange(areaName);break;case"SAR":indic=new SARIndicator,range=new PositiveRange(areaName);break;case"KDJ":indic=new KDJIndicator,range=new PercentageRange(areaName);break;case"ROC":indic=new ROCIndicator,range=new Range(areaName);break;case"MTM":indic=new MTMIndicator,range=new Range(areaName);break;case"BOLL":indic=new BOLLIndicator,range=new Range(areaName);break;case"PSY":indic=new PSYIndicator,range=new Range(areaName);break;case"StochRSI":indic=new STOCHRSIIndicator,range=new PercentageRange(areaName);break;default:return null}return notLoadSettings||indic.setParameters(ChartSettings.get().indics[indicName]),{indic:indic,range:range}},ChartManager.prototype.setMainIndicator=function(dsName,indicName){var areaName=dsName+".main",dp=this.getDataProvider(areaName+".main");if(void 0==dp||!is_instance(dp,MainDataProvider))return!1;var indic;switch(indicName){case"MA":indic=new MAIndicator;break;case"EMA":indic=new EMAIndicator;break;case"BOLL":indic=new BOLLIndicator;break;case"SAR":indic=new SARIndicator;break;default:return!1}indic.setParameters(ChartSettings.get().indics[indicName]);var indicDpName=areaName+".secondary",indicDp=this.getDataProvider(indicDpName);void 0==indicDp&&(indicDp=new IndicatorDataProvider(indicDpName),this.setDataProvider(indicDp.getName(),indicDp)),indicDp.setIndicator(indic);var plotter=this.getPlotter(indicDpName);return void 0==plotter&&(plotter=new IndicatorPlotter(indicDpName),this.setPlotter(plotter.getName(),plotter)),this.getArea(areaName).setChanged(!0),!0},ChartManager.prototype.setIndicator=function(areaName,indicName){var area=this.getArea(areaName);if(void 0==area||"main"==area.getNameObject().getCompAt(2))return!1;var dp=this.getDataProvider(areaName+".secondary");if(void 0==dp||!is_instance(dp,IndicatorDataProvider))return!1;var ret=this.createIndicatorAndRange(areaName,indicName);if(null==ret)return!1;var indic=ret.indic,range=ret.range;if(this.removeDataProvider(areaName+".main"),this.removePlotter(areaName+".main"),this.removeRange(areaName),this.removePlotter(areaName+"Range.decoration"),dp.setIndicator(indic),this.setRange(areaName,range),range.setPaddingTop(20),range.setPaddingBottom(4),range.setMinInterval(20),is_instance(indic,VOLUMEIndicator)){var plotter=new LastVolumePlotter(areaName+"Range.decoration");this.setPlotter(plotter.getName(),plotter)}else if(is_instance(indic,BOLLIndicator)||is_instance(indic,SARIndicator)){var dp=new MainDataProvider(areaName+".main");this.setDataProvider(dp.getName(),dp),dp.updateData();var plotter=new OHLCPlotter(areaName+".main");this.setPlotter(plotter.getName(),plotter)}return!0},ChartManager.prototype.removeMainIndicator=function(dsName){var areaName=dsName+".main",indicDpName=areaName+".secondary",indicDp=this.getDataProvider(indicDpName);void 0!=indicDp&&is_instance(indicDp,IndicatorDataProvider)&&(this.removeDataProvider(indicDpName),this.removePlotter(indicDpName),this.getArea(areaName).setChanged(!0))},ChartManager.prototype.removeIndicator=function(areaName){var area=this.getArea(areaName);if(void 0!=area&&"main"!=area.getNameObject().getCompAt(2)){var dp=this.getDataProvider(areaName+".secondary");if(void 0!=dp&&is_instance(dp,IndicatorDataProvider)){var rangeAreaName=areaName+"Range",rangeArea=this.getArea(rangeAreaName);if(void 0!=rangeArea){var tableLayout=this.getArea(area.getDataSourceName()+".charts");if(void 0!=tableLayout){tableLayout.removeArea(area),this.removeArea(areaName),tableLayout.removeArea(rangeArea),this.removeArea(rangeAreaName);for(var n in this._dataProviders)this._dataProviders[n].getAreaName()==areaName&&this.removeDataProvider(n);for(var n in this._ranges)this._ranges[n].getAreaName()==areaName&&this.removeRange(n);for(var n in this._plotters)this._plotters[n].getAreaName()==areaName&&this.removePlotter(n);for(var n in this._plotters)this._plotters[n].getAreaName()==rangeAreaName&&this.removePlotter(n)}}}}},ChartManager.prototype.getIndicatorParameters=function(indicName){var indic=this._fakeIndicators[indicName];if(void 0==indic){var ret=this.createIndicatorAndRange("",indicName);if(null==ret)return null;this._fakeIndicators[indicName]=indic=ret.indic}var i,params=[],cnt=indic.getParameterCount();for(i=0;i<cnt;i++)params.push(indic.getParameterAt(i));return params},ChartManager.prototype.setIndicatorParameters=function(indicName,params){var n,indic;for(n in this._dataProviders){var dp=this._dataProviders[n];0!=is_instance(dp,IndicatorDataProvider)&&(indic=dp.getIndicator(),indic.getName()==indicName&&(indic.setParameters(params),dp.refresh(),this.getArea(dp.getAreaName()).setChanged(!0)))}if(indic=this._fakeIndicators[indicName],void 0==indic){var ret=this.createIndicatorAndRange("",indicName,!0);if(null==ret)return;this._fakeIndicators[indicName]=indic=ret.indic}indic.setParameters(params)},ChartManager.prototype.getIndicatorAreaName=function(dsName,index){var tableLayout=this.getArea(dsName+".charts"),cnt=tableLayout.getAreaCount()>>1;return index<0||index>=cnt?"":tableLayout.getAreaAt(index<<1).getName()};var Timeline=create_class(NamedObject);Timeline._ItemWidth=[1,3,3,5,5,7,9,11,13,15,17,19,21,23,25,27,29],Timeline._SpaceWidth=[1,1,2,2,3,3,3,3,3,3,5,5,5,5,7,7,7],Timeline.PADDING_LEFT=4,Timeline.PADDING_RIGHT=8,Timeline.prototype.__construct=function(name){Timeline.__super.__construct.call(this,name),this._updated=!1,this._innerLeft=0,this._innerWidth=0,this._firstColumnLeft=0,this._scale=3,this._lastScale=-1,this._maxItemCount=0,this._maxIndex=0,this._firstIndex=-1,this._selectedIndex=-1,this._savedFirstIndex=-1},Timeline.prototype.isLatestShown=function(){return this.getLastIndex()==this._maxIndex},Timeline.prototype.isUpdated=function(){return this._updated},Timeline.prototype.setUpdated=function(v){this._updated=v},Timeline.prototype.getItemWidth=function(){return Timeline._ItemWidth[this._scale]},Timeline.prototype.getSpaceWidth=function(){return Timeline._SpaceWidth[this._scale]},Timeline.prototype.getColumnWidth=function(){return this.getSpaceWidth()+this.getItemWidth()},Timeline.prototype.getInnerWidth=function(){return this._innerWidth},Timeline.prototype.getItemLeftOffset=function(){return this.getSpaceWidth()},Timeline.prototype.getItemCenterOffset=function(){return this.getSpaceWidth()+(this.getItemWidth()>>1)},Timeline.prototype.getFirstColumnLeft=function(){return this._firstColumnLeft},Timeline.prototype.getMaxItemCount=function(){return this._maxItemCount},Timeline.prototype.getFirstIndex=function(){return this._firstIndex},Timeline.prototype.getLastIndex=function(){return Math.min(this._firstIndex+this._maxItemCount,this._maxIndex)},Timeline.prototype.getSelectedIndex=function(){return this._selectedIndex},Timeline.prototype.getMaxIndex=function(){return this._maxIndex},Timeline.prototype.calcColumnCount=function(w){return Math.floor(w/this.getColumnWidth())<<0},Timeline.prototype.calcFirstColumnLeft=function(maxItemCount){return this._innerLeft+this._innerWidth-this.getColumnWidth()*maxItemCount},Timeline.prototype.calcFirstIndexAlignRight=function(oldFirstIndex,oldMaxItemCount,newMaxItemCount){return Math.max(0,oldFirstIndex+Math.max(oldMaxItemCount,1)-Math.max(newMaxItemCount,1))},Timeline.prototype.calcFirstIndex=function(newMaxItemCount){return this.validateFirstIndex(this.calcFirstIndexAlignRight(this._firstIndex,this._maxItemCount,newMaxItemCount),newMaxItemCount)},Timeline.prototype.updateMaxItemCount=function(){var newFirstIndex,newMaxItemCount=this.calcColumnCount(this._innerWidth);if(this._maxItemCount<1)newFirstIndex=this.calcFirstIndex(newMaxItemCount);else if(this._lastScale==this._scale)newFirstIndex=this.validateFirstIndex(this._firstIndex-(newMaxItemCount-this._maxItemCount));else{var focusedIndex=this._selectedIndex>=0?this._selectedIndex:this.getLastIndex()-1;newFirstIndex=this.validateFirstIndex(focusedIndex-Math.round((focusedIndex-this._firstIndex)*newMaxItemCount/this._maxItemCount))}this._lastScale=this._scale,this._firstIndex!=newFirstIndex&&(this._selectedIndex==this._firstIndex&&(this._selectedIndex=newFirstIndex),this._firstIndex=newFirstIndex,this._updated=!0),this._maxItemCount!=newMaxItemCount&&(this._maxItemCount=newMaxItemCount,this._updated=!0),this._firstColumnLeft=this.calcFirstColumnLeft(newMaxItemCount)},Timeline.prototype.validateFirstIndex=function(firstIndex,maxItemCount){if(this._maxIndex<1)return-1;if(firstIndex<0)return 0;var lastFirst=Math.max(0,this._maxIndex-1);return firstIndex>lastFirst?lastFirst:firstIndex},Timeline.prototype.validateSelectedIndex=function(){this._selectedIndex<this._firstIndex?this._selectedIndex=-1:this._selectedIndex>=this.getLastIndex()&&(this._selectedIndex=-1)},Timeline.prototype.onLayout=function(){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getDataSourceName()+".main");if(null!=area){this._innerLeft=area.getLeft()+Timeline.PADDING_LEFT;var w=Math.max(0,area.getWidth()-(Timeline.PADDING_LEFT+Timeline.PADDING_RIGHT));this._innerWidth!=w&&(this._innerWidth=w,this.updateMaxItemCount())}},Timeline.prototype.toIndex=function(x){return this._firstIndex+this.calcColumnCount(x-this._firstColumnLeft)},Timeline.prototype.toColumnLeft=function(index){return this._firstColumnLeft+this.getColumnWidth()*(index-this._firstIndex)},Timeline.prototype.toItemLeft=function(index){return this.toColumnLeft(index)+this.getItemLeftOffset()},Timeline.prototype.toItemCenter=function(index){return this.toColumnLeft(index)+this.getItemCenterOffset()},Timeline.prototype.selectAt=function(x){return this._selectedIndex=this.toIndex(x),this.validateSelectedIndex(),this._selectedIndex>=0},Timeline.prototype.unselect=function(){this._selectedIndex=-1},Timeline.prototype.update=function(){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName()),oldMaxIndex=this._maxIndex;switch(this._maxIndex=ds.getDataCount(),ds.getUpdateMode()){case DataSource.UpdateMode.Refresh:this._maxIndex<1?this._firstIndex=-1:this._firstIndex=Math.max(this._maxIndex-this._maxItemCount,0),this._selectedIndex=-1,this._updated=!0;break;case DataSource.UpdateMode.Append:var lastIndex=this.getLastIndex(),erasedCount=ds.getErasedCount();lastIndex<oldMaxIndex?erasedCount>0&&(this._firstIndex=Math.max(this._firstIndex-erasedCount,0),this._selectedIndex>=0&&(this._selectedIndex-=erasedCount,this.validateSelectedIndex()),this._updated=!0):lastIndex==oldMaxIndex&&(this._firstIndex+=this._maxIndex-oldMaxIndex,this._selectedIndex>=0&&(this._selectedIndex-=erasedCount,this.validateSelectedIndex()),this._updated=!0)}},Timeline.prototype.move=function(x){this.isLatestShown()&&ChartManager.getInstance().getArea(this.getDataSourceName()+".mainRange").setChanged(!0),this._firstIndex=this.validateFirstIndex(this._savedFirstIndex-this.calcColumnCount(x),this._maxItemCount),this._updated=!0,this._selectedIndex>=0&&this.validateSelectedIndex()},Timeline.prototype.startMove=function(){this._savedFirstIndex=this._firstIndex},Timeline.prototype.scale=function(s){this._scale+=s,this._scale<0?this._scale=0:this._scale>=Timeline._ItemWidth.length&&(this._scale=Timeline._ItemWidth.length-1),this.updateMaxItemCount(),this._selectedIndex>=0&&this.validateSelectedIndex()};var Range=create_class(NamedObject);Range.prototype.__construct=function(name){Range.__super.__construct.call(this,name),this._updated=!0,this._minValue=Number.MAX_VALUE,this._maxValue=-Number.MAX_VALUE,this._outerMinValue=Number.MAX_VALUE,this._outerMaxValue=-Number.MAX_VALUE,this._ratio=0,this._top=0,this._bottom=0,this._paddingTop=0,this._paddingBottom=0,this._minInterval=36,this._selectedPosition=-1,this._selectedValue=-Number.MAX_VALUE,this._gradations=[]},Range.prototype.isUpdated=function(){return this._updated},Range.prototype.setUpdated=function(v){this._updated=v},Range.prototype.getMinValue=function(){return this._minValue},Range.prototype.getMaxValue=function(){return this._maxValue},Range.prototype.getRange=function(){return this._maxValue-this._minValue},Range.prototype.getOuterMinValue=function(){return this._outerMinValue},Range.prototype.getOuterMaxValue=function(){return this._outerMaxValue},Range.prototype.getOuterRange=function(){return this._outerMaxValue-this._outerMinValue},Range.prototype.getHeight=function(){return Math.max(0,this._bottom-this._top)},Range.prototype.getGradations=function(){return this._gradations},Range.prototype.getMinInterval=function(){return this._minInterval},Range.prototype.setMinInterval=function(v){this._minInterval=v},Range.prototype.getSelectedPosition=function(){return this._selectedPosition>=0?this._selectedPosition:this._selectedValue>-Number.MAX_VALUE?this.toY(this._selectedValue):-1},Range.prototype.getSelectedValue=function(){if(this._selectedValue>-Number.MAX_VALUE)return this._selectedValue;var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName());return null==area?-Number.MAX_VALUE:this._selectedPosition<area.getTop()+12||this._selectedPosition>=area.getBottom()-4?-Number.MAX_VALUE:this.toValue(this._selectedPosition)},Range.prototype.setPaddingTop=function(p){this._paddingTop=p},Range.prototype.setPaddingBottom=function(p){this._paddingBottom=p},Range.prototype.toValue=function(y){return this._maxValue-(y-this._top)/this._ratio},Range.prototype.toY=function(value){return this._ratio>0?this._top+Math.floor((this._maxValue-value)*this._ratio+.5):this._top},Range.prototype.toHeight=function(value){return Math.floor(value*this._ratio+1.5)},Range.prototype.update=function(){for(var dp,min=Number.MAX_VALUE,max=-Number.MAX_VALUE,mgr=ChartManager.getInstance(),dpNames=[".main",".secondary"],i=0;i<dpNames.length;i++)dp=mgr.getDataProvider(this.getName()+dpNames[i]),null!=dp&&(min=Math.min(min,dp.getMinValue()),max=Math.max(max,dp.getMaxValue()));var r={min:min,max:max};this.preSetRange(r),this.setRange(r.min,r.max)},Range.prototype.select=function(v){this._selectedValue=v,this._selectedPosition=-1},Range.prototype.selectAt=function(y){this._selectedPosition=y,this._selectedValue=-Number.MAX_VALUE},Range.prototype.unselect=function(){this._selectedPosition=-1,this._selectedValue=-Number.MAX_VALUE},Range.prototype.preSetRange=function(r){r.min==r.max&&(r.min=-1,r.max=1)},Range.prototype.setRange=function(minValue,maxValue){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName());if(this._minValue!=minValue||this._maxValue!=maxValue||area.isChanged()){this._updated=!0,this._minValue=minValue,this._maxValue=maxValue,this._gradations=[];var top=area.getTop()+this._paddingTop,bottom=area.getBottom()-(this._paddingBottom+1);if(top>=bottom)return void(this._minValue=this._maxValue);if(this._top=top,this._bottom=bottom,!(this._maxValue>this._minValue))throw this._ratio=0,"data error: maxValue should be greater than minValue";this._ratio=(bottom-top)/(this._maxValue-this._minValue),this._outerMinValue=this.toValue(area.getBottom()),this._outerMaxValue=this.toValue(area.getTop()),this.updateGradations()}},Range.prototype.calcInterval=function(){var H=this.getHeight(),h=this.getMinInterval();H/h<=1&&(h=H>>1);for(var d=this.getRange(),i=0;i>-2&&Math.floor(d)<d;)d*=10,i--;for(var m,c;(c=Math.pow(10,i),m=c,!(this.toHeight(m)>h))&&(m=2*c,!(this.toHeight(m)>h))&&(m=5*c,!(this.toHeight(m)>h));i++);return m},Range.prototype.updateGradations=function(){this._gradations=[];var interval=this.calcInterval();if(!(interval<=0)){var v=Math.floor(this.getMaxValue()/interval)*interval;do this._gradations.push(v),v-=interval;while(v>this.getMinValue())}};var PositiveRange=create_class(Range);PositiveRange.prototype.__construct=function(name){PositiveRange.__super.__construct.call(this,name)},PositiveRange.prototype.preSetRange=function(r){r.min<0&&(r.min=0),r.max<0&&(r.max=0)};var ZeroBasedPositiveRange=create_class(Range);ZeroBasedPositiveRange.prototype.__construct=function(name){ZeroBasedPositiveRange.__super.__construct.call(this,name)},ZeroBasedPositiveRange.prototype.preSetRange=function(r){r.min=0,r.max<0&&(r.max=0)};var MainRange=create_class(Range);MainRange.prototype.__construct=function(name){MainRange.__super.__construct.call(this,name)},MainRange.prototype.preSetRange=function(r){var mgr=ChartManager.getInstance(),timeline=mgr.getTimeline(this.getDataSourceName()),dIndex=timeline.getMaxIndex()-timeline.getLastIndex();if(dIndex<25){var ds=mgr.getDataSource(this.getDataSourceName()),data=ds.getDataAt(ds.getDataCount()-1),d=(r.max-r.min)/4*(1-dIndex/25);r.min=Math.min(r.min,Math.max(data.low-d,0)),r.max=Math.max(r.max,data.high+d)}if(r.min>0){var a=r.max/r.min;if(a<1.012){var m=(r.max+r.min)/2;r.max=1.006*m,r.min=.994*m}else if(a<1.024){var m=(r.max+r.min)/2,c=a-1;r.max=m*(1+c),r.min=m*(1-c)}else if(a<1.048){var m=(r.max+r.min)/2;r.max=1.024*m,r.min=.976*m}}r.min<0&&(r.min=0),r.max<0&&(r.max=0)};var ZeroCenteredRange=create_class(Range);ZeroCenteredRange.prototype.__construct=function(name){ZeroCenteredRange.__super.__construct.call(this,name)},ZeroCenteredRange.prototype.calcInterval=function(area){var h=this.getMinInterval();if(area.getHeight()/h<2)return 0;var i,r=this.getRange();for(i=3;!(this.toHeight(r/i)<=h);i+=2);return i-=2,r/i},ZeroCenteredRange.prototype.updateGradations=function(){this._gradations=[];var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),interval=this.calcInterval(area);if(!(interval<=0)){var v=interval/2;do this._gradations.push(v),this._gradations.push(-v),v+=interval;while(v<=this.getMaxValue())}},ZeroCenteredRange.prototype.preSetRange=function(r){var abs=Math.max(Math.abs(r.min),Math.abs(r.max));r.min=-abs,r.max=abs};var PercentageRange=create_class(Range);PercentageRange.prototype.__construct=function(name){
PercentageRange.__super.__construct.call(this,name)},PercentageRange.prototype.updateGradations=function(){this._gradations=[];var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),interval=10,h=Math.floor(this.toHeight(interval));if(!(h<<2>area.getHeight())){var v=Math.ceil(this.getMinValue()/interval)*interval;if(0==v&&(v=0),h<<2<24){if(h<<1<8)return;do 20!=v&&80!=v||this._gradations.push(v),v+=interval;while(v<this.getMaxValue())}else do h<8?20!=v&&50!=v&&80!=v||this._gradations.push(v):0!=v&&20!=v&&50!=v&&80!=v&&100!=v||this._gradations.push(v),v+=interval;while(v<this.getMaxValue())}};var DataSource=create_class(NamedObject);DataSource.prototype.__construct=function(name){DataSource.__super.__construct.call(this,name)},DataSource.UpdateMode={DoNothing:0,Refresh:1,Update:2,Append:3},DataSource.prototype.getUpdateMode=function(){return this._updateMode},DataSource.prototype.setUpdateMode=function(mode){this._updateMode=mode},DataSource.prototype.getCacheSize=function(){return 0},DataSource.prototype.getDataCount=function(){return 0};var MainDataSource=create_class(DataSource);MainDataSource.prototype.__construct=function(name){MainDataSource.__super.__construct.call(this,name),this._erasedCount=0,this._dataItems=[],this._decimalDigits=0,this.toolManager=new CToolManager(name)},MainDataSource.prototype.getCacheSize=function(){return this._dataItems.length},MainDataSource.prototype.getDataCount=function(){return this._dataItems.length},MainDataSource.prototype.getUpdatedCount=function(){return this._updatedCount},MainDataSource.prototype.getAppendedCount=function(){return this._appendedCount},MainDataSource.prototype.getErasedCount=function(){return this._erasedCount},MainDataSource.prototype.getDecimalDigits=function(){return this._decimalDigits},MainDataSource.prototype.calcDecimalDigits=function(v){var str=""+v,i=str.indexOf(".");return i<0?0:str.length-1-i},MainDataSource.prototype.getLastDate=function(){var count=this.getDataCount();return count<1?-1:this.getDataAt(count-1).date},MainDataSource.prototype.getDataAt=function(index){return this._dataItems[index]},MainDataSource.prototype.update=function(data){return this.updateNew(data)},MainDataSource.prototype.updateNew=function(data){if(data.length<1)return this.setUpdateMode(DataSource.UpdateMode.DoNothing),!0;this._updatedCount=0,this._appendedCount=0,this._erasedCount=0;var d,n,e,i,cnt=data.length,len=this._dataItems.length;if(0===len){for(i=0;i<cnt;i++){for(e=data[i],n=1;n<=4;n++)d=this.calcDecimalDigits(e[n]),this._decimalDigits<d&&(this._decimalDigits=d);this._dataItems.push({date:e[0],open:e[1],high:e[2],low:e[3],close:e[4],volume:e[5]})}return this.setUpdateMode(DataSource.UpdateMode.Refresh),!0}var lastIndex=len-1,lastItem=this._dataItems[lastIndex],lastItemFound=!1,lastItemUpdated=!1;for(i=0;i<cnt;i++)if(e=data[i],e[0]==lastItem.date){lastItemFound=!0;var isAllTheSame=lastItem.open==e[1]&&lastItem.high==e[2]&&lastItem.low==e[3]&&lastItem.close==e[4]&&lastItem.volume==e[5];isAllTheSame||(this._dataItems[lastIndex]={date:e[0],open:e[1],high:e[2],low:e[3],close:e[4],volume:e[5]},this._updatedCount++,lastItemUpdated=!0);break}var appendData=[];if(lastItemFound)i<cnt-1&&(appendData=data.slice(i+1));else{if(data[cnt-1][0]<lastItem.date)return this.setUpdateMode(DataSource.UpdateMode.DoNothing),!1;appendData=data}if(appendData.length>0){for(i=0;i<appendData.length;i++)e=appendData[i],this._dataItems.push({date:e[0],open:e[1],high:e[2],low:e[3],close:e[4],volume:e[5]}),this._appendedCount++;return this.setUpdateMode(DataSource.UpdateMode.Append),!0}return lastItemFound&&!lastItemUpdated?(this.setUpdateMode(DataSource.UpdateMode.DoNothing),!0):lastItemUpdated?(this.setUpdateMode(DataSource.UpdateMode.Update),!0):(this.setUpdateMode(DataSource.UpdateMode.DoNothing),!1)},MainDataSource.prototype.select=function(id){this.toolManager.selecedObject=id},MainDataSource.prototype.unselect=function(){this.toolManager.selecedObject=-1},MainDataSource.prototype.addToolObject=function(toolObject){this.toolManager.addToolObject(toolObject)},MainDataSource.prototype.delToolObject=function(){this.toolManager.delCurrentObject()},MainDataSource.prototype.getToolObject=function(index){return this.toolManager.getToolObject(index)},MainDataSource.prototype.getToolObjectCount=function(){return this.toolManager.toolObjects.length},MainDataSource.prototype.getCurrentToolObject=function(){return this.toolManager.getCurrentObject()},MainDataSource.prototype.getSelectToolObjcet=function(){return this.toolManager.getSelectedObject()},MainDataSource.prototype.delSelectToolObject=function(){this.toolManager.delSelectedObject()};var DataProvider=create_class(NamedObject);DataProvider.prototype.__construct=function(name){DataProvider.__super.__construct.call(this,name),this._minValue=0,this._maxValue=0,this._minValueIndex=-1,this._maxValueIndex=-1},DataProvider.prototype.getMinValue=function(){return this._minValue},DataProvider.prototype.getMaxValue=function(){return this._maxValue},DataProvider.prototype.getMinValueIndex=function(){return this._minValueIndex},DataProvider.prototype.getMaxValueIndex=function(){return this._maxValueIndex},DataProvider.prototype.calcRange=function(firstIndexes,lastIndex,minmaxes,indexes){for(var min=Number.MAX_VALUE,max=-Number.MAX_VALUE,minIndex=-1,maxIndex=-1,minmax={},i=lastIndex-1,n=firstIndexes.length-1;n>=0;n--){var first=firstIndexes[n];if(i<first)minmaxes[n]={min:min,max:max};else{for(;i>=first;i--)0!=this.getMinMaxAt(i,minmax)&&(min>minmax.min&&(min=minmax.min,minIndex=i),max<minmax.max&&(max=minmax.max,maxIndex=i));minmaxes[n]={min:min,max:max}}null!=indexes&&(indexes[n]={minIndex:minIndex,maxIndex:maxIndex})}},DataProvider.prototype.updateRange=function(){var mgr=ChartManager.getInstance(),timeline=mgr.getTimeline(this.getDataSourceName()),firstIndexes=[timeline.getFirstIndex()],minmaxes=[{}],indexes=[{}];this.calcRange(firstIndexes,timeline.getLastIndex(),minmaxes,indexes),this._minValue=minmaxes[0].min,this._maxValue=minmaxes[0].max,this._minValueIndex=indexes[0].minIndex,this._maxValueIndex=indexes[0].maxIndex};var MainDataProvider=create_class(DataProvider);MainDataProvider.prototype.__construct=function(name){MainDataProvider.__super.__construct.call(this,name),this._candlestickDS=null},MainDataProvider.prototype.updateData=function(){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName());is_instance(ds,MainDataSource)&&(this._candlestickDS=ds)},MainDataProvider.prototype.getMinMaxAt=function(index,minmax){var data=this._candlestickDS.getDataAt(index);return minmax.min=data.low,minmax.max=data.high,!0};var IndicatorDataProvider=create_class(DataProvider);IndicatorDataProvider.prototype.getIndicator=function(){return this._indicator},IndicatorDataProvider.prototype.setIndicator=function(v){this._indicator=v,this.refresh()},IndicatorDataProvider.prototype.refresh=function(){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName());if(!(ds.getDataCount()<1)){var i,indic=this._indicator,last=ds.getDataCount();for(indic.clear(),indic.reserve(last),i=0;i<last;i++)indic.execute(ds,i)}},IndicatorDataProvider.prototype.updateData=function(){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName());if(!(ds.getDataCount()<1)){var indic=this._indicator,mode=ds.getUpdateMode();switch(mode){case DataSource.UpdateMode.Refresh:this.refresh();break;case DataSource.UpdateMode.Append:indic.reserve(ds.getAppendedCount());case DataSource.UpdateMode.Update:var i,last=ds.getDataCount(),cnt=ds.getUpdatedCount()+ds.getAppendedCount();for(i=last-cnt;i<last;i++)indic.execute(ds,i)}}},IndicatorDataProvider.prototype.getMinMaxAt=function(index,minmax){minmax.min=Number.MAX_VALUE,minmax.max=-Number.MAX_VALUE;var result,i,valid=!1,cnt=this._indicator.getOutputCount();for(i=0;i<cnt;i++)result=this._indicator.getOutputAt(i).execute(index),0==isNaN(result)&&(valid=!0,minmax.min>result&&(minmax.min=result),minmax.max<result&&(minmax.max=result));return valid};var theme_color_id=0,theme_font_id=0,Theme=create_class();Theme.prototype.getColor=function(which){return this._colors[which]},Theme.prototype.getFont=function(which){return this._fonts[which]},Theme.Color={Positive:theme_color_id++,Negative:theme_color_id++,PositiveDark:theme_color_id++,NegativeDark:theme_color_id++,Unchanged:theme_color_id++,Background:theme_color_id++,Cursor:theme_color_id++,RangeMark:theme_color_id++,Indicator0:theme_color_id++,Indicator1:theme_color_id++,Indicator2:theme_color_id++,Indicator3:theme_color_id++,Grid0:theme_color_id++,Grid1:theme_color_id++,Grid2:theme_color_id++,Grid3:theme_color_id++,Grid4:theme_color_id++,TextPositive:theme_color_id++,TextNegative:theme_color_id++,Text0:theme_color_id++,Text1:theme_color_id++,Text2:theme_color_id++,Text3:theme_color_id++,Text4:theme_color_id++,LineColorNormal:theme_color_id++,LineColorSelected:theme_color_id++,CircleColorFill:theme_color_id++,CircleColorStroke:theme_color_id++},Theme.Font={Default:theme_font_id++};var DarkTheme=create_class(Theme);DarkTheme.prototype.__construct=function(){this._colors=[],this._colors[Theme.Color.Positive]="#19b34c",this._colors[Theme.Color.Negative]="#b33120",this._colors[Theme.Color.PositiveDark]="#004718",this._colors[Theme.Color.NegativeDark]="#3b0e08",this._colors[Theme.Color.Unchanged]="#fff",this._colors[Theme.Color.Background]="#0a0a0a",this._colors[Theme.Color.Cursor]="#aaa",this._colors[Theme.Color.RangeMark]="#f9ee30",this._colors[Theme.Color.Indicator0]="#ddd",this._colors[Theme.Color.Indicator1]="#f9ee30",this._colors[Theme.Color.Indicator2]="#f600ff",this._colors[Theme.Color.Indicator3]="#6bf",this._colors[Theme.Color.Grid0]="#333",this._colors[Theme.Color.Grid1]="#444",this._colors[Theme.Color.Grid2]="#666",this._colors[Theme.Color.Grid3]="#888",this._colors[Theme.Color.Grid4]="#aaa",this._colors[Theme.Color.TextPositive]="#1bd357",this._colors[Theme.Color.TextNegative]="#ff6f5e",this._colors[Theme.Color.Text0]="#444",this._colors[Theme.Color.Text1]="#666",this._colors[Theme.Color.Text2]="#888",this._colors[Theme.Color.Text3]="#aaa",this._colors[Theme.Color.Text4]="#ccc",this._colors[Theme.Color.LineColorNormal]="#a6a6a6",this._colors[Theme.Color.LineColorSelected]="#ffffff",this._colors[Theme.Color.CircleColorFill]="#000000",this._colors[Theme.Color.CircleColorStroke]="#ffffff",this._fonts=[],this._fonts[Theme.Font.Default]="12px Tahoma"};var LightTheme=create_class(Theme);LightTheme.prototype.__construct=function(){this._colors=[],this._colors[Theme.Color.Positive]="#53b37b",this._colors[Theme.Color.Negative]="#db5542",this._colors[Theme.Color.PositiveDark]="#66d293",this._colors[Theme.Color.NegativeDark]="#ffadaa",this._colors[Theme.Color.Unchanged]="#fff",this._colors[Theme.Color.Background]="#fff",this._colors[Theme.Color.Cursor]="#aaa",this._colors[Theme.Color.RangeMark]="#f27935",this._colors[Theme.Color.Indicator0]="#2fd2b2",this._colors[Theme.Color.Indicator1]="#ffb400",this._colors[Theme.Color.Indicator2]="#e849b9",this._colors[Theme.Color.Indicator3]="#1478c8",this._colors[Theme.Color.Grid0]="#eee",this._colors[Theme.Color.Grid1]="#afb1b3",this._colors[Theme.Color.Grid2]="#ccc",this._colors[Theme.Color.Grid3]="#bbb",this._colors[Theme.Color.Grid4]="#aaa",this._colors[Theme.Color.TextPositive]="#53b37b",this._colors[Theme.Color.TextNegative]="#db5542",this._colors[Theme.Color.Text0]="#ccc",this._colors[Theme.Color.Text1]="#aaa",this._colors[Theme.Color.Text2]="#888",this._colors[Theme.Color.Text3]="#666",this._colors[Theme.Color.Text4]="#444",this._colors[Theme.Color.LineColorNormal]="#8c8c8c",this._colors[Theme.Color.LineColorSelected]="#393c40",this._colors[Theme.Color.CircleColorFill]="#ffffff",this._colors[Theme.Color.CircleColorStroke]="#393c40",this._fonts=[],this._fonts[Theme.Font.Default]="12px Tahoma"};var TemplateMeasuringHandler=create_class();TemplateMeasuringHandler.onMeasuring=function(sender,args){var width=args.Width,areaName=(args.Height,sender.getNameObject().getCompAt(2));"timeline"==areaName&&sender.setMeasuredDimension(width,22)};var Template=create_class();Template.displayVolume=!0,Template.createCandlestickDataSource=function(dsAlias){return new MainDataSource(dsAlias)},Template.createLiveOrderDataSource=function(dsAlias){return new CLiveOrderDataSource(dsAlias)},Template.createLiveTradeDataSource=function(dsAlias){return new CLiveTradeDataSource(dsAlias)},Template.createDataSource=function(dsName,dsAlias,createFunc){var mgr=ChartManager.getInstance();null==mgr.getCachedDataSource(dsAlias)&&mgr.setCachedDataSource(dsAlias,createFunc(dsAlias)),mgr.setCurrentDataSource(dsName,dsAlias),mgr.updateData(dsName,null)},Template.createTableComps=function(dsName){Template.createMainChartComps(dsName),Template.displayVolume&&Template.createIndicatorChartComps(dsName,"VOLUME"),Template.createTimelineComps(dsName)},Template.createMainChartComps=function(dsName){var mgr=ChartManager.getInstance(),tableLayout=mgr.getArea(dsName+".charts"),areaName=dsName+".main",rangeAreaName=areaName+"Range",area=new MainArea(areaName);mgr.setArea(areaName,area),tableLayout.addArea(area);var rangeArea=new MainRangeArea(rangeAreaName);mgr.setArea(rangeAreaName,rangeArea),tableLayout.addArea(rangeArea);var dp=new MainDataProvider(areaName+".main");mgr.setDataProvider(dp.getName(),dp),mgr.setMainIndicator(dsName,"MA");var range=new MainRange(areaName);mgr.setRange(range.getName(),range),range.setPaddingTop(28),range.setPaddingBottom(12);var plotter=new MainAreaBackgroundPlotter(areaName+".background");mgr.setPlotter(plotter.getName(),plotter),plotter=new CGridPlotter(areaName+".grid"),mgr.setPlotter(plotter.getName(),plotter),plotter=new CandlestickPlotter(areaName+".main"),mgr.setPlotter(plotter.getName(),plotter),plotter=new MinMaxPlotter(areaName+".decoration"),mgr.setPlotter(plotter.getName(),plotter),plotter=new MainInfoPlotter(areaName+".info"),mgr.setPlotter(plotter.getName(),plotter),plotter=new SelectionPlotter(areaName+".selection"),mgr.setPlotter(plotter.getName(),plotter),plotter=new CDynamicLinePlotter(areaName+".tool"),mgr.setPlotter(plotter.getName(),plotter),plotter=new RangeAreaBackgroundPlotter(areaName+"Range.background"),mgr.setPlotter(plotter.getName(),plotter),plotter=new COrderGraphPlotter(areaName+"Range.grid"),mgr.setPlotter(plotter.getName(),plotter),plotter=new RangePlotter(areaName+"Range.main"),mgr.setPlotter(plotter.getName(),plotter),plotter=new RangeSelectionPlotter(areaName+"Range.selection"),mgr.setPlotter(plotter.getName(),plotter),plotter=new LastClosePlotter(areaName+"Range.decoration"),mgr.setPlotter(plotter.getName(),plotter)},Template.createIndicatorChartComps=function(dsName,indicName){var mgr=ChartManager.getInstance(),tableLayout=mgr.getArea(dsName+".charts"),areaName=dsName+".indic"+tableLayout.getNextRowId(),rangeAreaName=areaName+"Range",area=new IndicatorArea(areaName);mgr.setArea(areaName,area),tableLayout.addArea(area);var rowIndex=tableLayout.getAreaCount()>>1,heights=ChartSettings.get().charts.areaHeight;if(heights.length>rowIndex){var a,i;for(i=0;i<rowIndex;i++)a=tableLayout.getAreaAt(i<<1),a.setTop(0),a.setBottom(heights[i]);area.setTop(0),area.setBottom(heights[rowIndex])}var rangeArea=new IndicatorRangeArea(rangeAreaName);mgr.setArea(rangeAreaName,rangeArea),tableLayout.addArea(rangeArea);var dp=new IndicatorDataProvider(areaName+".secondary");if(mgr.setDataProvider(dp.getName(),dp),0==mgr.setIndicator(areaName,indicName))return void mgr.removeIndicator(areaName);var plotter=new MainAreaBackgroundPlotter(areaName+".background");mgr.setPlotter(plotter.getName(),plotter),plotter=new CGridPlotter(areaName+".grid"),mgr.setPlotter(plotter.getName(),plotter),plotter=new IndicatorPlotter(areaName+".secondary"),mgr.setPlotter(plotter.getName(),plotter),plotter=new IndicatorInfoPlotter(areaName+".info"),mgr.setPlotter(plotter.getName(),plotter),plotter=new SelectionPlotter(areaName+".selection"),mgr.setPlotter(plotter.getName(),plotter),plotter=new RangeAreaBackgroundPlotter(areaName+"Range.background"),mgr.setPlotter(plotter.getName(),plotter),plotter=new RangePlotter(areaName+"Range.main"),mgr.setPlotter(plotter.getName(),plotter),plotter=new RangeSelectionPlotter(areaName+"Range.selection"),mgr.setPlotter(plotter.getName(),plotter)},Template.createTimelineComps=function(dsName){var plotter,mgr=ChartManager.getInstance(),timeline=new Timeline(dsName);mgr.setTimeline(timeline.getName(),timeline),plotter=new TimelineAreaBackgroundPlotter(dsName+".timeline.background"),mgr.setPlotter(plotter.getName(),plotter),plotter=new TimelinePlotter(dsName+".timeline.main"),mgr.setPlotter(plotter.getName(),plotter),plotter=new TimelineSelectionPlotter(dsName+".timeline.selection"),mgr.setPlotter(plotter.getName(),plotter)},Template.createLiveOrderComps=function(dsName){var plotter,mgr=ChartManager.getInstance();plotter=new BackgroundPlotter(dsName+".main.background"),mgr.setPlotter(plotter.getName(),plotter),plotter=new CLiveOrderPlotter(dsName+".main.main"),mgr.setPlotter(plotter.getName(),plotter)},Template.createLiveTradeComps=function(dsName){var plotter,mgr=ChartManager.getInstance();plotter=new BackgroundPlotter(dsName+".main.background"),mgr.setPlotter(plotter.getName(),plotter),plotter=new CLiveTradePlotter(dsName+".main.main"),mgr.setPlotter(plotter.getName(),plotter)};var DefaultTemplate=create_class(Template);DefaultTemplate.loadTemplate=function(dsName,dsAlias,dsNameOrder,dsAliasOrder,dsNameTrade,dsAliasTrade){var mgr=ChartManager.getInstance(),settings=ChartSettings.get(),frameName=new CName(dsName).getCompAt(0);mgr.unloadTemplate(frameName),Template.createDataSource(dsName,dsAlias,Template.createCandlestickDataSource);var frame=new DockableLayout(frameName);mgr.setFrame(frame.getName(),frame),mgr.setArea(frame.getName(),frame),frame.setGridColor(Theme.Color.Grid1);var area=new TimelineArea(dsName+".timeline");mgr.setArea(area.getName(),area),frame.addArea(area),area.setDockStyle(ChartArea.DockStyle.Bottom),area.Measuring.addHandler(area,TemplateMeasuringHandler.onMeasuring);var tableLayout=new TableLayout(dsName+".charts");return mgr.setArea(tableLayout.getName(),tableLayout),tableLayout.setDockStyle(ChartArea.DockStyle.Fill),frame.addArea(tableLayout),Template.createTableComps(dsName),mgr.setThemeName(frameName,settings.theme),mgr};var Plotter=create_class(NamedObject);Plotter.prototype.__construct=function(name){Plotter.__super.__construct.call(this,name)},Plotter.isChrome=null!=navigator.userAgent.toLowerCase().match(/chrome/),Plotter.drawLine=function(context,x1,y1,x2,y2){context.beginPath(),context.moveTo((x1<<0)+.5,(y1<<0)+.5),context.lineTo((x2<<0)+.5,(y2<<0)+.5),context.stroke()},Plotter.drawLines=function(context,points){var i,cnt=points.length;for(context.beginPath(),context.moveTo(points[0].x,points[0].y),i=1;i<cnt;i++)context.lineTo(points[i].x,points[i].y);if(Plotter.isChrome)for(context.moveTo(points[0].x,points[0].y),i=1;i<cnt;i++)context.lineTo(points[i].x,points[i].y);context.stroke()},Plotter.drawDashedLine=function(context,x1,y1,x2,y2,dashLen,dashSolid){dashLen<2&&(dashLen=2);var dX=x2-x1,dY=y2-y1;if(context.beginPath(),0==dY){for(var count=dX/dashLen+.5<<0,i=0;i<count;i++)context.rect(x1,y1,dashSolid,1),x1+=dashLen;context.fill()}else{var count=Math.sqrt(dX*dX+dY*dY)/dashLen+.5<<0;dX/=count,dY/=count;for(var dashX=dX*dashSolid/dashLen,dashY=dY*dashSolid/dashLen,i=0;i<count;i++)context.moveTo(x1+.5,y1+.5),context.lineTo(x1+.5+dashX,y1+.5+dashY),x1+=dX,y1+=dY;context.stroke()}},Plotter.createHorzDashedLine=function(context,x1,x2,y,dashLen,dashSolid){dashLen<2&&(dashLen=2);for(var dX=x2-x1,count=dX/dashLen+.5<<0,i=0;i<count;i++)context.rect(x1,y,dashSolid,1),x1+=dashLen},Plotter.createRectangles=function(context,rects){context.beginPath();var e,i,cnt=rects.length;for(i=0;i<cnt;i++)e=rects[i],context.rect(e.x,e.y,e.w,e.h)},Plotter.createPolygon=function(context,points){context.beginPath(),context.moveTo(points[0].x+.5,points[0].y+.5);var i,cnt=points.length;for(i=1;i<cnt;i++)context.lineTo(points[i].x+.5,points[i].y+.5);context.closePath()},Plotter.drawString=function(context,str,rect){var w=context.measureText(str).width;return!(rect.w<w)&&(context.fillText(str,rect.x,rect.y),rect.x+=w,rect.w-=w,!0)};var BackgroundPlotter=create_class(Plotter);BackgroundPlotter.prototype.__construct=function(name){BackgroundPlotter.__super.__construct.call(this,name),this._color=Theme.Color.Background},BackgroundPlotter.prototype.getColor=function(){return this._color},BackgroundPlotter.prototype.setColor=function(c){this._color=c},BackgroundPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName());mgr.getTheme(this.getFrameName());context.fillStyle="transparent",context.fillRect(area.getLeft(),area.getTop(),area.getWidth(),area.getHeight())};var MainAreaBackgroundPlotter=create_class(BackgroundPlotter);MainAreaBackgroundPlotter.prototype.__construct=function(name){MainAreaBackgroundPlotter.__super.__construct.call(this,name)},MainAreaBackgroundPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),range=mgr.getRange(this.getAreaName()),rect=(mgr.getTheme(this.getFrameName()),area.getRect());if(!area.isChanged()&&!timeline.isUpdated()&&!range.isUpdated()){var first=timeline.getFirstIndex(),last=timeline.getLastIndex()-2,start=Math.max(first,last);rect.X=timeline.toColumnLeft(start),rect.Width=area.getRight()-rect.X}context.fillStyle="transparent",context.fillRect(rect.X,rect.Y,rect.Width,rect.Height)};var RangeAreaBackgroundPlotter=create_class(BackgroundPlotter);RangeAreaBackgroundPlotter.prototype.__construct=function(name){RangeAreaBackgroundPlotter.__super.__construct.call(this,name)},RangeAreaBackgroundPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),areaName=this.getAreaName(),area=mgr.getArea(areaName),range=mgr.getRange(areaName.substring(0,areaName.lastIndexOf("Range"))),isMainRange="main"==range.getNameObject().getCompAt(2);if(isMainRange);else if(!area.isChanged()&&!range.isUpdated())return;var theme=mgr.getTheme(this.getFrameName());context.fillStyle=theme.getColor(this._color),context.fillRect(area.getLeft(),area.getTop(),area.getWidth(),area.getHeight())};var TimelineAreaBackgroundPlotter=create_class(BackgroundPlotter);TimelineAreaBackgroundPlotter.prototype.__construct=function(name){TimelineAreaBackgroundPlotter.__super.__construct.call(this,name)},TimelineAreaBackgroundPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName());if(area.isChanged()||timeline.isUpdated()){var theme=mgr.getTheme(this.getFrameName());context.fillStyle=theme.getColor(this._color),context.fillRect(area.getLeft(),area.getTop(),area.getWidth(),area.getHeight())}};var CGridPlotter=create_class(NamedObject);CGridPlotter.prototype.__construct=function(name){CGridPlotter.__super.__construct.call(this,name)},CGridPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),range=mgr.getRange(this.getAreaName()),clipped=!1;if(!area.isChanged()&&!timeline.isUpdated()&&!range.isUpdated()){var first=timeline.getFirstIndex(),last=timeline.getLastIndex(),start=Math.max(first,last-2),left=timeline.toColumnLeft(start);context.save(),context.rect(left,area.getTop(),area.getRight()-left,area.getHeight()),context.clip(),clipped=!0}var theme=mgr.getTheme(this.getFrameName());context.fillStyle=theme.getColor(Theme.Color.Grid0),context.beginPath();var dashLen=12,dashSolid=3;Plotter.isChrome&&(dashLen=4,dashSolid=1);var gradations=range.getGradations();for(var n in gradations)Plotter.createHorzDashedLine(context,area.getLeft(),area.getRight(),range.toY(gradations[n]),dashLen,dashSolid);context.fill(),clipped&&context.restore()};var CandlestickPlotter=create_class(NamedObject);CandlestickPlotter.prototype.__construct=function(name){CandlestickPlotter.__super.__construct.call(this,name)},CandlestickPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName());if(!(ds.getDataCount()<1)){var area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),range=mgr.getRange(this.getAreaName());if(0!=range.getRange()){var start,theme=mgr.getTheme(this.getFrameName()),dark=is_instance(theme,DarkTheme),first=timeline.getFirstIndex(),last=timeline.getLastIndex();start=area.isChanged()||timeline.isUpdated()||range.isUpdated()?first:Math.max(first,last-2);for(var cW=timeline.getColumnWidth(),iW=timeline.getItemWidth(),left=timeline.toItemLeft(start),center=timeline.toItemCenter(start),strokePosRects=[],fillPosRects=[],fillUchRects=[],fillNegRects=[],i=start;i<last;i++){var data=ds.getDataAt(i),high=range.toY(data.high),low=range.toY(data.low),open=data.open,close=data.close;if(close>open){var top=range.toY(close),bottom=range.toY(open),iH=Math.max(bottom-top,1);iH>1&&iW>1&&dark?strokePosRects.push({x:left+.5,y:top+.5,w:iW-1,h:iH-1}):fillPosRects.push({x:left,y:top,w:Math.max(iW,1),h:Math.max(iH,1)}),data.high>close&&(high=Math.min(high,top-1),fillPosRects.push({x:center,y:high,w:1,h:top-high})),open>data.low&&(low=Math.max(low,bottom+1),fillPosRects.push({x:center,y:bottom,w:1,h:low-bottom}))}else if(close==open){var top=range.toY(close);fillUchRects.push({x:left,y:top,w:Math.max(iW,1),h:1}),data.high>close&&(high=Math.min(high,top-1)),open>data.low&&(low=Math.max(low,top+1)),high<low&&fillUchRects.push({x:center,y:high,w:1,h:low-high})}else{var top=range.toY(open),bottom=range.toY(close),iH=Math.max(bottom-top,1);fillNegRects.push({x:left,y:top,w:Math.max(iW,1),h:Math.max(iH,1)}),data.high>open&&(high=Math.min(high,top-1)),close>data.low&&(low=Math.max(low,bottom+1)),high<low&&fillNegRects.push({x:center,y:high,w:1,h:low-high})}left+=cW,center+=cW}strokePosRects.length>0&&(context.strokeStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,strokePosRects),context.stroke()),fillPosRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,fillPosRects),context.fill()),fillUchRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillUchRects),context.fill()),fillNegRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillNegRects),context.fill())}}};var CandlestickHLCPlotter=create_class(Plotter);CandlestickHLCPlotter.prototype.__construct=function(name){CandlestickHLCPlotter.__super.__construct.call(this,name)},CandlestickHLCPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName());if(is_instance(ds,MainDataSource)&&!(ds.getDataCount()<1)){var area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),range=mgr.getRange(this.getAreaName());if(0!=range.getRange()){var start,theme=mgr.getTheme(this.getFrameName()),dark=is_instance(theme,DarkTheme),first=timeline.getFirstIndex(),last=timeline.getLastIndex();start=area.isChanged()||timeline.isUpdated()||range.isUpdated()?first:Math.max(first,last-2);for(var cW=timeline.getColumnWidth(),iW=timeline.getItemWidth(),left=timeline.toItemLeft(start),center=timeline.toItemCenter(start),strokePosRects=[],fillPosRects=[],fillUchRects=[],fillNegRects=[],i=start;i<last;i++){var data=ds.getDataAt(i),high=range.toY(data.high),low=range.toY(data.low),open=data.open;i>0&&(open=ds.getDataAt(i-1).close);var close=data.close;if(close>open){var top=range.toY(close),bottom=range.toY(open),iH=Math.max(bottom-top,1);iH>1&&iW>1&&dark?strokePosRects.push({x:left+.5,y:top+.5,w:iW-1,h:iH-1}):fillPosRects.push({x:left,y:top,w:Math.max(iW,1),h:Math.max(iH,1)}),data.high>close&&(high=Math.min(high,top-1),fillPosRects.push({x:center,y:high,w:1,h:top-high})),open>data.low&&(low=Math.max(low,bottom+1),fillPosRects.push({x:center,y:bottom,w:1,h:low-bottom}))}else if(close==open){var top=range.toY(close);fillUchRects.push({x:left,y:top,w:Math.max(iW,1),h:1}),data.high>close&&(high=Math.min(high,top-1)),open>data.low&&(low=Math.max(low,top+1)),high<low&&fillUchRects.push({x:center,y:high,w:1,h:low-high})}else{var top=range.toY(open),bottom=range.toY(close),iH=Math.max(bottom-top,1);fillNegRects.push({x:left,y:top,w:Math.max(iW,1),h:Math.max(iH,1)}),data.high>open&&(high=Math.min(high,top-1)),close>data.low&&(low=Math.max(low,bottom+1)),high<low&&fillNegRects.push({x:center,y:high,w:1,h:low-high})}left+=cW,center+=cW}strokePosRects.length>0&&(context.strokeStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,strokePosRects),context.stroke()),fillPosRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,fillPosRects),context.fill()),fillUchRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillUchRects),context.fill()),fillNegRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillNegRects),context.fill())}}};var OHLCPlotter=create_class(Plotter);OHLCPlotter.prototype.__construct=function(name){OHLCPlotter.__super.__construct.call(this,name)},OHLCPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName());if(is_instance(ds,MainDataSource)&&!(ds.getDataCount()<1)){var area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),range=mgr.getRange(this.getAreaName());if(0!=range.getRange()){var start,theme=mgr.getTheme(this.getFrameName()),first=timeline.getFirstIndex(),last=timeline.getLastIndex();start=area.isChanged()||timeline.isUpdated()||range.isUpdated()?first:Math.max(first,last-2);for(var cW=timeline.getColumnWidth(),iW=(timeline.getItemWidth()>>1)+1,left=timeline.toItemLeft(start)-1,center=timeline.toItemCenter(start),right=center+1,fillPosRects=[],fillUchRects=[],fillNegRects=[],i=start;i<last;i++){var data=ds.getDataAt(i),high=range.toY(data.high),low=range.toY(data.low),iH=Math.max(low-high,1);if(data.close>data.open){var top=range.toY(data.close),bottom=range.toY(data.open);fillPosRects.push({x:center,y:high,w:1,h:iH}),fillPosRects.push({x:left,y:bottom,w:iW,h:1}),fillPosRects.push({x:right,y:top,w:iW,h:1})}else if(data.close==data.open){var y=range.toY(data.close);fillUchRects.push({x:center,y:high,w:1,h:iH}),fillUchRects.push({x:left,y:y,w:iW,h:1}),fillUchRects.push({x:right,y:y,w:iW,h:1})}else{var top=range.toY(data.open),bottom=range.toY(data.close);fillNegRects.push({x:center,y:high,w:1,h:iH}),fillNegRects.push({x:left,y:top,w:iW,h:1}),fillNegRects.push({x:right,y:bottom,w:iW,h:1})}left+=cW,center+=cW,right+=cW}fillPosRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,fillPosRects),context.fill()),fillUchRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillUchRects),context.fill()),fillNegRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillNegRects),context.fill())}}};var MainInfoPlotter=create_class(Plotter);MainInfoPlotter._dsAliasToString={"01w":"周线","03d":"3天线","01d":"日线","12h":"12小时","06h":"6小时","04h":"4小时","02h":"2小时","01h":"1小时","30m":"30分钟","15m":"15分钟","05m":"5分钟","03m":"3分钟","01m":"1分钟"},MainInfoPlotter._dsAliasToString2={"01w":"1w","03d":"3d","01d":"1d","12h":"12h","06h":"6h","04h":"4h","02h":"2h","01h":"1h","30m":"30m","15m":"15m","05m":"5m","03m":"3m","01m":"1m"},MainInfoPlotter._dsAliasToString_zh_tw={"01w":"周線","03d":"3天線","01d":"日線","12h":"12小時","06h":"6小時","04h":"4小時","02h":"2小時","01h":"1小時","30m":"30分鐘","15m":"15分鐘","05m":"5分鐘","03m":"3分鐘","01m":"1分鐘"},MainInfoPlotter.prototype.__construct=function(name){
MainInfoPlotter.__super.__construct.call(this,name)},MainInfoPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),ds=mgr.getDataSource(this.getDataSourceName()),theme=mgr.getTheme(this.getFrameName());context.font=theme.getFont(Theme.Font.Default),context.textAlign="left",context.textBaseline="top",context.fillStyle=theme.getColor(Theme.Color.Text4);var rect={x:area.getLeft()+4,y:area.getTop()+2,w:area.getWidth()-8,h:20},selIndex=timeline.getSelectedIndex();if(!(selIndex<0)){var data=ds.getDataAt(selIndex),lastData=ds.getDataAt(selIndex-1)||data,digits=ds.getDecimalDigits(),time=new Date(data.date),year=time.getFullYear(),month=format_time(time.getMonth()+1),date=format_time(time.getDate()),hour=format_time(time.getHours()),minute=format_time(time.getMinutes()),lang=mgr.getLanguage();if("zh-cn"==lang){if(!Plotter.drawString(context,"时间: "+year+"-"+month+"-"+date+"  "+hour+":"+minute,rect))return;if(!Plotter.drawString(context,"  开: "+data.open.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  高: "+data.high.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  低: "+data.low.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  收: "+data.close.toFixed(GLOBAL_VAR.digits),rect))return}else if("en-us"==lang){if(!Plotter.drawString(context,"DATE: "+year+"-"+month+"-"+date+"  "+hour+":"+minute,rect))return;if(!Plotter.drawString(context,"  O: "+data.open.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  H: "+data.high.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  L: "+data.low.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  C: "+data.close.toFixed(GLOBAL_VAR.digits),rect))return}else if("zh-tw"==lang){if(!Plotter.drawString(context,"時間: "+year+"-"+month+"-"+date+"  "+hour+":"+minute,rect))return;if(!Plotter.drawString(context,"  開: "+data.open.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  高: "+data.high.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  低: "+data.low.toFixed(GLOBAL_VAR.digits),rect))return;if(!Plotter.drawString(context,"  收: "+data.close.toFixed(GLOBAL_VAR.digits),rect))return}if(selIndex>0){if("zh-cn"==lang){if(!Plotter.drawString(context,"  涨幅: ",rect))return}else if("en-us"==lang){if(!Plotter.drawString(context,"  CHANGE: ",rect))return}else if("zh-tw"==lang&&!Plotter.drawString(context,"  漲幅: ",rect))return;var prev=ds.getDataAt(selIndex-1),change=(data.close-prev.close)/prev.close*100;if(change>=0?(change=" "+change.toFixed(2),context.fillStyle=theme.getColor(Theme.Color.TextPositive)):(change=change.toFixed(2),context.fillStyle=theme.getColor(Theme.Color.TextNegative)),!Plotter.drawString(context,change,rect))return;if(context.fillStyle=theme.getColor(Theme.Color.Text4),!Plotter.drawString(context," %",rect))return}var amplitude=(data.high-data.low)/lastData.close*100;if("zh-cn"==lang){if(!Plotter.drawString(context,"  振幅: "+amplitude.toFixed(2)+" %",rect))return;if(!Plotter.drawString(context,"  量: "+data.volume.toFixed(GLOBAL_VAR.digits),rect))return}else if("en-us"==lang){if(!Plotter.drawString(context,"  AMPLITUDE: "+amplitude.toFixed(2)+" %",rect))return;if(!Plotter.drawString(context,"  V: "+data.volume.toFixed(GLOBAL_VAR.digits),rect))return}else if("zh-tw"==lang){if(!Plotter.drawString(context,"  振幅: "+amplitude.toFixed(2)+" %",rect))return;if(!Plotter.drawString(context,"  量: "+data.volume.toFixed(GLOBAL_VAR.digits),rect))return}var dp=mgr.getDataProvider(this.getAreaName()+".secondary");if(void 0!=dp){var n,indic=dp.getIndicator(),cnt=indic.getOutputCount();for(n=0;n<cnt;n++){var out=indic.getOutputAt(n),v=out.execute(selIndex);if(!isNaN(v)){var info="  "+out.getName()+": "+v.toFixed(digits),color=out.getColor();if(void 0===color&&(color=Theme.Color.Indicator0+n),context.fillStyle=theme.getColor(color),!Plotter.drawString(context,info,rect))return}}}}};var IndicatorPlotter=create_class(NamedObject);IndicatorPlotter.prototype.__construct=function(name){IndicatorPlotter.__super.__construct.call(this,name)},IndicatorPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),range=mgr.getRange(this.getAreaName());if(0!=range.getRange()){var dp=mgr.getDataProvider(this.getName());if(is_instance(dp,IndicatorDataProvider)){var start,theme=mgr.getTheme(this.getFrameName()),cW=timeline.getColumnWidth(),first=timeline.getFirstIndex(),last=timeline.getLastIndex();start=area.isChanged()||timeline.isUpdated()||range.isUpdated()?first:Math.max(first,last-2);var out,n,indic=dp.getIndicator(),outCount=indic.getOutputCount();for(n=0;n<outCount;n++){out=indic.getOutputAt(n);var style=out.getStyle();style==OutputStyle.VolumeStick?this.drawVolumeStick(context,theme,mgr.getDataSource(this.getDataSourceName()),start,last,timeline.toItemLeft(start),cW,timeline.getItemWidth(),range):style==OutputStyle.MACDStick?this.drawMACDStick(context,theme,out,start,last,timeline.toItemLeft(start),cW,timeline.getItemWidth(),range):style==OutputStyle.SARPoint&&this.drawSARPoint(context,theme,out,start,last,timeline.toItemCenter(start),cW,timeline.getItemWidth(),range)}var left=timeline.toColumnLeft(start),center=timeline.toItemCenter(start);for(context.save(),context.rect(left,area.getTop(),area.getRight()-left,area.getHeight()),context.clip(),context.translate(.5,.5),n=0;n<outCount;n++){var x=center;if(out=indic.getOutputAt(n),out.getStyle()==OutputStyle.Line){var v,points=[];start>first&&(v=out.execute(start-1),0==isNaN(v)&&points.push({x:x-cW,y:range.toY(v)}));for(var i=start;i<last;i++,x+=cW)v=out.execute(i),0==isNaN(v)&&points.push({x:x,y:range.toY(v)});if(points.length>0){var color=out.getColor();void 0==color&&(color=Theme.Color.Indicator0+n),context.strokeStyle=theme.getColor(color),Plotter.drawLines(context,points)}}}context.restore()}}},IndicatorPlotter.prototype.drawVolumeStick=function(context,theme,ds,first,last,startX,cW,iW,range){for(var dark=is_instance(theme,DarkTheme),left=startX,strokePosRects=(range.toY(0),[]),fillPosRects=[],fillNegRects=[],i=first;i<last;i++){var data=ds.getDataAt(i),top=range.toY(data.volume),iH=range.toHeight(data.volume);data.close>data.open?iH>1&&iW>1&&dark?strokePosRects.push({x:left+.5,y:top+.5,w:iW-1,h:iH-1}):fillPosRects.push({x:left,y:top,w:Math.max(iW,1),h:Math.max(iH,1)}):data.close==data.open&&i>0&&data.close>=ds.getDataAt(i-1).close?iH>1&&iW>1&&dark?strokePosRects.push({x:left+.5,y:top+.5,w:iW-1,h:iH-1}):fillPosRects.push({x:left,y:top,w:Math.max(iW,1),h:Math.max(iH,1)}):fillNegRects.push({x:left,y:top,w:Math.max(iW,1),h:Math.max(iH,1)}),left+=cW}strokePosRects.length>0&&(context.strokeStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,strokePosRects),context.stroke()),fillPosRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,fillPosRects),context.fill()),fillNegRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillNegRects),context.fill())},IndicatorPlotter.prototype.drawMACDStick=function(context,theme,output,first,last,startX,cW,iW,range){for(var left=startX,middle=range.toY(0),strokePosRects=[],strokeNegRects=[],fillPosRects=[],fillNegRects=[],prevMACD=first>0?output.execute(first-1):NaN,i=first;i<last;i++){var MACD=output.execute(i);if(MACD>=0){var iH=range.toHeight(MACD);(0==i||MACD>=prevMACD)&&iH>1&&iW>1?strokePosRects.push({x:left+.5,y:middle-iH+.5,w:iW-1,h:iH-1}):fillPosRects.push({x:left,y:middle-iH,w:Math.max(iW,1),h:Math.max(iH,1)})}else{var iH=range.toHeight(-MACD);(0==i||MACD>=prevMACD)&&iH>1&&iW>1?strokeNegRects.push({x:left+.5,y:middle+.5,w:iW-1,h:iH-1}):fillNegRects.push({x:left,y:middle,w:Math.max(iW,1),h:Math.max(iH,1)})}prevMACD=MACD,left+=cW}strokePosRects.length>0&&(context.strokeStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,strokePosRects),context.stroke()),strokeNegRects.length>0&&(context.strokeStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,strokeNegRects),context.stroke()),fillPosRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Positive),Plotter.createRectangles(context,fillPosRects),context.fill()),fillNegRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Negative),Plotter.createRectangles(context,fillNegRects),context.fill())},IndicatorPlotter.prototype.drawSARPoint=function(context,theme,output,first,last,startX,cW,iW,range){var r=iW>>1;r<.5&&(r=.5),r>4&&(r=4);var center=startX,right=center+r,endAngle=2*Math.PI;context.save(),context.translate(.5,.5),context.strokeStyle=theme.getColor(Theme.Color.Indicator3),context.beginPath();for(var i=first;i<last;i++){var y=range.toY(output.execute(i));context.moveTo(right,y),context.arc(center,y,r,0,endAngle),center+=cW,right+=cW}context.stroke(),context.restore()};var IndicatorInfoPlotter=create_class(Plotter);IndicatorInfoPlotter.prototype.__construct=function(name){IndicatorInfoPlotter.__super.__construct.call(this,name)},IndicatorInfoPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName()),dp=mgr.getDataProvider(this.getAreaName()+".secondary"),theme=mgr.getTheme(this.getFrameName());context.font=theme.getFont(Theme.Font.Default),context.textAlign="left",context.textBaseline="top",context.fillStyle=theme.getColor(Theme.Color.Text4);var title,rect={x:area.getLeft()+4,y:area.getTop()+2,w:area.getWidth()-8,h:20},indic=dp.getIndicator();switch(indic.getParameterCount()){case 0:title=indic.getName();break;case 1:title=indic.getName()+"("+indic.getParameterAt(0).getValue()+")";break;case 2:title=indic.getName()+"("+indic.getParameterAt(0).getValue()+","+indic.getParameterAt(1).getValue()+")";break;case 3:title=indic.getName()+"("+indic.getParameterAt(0).getValue()+","+indic.getParameterAt(1).getValue()+","+indic.getParameterAt(2).getValue()+")";break;case 4:title=indic.getName()+"("+indic.getParameterAt(0).getValue()+","+indic.getParameterAt(1).getValue()+","+indic.getParameterAt(2).getValue()+","+indic.getParameterAt(3).getValue()+")";break;default:return}if(Plotter.drawString(context,title,rect)){var selIndex=timeline.getSelectedIndex();if(!(selIndex<0)){var out,v,info,color,n,cnt=indic.getOutputCount();for(n=0;n<cnt;n++)if(out=indic.getOutputAt(n),v=out.execute(selIndex),!isNaN(v)&&(info="  "+out.getName()+": "+v.toFixed(2),color=out.getColor(),void 0===color&&(color=Theme.Color.Indicator0+n),context.fillStyle=theme.getColor(color),!Plotter.drawString(context,info,rect)))return}}};var MinMaxPlotter=create_class(NamedObject);MinMaxPlotter.prototype.__construct=function(name){MinMaxPlotter.__super.__construct.call(this,name)},MinMaxPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),ds=mgr.getDataSource(this.getDataSourceName());if(!(ds.getDataCount()<1)){var timeline=mgr.getTimeline(this.getDataSourceName());if(!(timeline.getInnerWidth()<timeline.getColumnWidth())){var range=mgr.getRange(this.getAreaName());if(0!=range.getRange()){var dp=mgr.getDataProvider(this.getAreaName()+".main"),first=timeline.getFirstIndex(),center=first+timeline.getLastIndex()>>1,theme=mgr.getTheme(this.getFrameName());context.font=theme.getFont(Theme.Font.Default),context.textBaseline="middle",context.fillStyle=theme.getColor(Theme.Color.Text4),context.strokeStyle=theme.getColor(Theme.Color.Text4);var digits=ds.getDecimalDigits();this.drawMark(context,dp.getMinValue(),digits,range.toY(dp.getMinValue()),first,center,dp.getMinValueIndex(),timeline),this.drawMark(context,dp.getMaxValue(),digits,range.toY(dp.getMaxValue()),first,center,dp.getMaxValueIndex(),timeline)}}}},MinMaxPlotter.prototype.drawMark=function(context,v,digits,y,first,center,index,timeline){var arrowStart,arrowStop,_arrowStop,textStart;index>center?(context.textAlign="right",arrowStart=timeline.toItemCenter(index)-4,arrowStop=arrowStart-7,_arrowStop=arrowStart-3,textStart=arrowStop-4):(context.textAlign="left",arrowStart=timeline.toItemCenter(index)+4,arrowStop=arrowStart+7,_arrowStop=arrowStart+3,textStart=arrowStop+4),Plotter.drawLine(context,arrowStart,y,arrowStop,y),Plotter.drawLine(context,arrowStart,y,_arrowStop,y+2),Plotter.drawLine(context,arrowStart,y,_arrowStop,y-2),context.fillText(String.fromFloat(v,digits),textStart,y)};var TimelinePlotter=create_class(Plotter);TimelinePlotter.prototype.__construct=function(name){TimelinePlotter.__super.__construct.call(this,name)},TimelinePlotter.TP_MINUTE=6e4,TimelinePlotter.TP_HOUR=60*TimelinePlotter.TP_MINUTE,TimelinePlotter.TP_DAY=24*TimelinePlotter.TP_HOUR,TimelinePlotter.TIME_INTERVAL=[5*TimelinePlotter.TP_MINUTE,10*TimelinePlotter.TP_MINUTE,15*TimelinePlotter.TP_MINUTE,30*TimelinePlotter.TP_MINUTE,TimelinePlotter.TP_HOUR,2*TimelinePlotter.TP_HOUR,3*TimelinePlotter.TP_HOUR,6*TimelinePlotter.TP_HOUR,12*TimelinePlotter.TP_HOUR,TimelinePlotter.TP_DAY,2*TimelinePlotter.TP_DAY],TimelinePlotter.MonthConvert={1:"Jan.",2:"Feb.",3:"Mar.",4:"Apr.",5:"May.",6:"Jun.",7:"Jul.",8:"Aug.",9:"Sep.",10:"Oct.",11:"Nov.",12:"Dec."},TimelinePlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName());if(area.isChanged()||timeline.isUpdated()){var ds=mgr.getDataSource(this.getDataSourceName());if(!(ds.getDataCount()<2)){var n,timeInterval=ds.getDataAt(1).date-ds.getDataAt(0).date,cnt=TimelinePlotter.TIME_INTERVAL.length;for(n=0;n<cnt&&!(timeInterval<TimelinePlotter.TIME_INTERVAL[n]);n++);for(;n<cnt&&!(TimelinePlotter.TIME_INTERVAL[n]%timeInterval==0&&TimelinePlotter.TIME_INTERVAL[n]/timeInterval*timeline.getColumnWidth()>60);n++);var first=timeline.getFirstIndex(),last=timeline.getLastIndex(),d=new Date,local_utc_diff=60*d.getTimezoneOffset()*1e3,theme=mgr.getTheme(this.getFrameName());context.font=theme.getFont(Theme.Font.Default),context.textAlign="center",context.textBaseline="middle";for(var lang=mgr.getLanguage(),gridRects=[],top=area.getTop(),middle=area.getMiddle(),i=first;i<last;i++){var utcDate=ds.getDataAt(i).date,localDate=utcDate-local_utc_diff,time=new Date(utcDate),year=time.getFullYear(),month=time.getMonth()+1,date=time.getDate(),hour=time.getHours(),minute=time.getMinutes(),text="";if(n<cnt){var m=Math.max(TimelinePlotter.TP_DAY,TimelinePlotter.TIME_INTERVAL[n]);if(localDate%m==0)"zh-cn"==lang?text=month.toString()+"月"+date.toString()+"日":"zh-tw"==lang?text=month.toString()+"月"+date.toString()+"日":"en-us"==lang&&(text=TimelinePlotter.MonthConvert[month]+" "+date.toString()),context.fillStyle=theme.getColor(Theme.Color.Text4);else if(localDate%TimelinePlotter.TIME_INTERVAL[n]==0){var strMinute=minute.toString();minute<10&&(strMinute="0"+strMinute),text=hour.toString()+":"+strMinute,context.fillStyle=theme.getColor(Theme.Color.Text2)}}else 1==date&&hour<timeInterval/TimelinePlotter.TP_HOUR&&(1==month?(text=year.toString(),"zh-cn"==lang?text+="年":"zh-tw"==lang&&(text+="年")):"zh-cn"==lang?text=month.toString()+"月":"zh-tw"==lang?text=month.toString()+"月":"en-us"==lang&&(text=TimelinePlotter.MonthConvert[month]),context.fillStyle=theme.getColor(Theme.Color.Text4));if(text.length>0){var x=timeline.toItemCenter(i);gridRects.push({x:x,y:top,w:1,h:4}),context.fillText(text,x,middle)}}gridRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Grid1),Plotter.createRectangles(context,gridRects),context.fill())}}};var RangePlotter=create_class(NamedObject);RangePlotter.prototype.__construct=function(name){RangePlotter.__super.__construct.call(this,name)},RangePlotter.prototype.getRequiredWidth=function(context,v){var mgr=ChartManager.getInstance(),theme=mgr.getTheme(this.getFrameName());return context.font=theme.getFont(Theme.Font.Default),context.measureText((Math.floor(v)+.88).toString()).width+16},RangePlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),areaName=this.getAreaName(),area=mgr.getArea(areaName),rangeName=areaName.substring(0,areaName.lastIndexOf("Range")),range=mgr.getRange(rangeName);if(0!=range.getRange()){var isMainRange="main"==range.getNameObject().getCompAt(2);if(isMainRange);else if(!area.isChanged()&&!range.isUpdated())return;var gradations=range.getGradations();if(0!=gradations.length){var left=area.getLeft(),right=area.getRight(),center=area.getCenter(),theme=mgr.getTheme(this.getFrameName());context.font=theme.getFont(Theme.Font.Default),context.textAlign="center",context.textBaseline="middle",context.fillStyle=theme.getColor(Theme.Color.Text2);var gridRects=[];for(var n in gradations){var y=range.toY(gradations[n]);gridRects.push({x:left,y:y,w:6,h:1}),gridRects.push({x:right-6,y:y,w:6,h:1}),context.fillText(String.fromFloat(gradations[n],2),center,y)}gridRects.length>0&&(context.fillStyle=theme.getColor(Theme.Color.Grid1),Plotter.createRectangles(context,gridRects),context.fill())}}};var COrderGraphPlotter=create_class(NamedObject);COrderGraphPlotter.prototype.__construct=function(name){COrderGraphPlotter.__super.__construct.call(this,name)},COrderGraphPlotter.prototype.Draw=function(context){return this._Draw_(context)},COrderGraphPlotter.prototype._Draw_=function(context){if(0!=this.Update()&&0!=this.updateData()){this.m_top=this.m_pArea.getTop(),this.m_bottom=this.m_pArea.getBottom(),this.m_left=this.m_pArea.getLeft(),this.m_right=this.m_pArea.getRight(),context.save(),context.rect(this.m_left,this.m_top,this.m_right-this.m_left,this.m_bottom-this.m_top),context.clip();var all=ChartManager.getInstance().getChart()._depthData;this.x_offset=0,this.y_offset=0;var ask_tmp={},bid_tmp={};ask_tmp.x=this.m_left+all.array[this.m_ask_si].amounts*this.m_Step,ask_tmp.y=this.m_pRange.toY(all.array[this.m_ask_si].rate),bid_tmp.x=this.m_left+all.array[this.m_bid_si].amounts*this.m_Step,bid_tmp.y=this.m_pRange.toY(all.array[this.m_bid_si].rate),Math.abs(ask_tmp.y-bid_tmp.y)<1&&(this.y_offset=1),this.x_offset=1,this.DrawBackground(context),this.UpdatePoints(),this.FillBlack(context),this.DrawGradations(context),this.DrawLine(context),context.restore()}},COrderGraphPlotter.prototype.DrawBackground=function(context){context.fillStyle=this.m_pTheme.getColor(Theme.Color.Background),context.fillRect(this.m_left,this.m_top,this.m_right-this.m_left,this.m_bottom-this.m_top);var all=ChartManager.getInstance().getChart()._depthData;if(0==this.m_mode){var ask_bottom=this.m_pRange.toY(all.array[this.m_ask_si].rate)-this.y_offset,bid_top=this.m_pRange.toY(all.array[this.m_bid_si].rate)+this.y_offset,ask_gradient=context.createLinearGradient(this.m_left,0,this.m_right,0);ask_gradient.addColorStop(0,this.m_pTheme.getColor(Theme.Color.Background)),ask_gradient.addColorStop(1,this.m_pTheme.getColor(Theme.Color.PositiveDark)),context.fillStyle=ask_gradient,context.fillRect(this.m_left,this.m_top,this.m_right-this.m_left,ask_bottom-this.m_top);var bid_gradient=context.createLinearGradient(this.m_left,0,this.m_right,0);bid_gradient.addColorStop(0,this.m_pTheme.getColor(Theme.Color.Background)),bid_gradient.addColorStop(1,this.m_pTheme.getColor(Theme.Color.NegativeDark)),context.fillStyle=bid_gradient,context.fillRect(this.m_left,bid_top,this.m_right-this.m_left,this.m_bottom-bid_top)}else if(1==this.m_mode){var ask_gradient=context.createLinearGradient(this.m_left,0,this.m_right,0);ask_gradient.addColorStop(0,this.m_pTheme.getColor(Theme.Color.Background)),ask_gradient.addColorStop(1,this.m_pTheme.getColor(Theme.Color.PositiveDark)),context.fillStyle=ask_gradient,context.fillRect(this.m_left,this.m_top,this.m_right-this.m_left,this.m_bottom-this.m_top)}else if(2==this.m_mode){var bid_gradient=context.createLinearGradient(this.m_left,0,this.m_right,0);bid_gradient.addColorStop(0,this.m_pTheme.getColor(Theme.Color.Background)),bid_gradient.addColorStop(1,this.m_pTheme.getColor(Theme.Color.NegativeDark)),context.fillStyle=bid_gradient,context.fillRect(this.m_left,this.m_top,this.m_right-this.m_left,this.m_bottom-this.m_top)}},COrderGraphPlotter.prototype.DrawLine=function(context){if(0==this.m_mode||1==this.m_mode){context.strokeStyle=this.m_pTheme.getColor(Theme.Color.Positive),context.beginPath(),context.moveTo(Math.floor(this.m_ask_points[0].x)+.5,Math.floor(this.m_ask_points[0].y)+.5);for(var i=1;i<this.m_ask_points.length;i++)context.lineTo(Math.floor(this.m_ask_points[i].x)+.5,Math.floor(this.m_ask_points[i].y)+.5);context.stroke()}if(0==this.m_mode||2==this.m_mode){context.strokeStyle=this.m_pTheme.getColor(Theme.Color.Negative),context.beginPath(),context.moveTo(this.m_bid_points[0].x+.5,this.m_bid_points[0].y+.5);for(var i=1;i<this.m_bid_points.length;i++)context.lineTo(this.m_bid_points[i].x+.5,this.m_bid_points[i].y+.5);context.stroke()}},COrderGraphPlotter.prototype.UpdatePoints=function(){var all=ChartManager.getInstance().getChart()._depthData;this.m_ask_points=[];var index_ask={};index_ask.x=Math.floor(this.m_left),index_ask.y=Math.floor(this.m_pRange.toY(all.array[this.m_ask_si].rate)-this.y_offset),this.m_ask_points.push(index_ask);for(var ask_p_i=0,i=this.m_ask_si;i>=this.m_ask_ei;i--){var index0={},index1={};i==this.m_ask_si?(index0.x=Math.floor(this.m_left+all.array[i].amounts*this.m_Step+this.x_offset),index0.y=Math.floor(this.m_pRange.toY(all.array[i].rate)-this.y_offset),this.m_ask_points.push(index0),ask_p_i=1):(index0.x=Math.floor(this.m_left+all.array[i].amounts*this.m_Step+this.x_offset),index0.y=Math.floor(this.m_ask_points[ask_p_i].y),index1.x=Math.floor(index0.x),index1.y=Math.floor(this.m_pRange.toY(all.array[i].rate)-this.y_offset),this.m_ask_points.push(index0),ask_p_i++,this.m_ask_points.push(index1),ask_p_i++)}this.m_bid_points=[];var index_bid={};index_bid.x=Math.floor(this.m_left),index_bid.y=Math.ceil(this.m_pRange.toY(all.array[this.m_bid_si].rate)+this.y_offset),this.m_bid_points.push(index_bid);for(var bid_p_i=0,i=this.m_bid_si;i<=this.m_bid_ei;i++){var index0={},index1={};i==this.m_bid_si?(index0.x=Math.floor(this.m_left+all.array[i].amounts*this.m_Step+this.x_offset),index0.y=Math.ceil(this.m_pRange.toY(all.array[i].rate)+this.y_offset),this.m_bid_points.push(index0),bid_p_i=1):(index0.x=Math.floor(this.m_left+all.array[i].amounts*this.m_Step+this.x_offset),index0.y=Math.ceil(this.m_bid_points[bid_p_i].y),index1.x=Math.floor(index0.x),index1.y=Math.ceil(this.m_pRange.toY(all.array[i].rate)+this.x_offset),this.m_bid_points.push(index0),bid_p_i++,this.m_bid_points.push(index1),bid_p_i++)}},COrderGraphPlotter.prototype.updateData=function(){var all=ChartManager.getInstance().getChart()._depthData;if(null==all.array)return!1;if(all.array.length<=100)return!1;var minRange=this.m_pRange.getOuterMinValue(),maxRange=this.m_pRange.getOuterMaxValue();this.m_ask_si=all.asks_si,this.m_ask_ei=all.asks_si;for(var i=all.asks_si;i>=all.asks_ei&&all.array[i].rate<maxRange;i--)this.m_ask_ei=i;this.m_bid_si=all.bids_si,this.m_bid_ei=all.bids_si;for(var i=all.bids_si;i<=all.bids_ei&&all.array[i].rate>minRange;i++)this.m_bid_ei=i;return this.m_ask_ei==this.m_ask_si?this.m_mode=2:this.m_bid_ei==this.m_bid_si?this.m_mode=1:this.m_mode=0,this.m_Step=this.m_pArea.getWidth(),0==this.m_mode?this.m_ask_ei==all.asks_ei&&this.m_bid_ei==all.bids_ei?this.m_Step/=Math.min(all.array[this.m_ask_ei].amounts,all.array[this.m_bid_ei].amounts):this.m_ask_ei!=all.asks_ei&&this.m_bid_ei==all.bids_ei?this.m_Step/=all.array[this.m_bid_ei].amounts:this.m_ask_ei==all.asks_ei&&this.m_bid_ei!=all.bids_ei?this.m_Step/=all.array[this.m_ask_ei].amounts:this.m_ask_ei!=all.asks_ei&&this.m_bid_ei!=all.bids_ei&&(this.m_Step/=Math.max(all.array[this.m_ask_ei].amounts,all.array[this.m_bid_ei].amounts)):1==this.m_mode?this.m_Step/=all.array[this.m_ask_ei].amounts:2==this.m_mode&&(this.m_Step/=all.array[this.m_bid_ei].amounts),!0},COrderGraphPlotter.prototype.Update=function(){this.m_pMgr=ChartManager.getInstance();var areaName=this.getAreaName();if(this.m_pArea=this.m_pMgr.getArea(areaName),null==this.m_pArea)return!1;var rangeName=areaName.substring(0,areaName.lastIndexOf("Range"));return this.m_pRange=this.m_pMgr.getRange(rangeName),null!=this.m_pRange&&0!=this.m_pRange.getRange()&&(this.m_pTheme=this.m_pMgr.getTheme(this.getFrameName()),null!=this.m_pTheme)},COrderGraphPlotter.prototype.DrawGradations=function(context){var mgr=ChartManager.getInstance(),areaName=this.getAreaName(),area=mgr.getArea(areaName),rangeName=areaName.substring(0,areaName.lastIndexOf("Range")),range=mgr.getRange(rangeName);if(0!=range.getRange()){var gradations=range.getGradations();if(0!=gradations.length){var left=area.getLeft(),right=area.getRight(),gridRects=[];for(var n in gradations){var y=range.toY(gradations[n]);gridRects.push({x:left,y:y,w:6,h:1}),gridRects.push({x:right-6,y:y,w:6,h:1})}if(gridRects.length>0){var theme=mgr.getTheme(this.getFrameName());context.fillStyle=theme.getColor(Theme.Color.Grid1),Plotter.createRectangles(context,gridRects),context.fill()}}}},COrderGraphPlotter.prototype.FillBlack=function(context){var ask_point=this.m_ask_points,bid_point=this.m_bid_points,ask_first_add={},ask_last_add={};ask_first_add.x=this.m_right,ask_first_add.y=ask_point[0].y,ask_last_add.x=this.m_right,ask_last_add.y=ask_point[ask_point.length-1].y;var bid_first_add={},bid_last_add={};bid_first_add.x=this.m_right,bid_first_add.y=bid_point[0].y-1,bid_last_add.x=this.m_right,bid_last_add.y=bid_point[bid_point.length-1].y,ask_point.unshift(ask_first_add),ask_point.push(ask_last_add),bid_point.unshift(bid_first_add),bid_point.push(bid_last_add),context.fillStyle=this.m_pTheme.getColor(Theme.Color.Background),context.beginPath(),context.moveTo(Math.floor(ask_point[0].x)+.5,Math.floor(ask_point[0].y)+.5);for(var i=1;i<ask_point.length;i++)context.lineTo(Math.floor(ask_point[i].x)+.5,Math.floor(ask_point[i].y)+.5);context.fill(),context.beginPath(),context.moveTo(Math.floor(bid_point[0].x)+.5,Math.floor(bid_point[0].y)+.5);for(var i=1;i<bid_point.length;i++)context.lineTo(Math.floor(bid_point[i].x)+.5,Math.floor(bid_point[i].y)+.5);context.fill(),ask_point.shift(),ask_point.pop(),bid_point.shift(),bid_point.pop()},COrderGraphPlotter.prototype.DrawTickerGraph=function(context){return};var LastVolumePlotter=create_class(Plotter);LastVolumePlotter.prototype.__construct=function(name){LastVolumePlotter.__super.__construct.call(this,name)},LastVolumePlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),areaName=(mgr.getTimeline(this.getDataSourceName()),this.getAreaName()),area=mgr.getArea(areaName),rangeName=areaName.substring(0,areaName.lastIndexOf("Range")),range=mgr.getRange(rangeName);if(0!=range.getRange()){var ds=mgr.getDataSource(this.getDataSourceName());if(!(ds.getDataCount()<1)){var theme=mgr.getTheme(this.getFrameName());context.font=theme.getFont(Theme.Font.Default),context.textAlign="left",context.textBaseline="middle",context.fillStyle=theme.getColor(Theme.Color.RangeMark),context.strokeStyle=theme.getColor(Theme.Color.RangeMark);var v=ds.getDataAt(ds.getDataCount()-1).volume,y=range.toY(v),left=area.getLeft()+1;Plotter.drawLine(context,left,y,left+7,y),Plotter.drawLine(context,left,y,left+3,y+2),Plotter.drawLine(context,left,y,left+3,y-2),context.fillText(String.fromFloat(v,2),left+10,y)}}};var LastClosePlotter=create_class(Plotter);LastClosePlotter.prototype.__construct=function(name){LastClosePlotter.__super.__construct.call(this,name)},LastClosePlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),areaName=(mgr.getTimeline(this.getDataSourceName()),this.getAreaName()),area=mgr.getArea(areaName),rangeName=areaName.substring(0,areaName.lastIndexOf("Range")),range=mgr.getRange(rangeName);if(0!=range.getRange()){var ds=mgr.getDataSource(this.getDataSourceName());if(!(ds.getDataCount()<1)){var v=ds._dataItems[ds._dataItems.length-1].close;if(!(v<=range.getMinValue()||v>=range.getMaxValue())){var theme=mgr.getTheme(this.getFrameName());context.font=theme.getFont(Theme.Font.Default),context.textAlign="left",context.textBaseline="middle",context.fillStyle=theme.getColor(Theme.Color.RangeMark),context.strokeStyle=theme.getColor(Theme.Color.RangeMark);var y=range.toY(v),left=area.getLeft()+1;Plotter.drawLine(context,left,y,left+7,y),Plotter.drawLine(context,left,y,left+3,y+2),Plotter.drawLine(context,left,y,left+3,y-2),context.fillText(String.fromFloat(v,ds.getDecimalDigits()),left+10,y)}}}};var SelectionPlotter=create_class(Plotter);SelectionPlotter.prototype.__construct=function(name){SelectionPlotter.__super.__construct.call(this,name)},SelectionPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance();if(mgr._drawingTool==ChartManager.DrawingTool.CrossCursor){var area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName());if(!(timeline.getSelectedIndex()<0)){var range=mgr.getRange(this.getAreaName()),theme=mgr.getTheme(this.getFrameName());context.strokeStyle=theme.getColor(Theme.Color.Cursor);var x=timeline.toItemCenter(timeline.getSelectedIndex());Plotter.drawLine(context,x,area.getTop()-1,x,area.getBottom());var pos=range.getSelectedPosition();pos>=0&&Plotter.drawLine(context,area.getLeft(),pos,area.getRight(),pos)}}};var TimelineSelectionPlotter=create_class(NamedObject);TimelineSelectionPlotter.MonthConvert={1:"Jan.",2:"Feb.",3:"Mar.",4:"Apr.",5:"May.",6:"Jun.",7:"Jul.",8:"Aug.",9:"Sep.",10:"Oct.",11:"Nov.",12:"Dec."},TimelineSelectionPlotter.prototype.__construct=function(name){TimelineSelectionPlotter.__super.__construct.call(this,name)},TimelineSelectionPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),area=mgr.getArea(this.getAreaName()),timeline=mgr.getTimeline(this.getDataSourceName());if(!(timeline.getSelectedIndex()<0)){var ds=mgr.getDataSource(this.getDataSourceName());if(is_instance(ds,MainDataSource)){var theme=mgr.getTheme(this.getFrameName()),lang=mgr.getLanguage(),x=timeline.toItemCenter(timeline.getSelectedIndex());context.fillStyle=theme.getColor(Theme.Color.Background),context.fillRect(x-52.5,area.getTop()+2.5,106,18),context.strokeStyle=theme.getColor(Theme.Color.Grid3),context.strokeRect(x-52.5,area.getTop()+2.5,106,18),context.font=theme.getFont(Theme.Font.Default),context.textAlign="center",context.textBaseline="middle",context.fillStyle=theme.getColor(Theme.Color.Text4);var time=new Date(ds.getDataAt(timeline.getSelectedIndex()).date),month=time.getMonth()+1,date=time.getDate(),hour=time.getHours(),minute=time.getMinutes(),strMonth=month.toString(),strDate=date.toString(),strHour=hour.toString(),strMinute=minute.toString();minute<10&&(strMinute="0"+strMinute);var text="";"zh-cn"==lang?text=strMonth+"月"+strDate+"日  "+strHour+":"+strMinute:"zh-tw"==lang?text=strMonth+"月"+strDate+"日  "+strHour+":"+strMinute:"en-us"==lang&&(text=TimelineSelectionPlotter.MonthConvert[month]+" "+strDate+"  "+strHour+":"+strMinute),context.fillText(text,x,area.getMiddle())}}};var RangeSelectionPlotter=create_class(NamedObject);RangeSelectionPlotter.prototype.__construct=function(name){RangeSelectionPlotter.__super.__construct.call(this,name)},RangeSelectionPlotter.prototype.Draw=function(context){var mgr=ChartManager.getInstance(),areaName=this.getAreaName(),area=mgr.getArea(areaName),timeline=mgr.getTimeline(this.getDataSourceName());if(!(timeline.getSelectedIndex()<0)){var rangeName=areaName.substring(0,areaName.lastIndexOf("Range")),range=mgr.getRange(rangeName);if(!(0==range.getRange()||range.getSelectedPosition()<0)){var v=range.getSelectedValue();if(v!=-Number.MAX_VALUE){var y=range.getSelectedPosition();Plotter.createPolygon(context,[{x:area.getLeft(),y:y},{x:area.getLeft()+5,y:y+10},{x:area.getRight()-3,y:y+10},{x:area.getRight()-3,y:y-10},{x:area.getLeft()+5,y:y-10}]);var theme=mgr.getTheme(this.getFrameName());context.fillStyle=theme.getColor(Theme.Color.Background),context.fill(),context.strokeStyle=theme.getColor(Theme.Color.Grid4),
context.stroke(),context.font=theme.getFont(Theme.Font.Default),context.textAlign="center",context.textBaseline="middle",context.fillStyle=theme.getColor(Theme.Color.Text3);var digits=2;"main"==range.getNameObject().getCompAt(2)&&(digits=mgr.getDataSource(this.getDataSourceName()).getDecimalDigits()),context.fillText(String.fromFloat(v,digits),area.getCenter(),y)}}}};var ChartSettings={};ChartSettings.checkVersion=function(){var currentVersion=1;if(currentVersion=2,ChartSettings._data.ver<currentVersion){ChartSettings._data.ver=2;var charts=ChartSettings._data.charts;charts.period_weight={},charts.period_weight.line=8,charts.period_weight[0]=7,charts.period_weight[1]=6,charts.period_weight[2]=5,charts.period_weight[9]=4,charts.period_weight[10]=3,charts.period_weight[3]=2,charts.period_weight[4]=1,charts.period_weight[7]=0,charts.period_weight[11]=0,charts.period_weight[12]=0,charts.period_weight[13]=0,charts.period_weight[14]=0,charts.period_weight[15]=0}if(currentVersion=3,ChartSettings._data.ver<currentVersion){ChartSettings._data.ver=3;var charts=ChartSettings._data.charts;charts.areaHeight=[]}},ChartSettings.get=function(){return void 0==ChartSettings._data&&(ChartSettings.init(),ChartSettings.load(),ChartSettings.checkVersion()),ChartSettings._data},ChartSettings.init=function(){for(var _indic_param={},_name=new Array("MA","EMA","VOLUME","MACD","KDJ","StochRSI","RSI","DMI","OBV","BOLL","DMA","TRIX","BRAR","VR","EMV","WR","ROC","MTM","PSY"),i=0;i<_name.length;i++){var _value=ChartManager.getInstance().createIndicatorAndRange("",_name[i],!0);if(null!=_value){_indic_param[_name[i]]=[];for(var param=_value.indic.getParameters(),j=0;j<param.length;j++)_indic_param[_name[i]].push(param[j])}}var _chart_style="CandleStick",_m_indic="MA",_indic=new Array("VOLUME","MACD"),_time="15m",_frame={};_frame.chartStyle=_chart_style,_frame.mIndic=_m_indic,_frame.indics=_indic,_frame.indicsStatus="close",_frame.period=_time,ChartSettings._data={ver:1,charts:_frame,indics:_indic_param,theme:"Dark"},ChartSettings.checkVersion()},ChartSettings.load=function(){if(!(document.cookie.length<=0)){var start=document.cookie.indexOf("chartSettings=");if(start!=-1){start+="chartSettings=".length;var end=document.cookie.indexOf(";",start);end==-1&&(end=document.cookie.length);var json=unescape(document.cookie.substring(start,end));ChartSettings._data=JSON.parse(json)}}},ChartSettings.save=function(){var exdate=new Date;exdate.setDate(exdate.getDate()+365),document.cookie="chartSettings="+escape(JSON.stringify(ChartSettings._data))+";expires="+exdate.toGMTString()};var CPoint=create_class(NamedObject);CPoint.state={Hide:0,Show:1,Highlight:2},CPoint.prototype.__construct=function(name){CPoint.__super.__construct.call(this,name),this.pos={index:-1,value:-1},this.state=CPoint.state.Hide},CPoint.prototype.getChartObjects=function(){var ppMgr=ChartManager.getInstance(),ppCDS=ppMgr.getDataSource("frame0.k0");if(null==ppCDS||!is_instance(ppCDS,MainDataSource))return null;var ppTimeline=ppMgr.getTimeline("frame0.k0");if(null==ppTimeline)return null;var ppRange=ppMgr.getRange("frame0.k0.main");return null==ppRange?null:{pMgr:ppMgr,pCDS:ppCDS,pTimeline:ppTimeline,pRange:ppRange}},CPoint.prototype.setPosXY=function(x,y){var pObj=this.getChartObjects(),i=pObj.pTimeline.toIndex(x),v=pObj.pRange.toValue(y),result=this.snapValue(i,v);null!=result&&(v=result),this.setPosIV(i,v)},CPoint.prototype.setPosXYNoSnap=function(x,y){var pObj=this.getChartObjects(),i=pObj.pTimeline.toIndex(x),v=pObj.pRange.toValue(y);this.setPosIV(i,v)},CPoint.prototype.setPosIV=function(i,v){this.pos={index:i,value:v}},CPoint.prototype.getPosXY=function(){var pObj=this.getChartObjects(),_x=pObj.pTimeline.toItemCenter(this.pos.index),_y=pObj.pRange.toY(this.pos.value);return{x:_x,y:_y}},CPoint.prototype.getPosIV=function(){return{i:this.pos.index,v:this.pos.value}},CPoint.prototype.setState=function(s){this.state=s},CPoint.prototype.getState=function(){return this.state},CPoint.prototype.isSelected=function(x,y){var xy=this.getPosXY();return!(x<xy.x-4||x>xy.x+4||y<xy.y-4||y>xy.y+4)&&(this.setState(CPoint.state.Highlight),!0)},CPoint.prototype.snapValue=function(i,v){var pObj=this.getChartObjects(),result=null,first=Math.floor(pObj.pTimeline.getFirstIndex()),last=Math.floor(pObj.pTimeline.getLastIndex());if(i<first||i>last)return result;var y=pObj.pRange.toY(v),pData=pObj.pCDS.getDataAt(i);if(null==pData||void 0==pData)return result;var pDataPre=null;pDataPre=i>0?pObj.pCDS.getDataAt(i-1):pObj.pCDS.getDataAt(i);var candleStickStyle=pObj.pMgr.getChartStyle(pObj.pCDS.getFrameName()),open=pObj.pRange.toY(pData.open),high=pObj.pRange.toY(pData.high),low=pObj.pRange.toY(pData.low),close=pObj.pRange.toY(pData.close);"CandleStickHLC"===candleStickStyle&&(open=pObj.pRange.toY(pDataPre.close));var dif_open=Math.abs(open-y),dif_high=Math.abs(high-y),dif_low=Math.abs(low-y),dif_close=Math.abs(close-y);return dif_open<=dif_high&&dif_open<=dif_low&&dif_open<=dif_close&&dif_open<6&&(result=pData.open),dif_high<=dif_open&&dif_high<=dif_low&&dif_high<=dif_close&&dif_high<6&&(result=pData.high),dif_low<=dif_open&&dif_low<=dif_high&&dif_low<=dif_close&&dif_low<6&&(result=pData.low),dif_close<=dif_open&&dif_close<=dif_high&&dif_close<=dif_low&&dif_close<6&&(result=pData.close),result};var CToolObject=create_class(NamedObject);CToolObject.state={BeforeDraw:0,Draw:1,AfterDraw:2},CToolObject.prototype.__construct=function(name){CToolObject.__super.__construct.call(this,name),this.drawer=null,this.state=CToolObject.state.BeforeDraw,this.points=[],this.step=0},CToolObject.prototype.getChartObjects=function(){var ppMgr=ChartManager.getInstance(),ppCDS=ppMgr.getDataSource("frame0.k0");if(null==ppCDS||!is_instance(ppCDS,MainDataSource))return null;var ppTimeline=ppMgr.getTimeline("frame0.k0");if(null==ppTimeline)return null;var ppArea=ppMgr.getArea("frame0.k0.main");if(null==ppArea)return null;var ppRange=ppMgr.getRange("frame0.k0.main");return null==ppRange?null:{pMgr:ppMgr,pCDS:ppCDS,pTimeline:ppTimeline,pArea:ppArea,pRange:ppRange}},CToolObject.prototype.isValidMouseXY=function(x,y){var pObj=this.getChartObjects(),areaPos={left:pObj.pArea.getLeft(),top:pObj.pArea.getTop(),right:pObj.pArea.getRight(),bottom:pObj.pArea.getBottom()};return!(x<areaPos.left||x>areaPos.right||y<areaPos.top||y>areaPos.bottom)},CToolObject.prototype.getPlotter=function(){return this.drawer},CToolObject.prototype.setState=function(s){this.state=s},CToolObject.prototype.getState=function(){return this.state},CToolObject.prototype.addPoint=function(point){this.points.push(point)},CToolObject.prototype.getPoint=function(i){return this.points[i]},CToolObject.prototype.acceptMouseMoveEvent=function(x,y){return 0!=this.isValidMouseXY(x,y)&&(this.state==CToolObject.state.BeforeDraw?this.setBeforeDrawPos(x,y):this.state==CToolObject.state.Draw?this.setDrawPos(x,y):this.state==CToolObject.state.AfterDraw&&this.setAfterDrawPos(x,y),!0)},CToolObject.prototype.acceptMouseDownEvent=function(x,y){return 0!=this.isValidMouseXY(x,y)&&(this.state==CToolObject.state.BeforeDraw?(this.setDrawPos(x,y),this.setState(CToolObject.state.Draw)):this.state==CToolObject.state.Draw?(this.setAfterDrawPos(x,y),0==this.step&&this.setState(CToolObject.state.AfterDraw)):this.state==CToolObject.state.AfterDraw&&(CToolObject.prototype.isSelected.call(this,x,y)?(this.setDrawPos(x,y),this.setState(CToolObject.state.Draw)):(this.oldx=x,this.oldy=y)),!0)},CToolObject.prototype.acceptMouseDownMoveEvent=function(x,y){if(0==this.isValidMouseXY(x,y))return!1;if(this.state==CToolObject.state.Draw)this.setDrawPos(x,y);else if(this.state==CToolObject.state.AfterDraw){var pObj=this.getChartObjects(),_width=pObj.pTimeline.getItemWidth();pObj.pRange;if(Math.abs(x-this.oldx)<_width&&0==Math.abs(y-this.oldy))return!0;var _old_x=pObj.pTimeline.toIndex(this.oldx),_old_y=pObj.pRange.toValue(this.oldy),_new_x=pObj.pTimeline.toIndex(x),_new_y=pObj.pRange.toValue(y);this.oldx=x,this.oldy=y;var _dif_x=_new_x-_old_x,_dif_y=_new_y-_old_y;for(var index in this.points)this.points[index].pos.index+=_dif_x,this.points[index].pos.value+=_dif_y}return!0},CToolObject.prototype.acceptMouseUpEvent=function(x,y){return 0!=this.isValidMouseXY(x,y)&&(this.state==CToolObject.state.Draw&&(this.setAfterDrawPos(x,y),0==this.step&&this.setState(CToolObject.state.AfterDraw),!0))},CToolObject.prototype.setBeforeDrawPos=function(x,y){for(var index in this.points)this.points[index].setPosXY(x,y),this.points[index].setState(CPoint.state.Show)},CToolObject.prototype.setDrawPos=function(x,y){for(var index in this.points)this.points[index].getState()==CPoint.state.Highlight&&this.points[index].setPosXY(x,y)},CToolObject.prototype.setAfterDrawPos=function(x,y){0!=this.step&&(this.step-=1);for(var index in this.points)this.points[index].setState(CPoint.state.Hide);if(0==this.step){var pObj=this.getChartObjects();pObj.pMgr.setNormalMode()}},CToolObject.prototype.isSelected=function(x,y){var isFind=!1;for(var index in this.points)if(this.points[index].isSelected(x,y)){this.points[index].setState(CPoint.state.Highlight),isFind=!0;break}return 1==isFind&&(this.select(),!0)},CToolObject.prototype.select=function(){for(var index in this.points)this.points[index].getState()==CPoint.state.Hide&&this.points[index].setState(CPoint.state.Show)},CToolObject.prototype.unselect=function(){for(var index in this.points)this.points[index].getState()!=CPoint.state.Hide&&this.points[index].setState(CPoint.state.Hide)},CToolObject.prototype.calcDistance=function(point1,point2,point3){var xa=point1.getPosXY().x,ya=point1.getPosXY().y,xb=point2.getPosXY().x,yb=point2.getPosXY().y,xc=point3.getPosXY().x,yc=point3.getPosXY().y,a1=xa-xc,a2=ya-yc,b1=xb-xc,b2=yb-yc,area=Math.abs(a1*b2-a2*b1),len=Math.sqrt(Math.pow(xb-xa,2)+Math.pow(yb-ya,2));return area/len},CToolObject.prototype.calcGap=function(r,x,y){var xa=r.sx,ya=r.sy,xb=r.ex,yb=r.ey,xc=x,yc=y,a1=xa-xc,a2=ya-yc,b1=xb-xc,b2=yb-yc,area=Math.abs(a1*b2-a2*b1),len=Math.sqrt(Math.pow(xb-xa,2)+Math.pow(yb-ya,2));return area/len},CToolObject.prototype.isWithRect=function(point1,point2,point3){var sx=point1.getPosXY().x,sy=point1.getPosXY().y,ex=point2.getPosXY().x,ey=point2.getPosXY().y,x=point3.getPosXY().x,y=point3.getPosXY().y;return sx>ex?(sx+=4,ex-=4):(sx-=4,ex+=4),sy>ey?(sy+=4,ey-=4):(sy-=4,ey+=4),sx<=x&&ex>=x&&sy<=y&&ey>=y||(sx>=x&&ex<=x&&sy<=y&&ey>=y||(sx<=x&&ex>=x&&sy>=y&&ey<=y||sx>=x&&ex<=x&&sy>=y&&ey<=y))},CBiToolObject=create_class(CToolObject),CBiToolObject.prototype.__construct=function(name){CBiToolObject.__super.__construct.call(this,name),this.addPoint(new CPoint(name)),this.addPoint(new CPoint(name))},CBiToolObject.prototype.setBeforeDrawPos=function(x,y){this.step=1,CBiToolObject.__super.setBeforeDrawPos.call(this,x,y),this.getPoint(0).setState(CPoint.state.Show),this.getPoint(1).setState(CPoint.state.Highlight)},CTriToolObject=create_class(CToolObject),CTriToolObject.prototype.__construct=function(name){CTriToolObject.__super.__construct.call(this,name),this.addPoint(new CPoint(name)),this.addPoint(new CPoint(name)),this.addPoint(new CPoint(name))},CTriToolObject.prototype.setBeforeDrawPos=function(x,y){this.step=2,CBiToolObject.__super.setBeforeDrawPos.call(this,x,y),this.getPoint(0).setState(CPoint.state.Show),this.getPoint(1).setState(CPoint.state.Show),this.getPoint(2).setState(CPoint.state.Highlight)},CTriToolObject.prototype.setAfterDrawPos=function(x,y){if(0!=this.step&&(this.step-=1),0==this.step)for(var index in this.points)this.points[index].setState(CPoint.state.Hide);else this.getPoint(0).setState(CPoint.state.Show),this.getPoint(1).setState(CPoint.state.Highlight),this.getPoint(2).setState(CPoint.state.Show);if(0==this.step){var pObj=this.getChartObjects();pObj.pMgr.setNormalMode()}};var CBandLineObject=create_class(CBiToolObject);CBandLineObject.prototype.__construct=function(name){CBandLineObject.__super.__construct.call(this,name),this.drawer=new DrawBandLinesPlotter(name,this)},CBandLineObject.prototype.isSelected=function(x,y){if(1==CBandLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);for(var sy=(this.getPoint(0).getPosXY().x,this.getPoint(0).getPosXY().y),ey=(this.getPoint(1).getPosXY().x,this.getPoint(1).getPosXY().y),fibSequence=[100,87.5,75,62.5,50,37.5,25,12.5,0],i=0;i<fibSequence.length;i++){var stage_y=sy+(100-fibSequence[i])/100*(ey-sy);if(stage_y<y+4&&stage_y>y-4)return this.select(),!0}return!1};var CBiParallelLineObject=create_class(CTriToolObject);CBiParallelLineObject.prototype.__construct=function(name){CBiParallelLineObject.__super.__construct.call(this,name),this.drawer=new DrawBiParallelLinesPlotter(name,this)},CBiParallelLineObject.prototype.isSelected=function(x,y){if(1==CTriParallelLineObject.__super.isSelected.call(this,x,y))return!0;var _0x=this.getPoint(0).getPosXY().x,_0y=this.getPoint(0).getPosXY().y,_1x=this.getPoint(1).getPosXY().x,_1y=this.getPoint(1).getPosXY().y,_2x=this.getPoint(2).getPosXY().x,_2y=this.getPoint(2).getPosXY().y,_a={x:_0x-_1x,y:_0y-_1y},_b={x:_0x-_2x,y:_0y-_2y},_c={x:_a.x+_b.x,y:_a.y+_b.y},_3x=_0x-_c.x,_3y=_0y-_c.y,r1={sx:_0x,sy:_0y,ex:_2x,ey:_2y},r2={sx:_1x,sy:_1y,ex:_3x,ey:_3y};return!(this.calcGap(r1,x,y)>4&&this.calcGap(r2,x,y)>4)};var CBiParallelRayLineObject=create_class(CTriToolObject);CBiParallelRayLineObject.prototype.__construct=function(name){CBiParallelRayLineObject.__super.__construct.call(this,name),this.drawer=new DrawBiParallelRayLinesPlotter(name,this)},CBiParallelRayLineObject.prototype.isSelected=function(x,y){if(1==CTriParallelLineObject.__super.isSelected.call(this,x,y))return!0;var _0x=this.getPoint(0).getPosXY().x,_0y=this.getPoint(0).getPosXY().y,_1x=this.getPoint(1).getPosXY().x,_1y=this.getPoint(1).getPosXY().y,_2x=this.getPoint(2).getPosXY().x,_2y=this.getPoint(2).getPosXY().y,_a={x:_0x-_1x,y:_0y-_1y},_b={x:_0x-_2x,y:_0y-_2y},_c={x:_a.x+_b.x,y:_a.y+_b.y},_3x=_0x-_c.x,_3y=_0y-_c.y,r1={sx:_0x,sy:_0y,ex:_2x,ey:_2y},r2={sx:_1x,sy:_1y,ex:_3x,ey:_3y};return(r1.ex>r1.sx&&x>r1.sx-4||r1.ex<r1.sx&&x<r1.sx+4||r2.ex>r2.sx&&x>r2.sx-4||r2.ex<r2.sx&&x<r2.sx+4)&&(!(this.calcGap(r1,x,y)>4&&this.calcGap(r2,x,y)>4)&&(this.select(),!0))};var CFibFansObject=create_class(CBiToolObject);CFibFansObject.prototype.__construct=function(name){CFibFansObject.__super.__construct.call(this,name),this.drawer=new DrawFibFansPlotter(name,this)},CFibFansObject.prototype.isSelected=function(x,y){if(1==CFibFansObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);for(var sx=this.getPoint(0).getPosXY().x,sy=this.getPoint(0).getPosXY().y,ex=this.getPoint(1).getPosXY().x,ey=this.getPoint(1).getPosXY().y,pObj=this.getChartObjects(),areaPos={left:pObj.pArea.getLeft(),top:pObj.pArea.getTop(),right:pObj.pArea.getRight(),bottom:pObj.pArea.getBottom()},fibFansSequence=[0,38.2,50,61.8],i=0;i<fibFansSequence.length;i++){var stageY=sy+(100-fibFansSequence[i])/100*(ey-sy),tempStartPt={x:sx,y:sy},tempEndPt={x:ex,y:stageY},crossPt=getRectCrossPt(areaPos,tempStartPt,tempEndPt),lenToStartPt=Math.pow(crossPt[0].x-sx,2)+Math.pow(crossPt[0].y-sy,2),lenToEndPt=Math.pow(crossPt[0].x-ex,2)+Math.pow(crossPt[0].y-ey,2),tempCrossPt=lenToStartPt>lenToEndPt?{x:crossPt[0].x,y:crossPt[0].y}:{x:crossPt[1].x,y:crossPt[1].y};if(!(tempCrossPt.x>sx&&x<sx||tempCrossPt.x<sx&&x>sx)){var a=new CPoint("frame0.k0");a.setPosXY(sx,sy);var b=new CPoint("frame0.k0");if(b.setPosXY(tempCrossPt.x,tempCrossPt.y),!(this.calcDistance(a,b,c)>4))return this.select(),!0}}return!1};var CFibRetraceObject=create_class(CBiToolObject);CFibRetraceObject.prototype.__construct=function(name){CFibRetraceObject.__super.__construct.call(this,name),this.drawer=new DrawFibRetracePlotter(name,this)},CFibRetraceObject.prototype.isSelected=function(x,y){if(1==CFibRetraceObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);for(var sy=(this.getPoint(0).getPosXY().x,this.getPoint(0).getPosXY().y),ey=(this.getPoint(1).getPosXY().x,this.getPoint(1).getPosXY().y),fibSequence=[100,78.6,61.8,50,38.2,23.6,0],i=0;i<fibSequence.length;i++){var stage_y=sy+(100-fibSequence[i])/100*(ey-sy);if(stage_y<y+4&&stage_y>y-4)return this.select(),!0}return!1};var CHoriRayLineObject=create_class(CBiToolObject);CHoriRayLineObject.prototype.__construct=function(name){CHoriRayLineObject.__super.__construct.call(this,name),this.drawer=new DrawHoriRayLinesPlotter(name,this)},CHoriRayLineObject.prototype.setDrawPos=function(x,y){return this.points[0].getState()==CPoint.state.Highlight?(this.points[0].setPosXY(x,y),void this.points[1].setPosXYNoSnap(this.points[1].getPosXY().x,this.points[0].getPosXY().y)):void(this.points[1].getState()==CPoint.state.Highlight&&(this.points[1].setPosXY(x,y),this.points[0].setPosXYNoSnap(this.points[0].getPosXY().x,this.points[1].getPosXY().y)))},CHoriRayLineObject.prototype.isSelected=function(x,y){if(1==CHoriRayLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);var sy=this.getPoint(0).getPosXY().y,sx=this.getPoint(0).getPosXY().x,ex=this.getPoint(1).getPosXY().x;return!(y>sy+4||y<sy-4)&&(!(ex>sx&&x<sx-4)&&(!(ex<sx&&x>sx+4)&&(this.select(),!0)))};var CHoriSegLineObject=create_class(CBiToolObject);CHoriSegLineObject.prototype.__construct=function(name){CHoriSegLineObject.__super.__construct.call(this,name),this.drawer=new DrawHoriSegLinesPlotter(name,this)},CHoriSegLineObject.prototype.setDrawPos=function(x,y){return this.points[0].getState()==CPoint.state.Highlight?(this.points[0].setPosXY(x,y),void this.points[1].setPosXYNoSnap(this.points[1].getPosXY().x,this.points[0].getPosXY().y)):void(this.points[1].getState()==CPoint.state.Highlight&&(this.points[1].setPosXY(x,y),this.points[0].setPosXYNoSnap(this.points[0].getPosXY().x,this.points[1].getPosXY().y)))},CHoriSegLineObject.prototype.isSelected=function(x,y){if(1==CHoriSegLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);var sy=this.getPoint(0).getPosXY().y,sx=this.getPoint(0).getPosXY().x,ex=this.getPoint(1).getPosXY().x;return!(y>sy+4||y<sy-4)&&(!(sx>ex&&(x>sx+4||x<ex-4))&&(!(sx<ex&&(x<sx-4||x>ex+4))&&(this.select(),!0)))};var CHoriStraightLineObject=create_class(CBiToolObject);CHoriStraightLineObject.prototype.__construct=function(name){CHoriStraightLineObject.__super.__construct.call(this,name),this.drawer=new DrawHoriStraightLinesPlotter(name,this)},CHoriStraightLineObject.prototype.setDrawPos=function(x,y){for(var index in this.points)this.points[index].setPosXY(x,y)},CHoriStraightLineObject.prototype.isSelected=function(x,y){if(1==CHoriStraightLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);var sy=this.getPoint(0).getPosXY().y;return!(y>sy+4||y<sy-4)&&(this.select(),!0)};var CRayLineObject=create_class(CBiToolObject);CRayLineObject.prototype.__construct=function(name){CRayLineObject.__super.__construct.call(this,name),this.drawer=new DrawRayLinesPlotter(name,this)},CRayLineObject.prototype.isSelected=function(x,y){if(1==CRayLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);var sx=this.getPoint(0).getPosXY().x,ex=this.getPoint(1).getPosXY().x;return!(ex>sx&&x<sx-4)&&(!(ex<sx&&x>sx+4)&&(this.calcDistance(this.getPoint(0),this.getPoint(1),c)<4&&(this.select(),!0)))};var CSegLineObject=create_class(CBiToolObject);CSegLineObject.prototype.__construct=function(name){CSegLineObject.__super.__construct.call(this,name),this.drawer=new DrawSegLinesPlotter(name,this)},CSegLineObject.prototype.isSelected=function(x,y){if(1==CSegLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");return c.setPosXY(x,y),0!=this.isWithRect(this.getPoint(0),this.getPoint(1),c)&&(this.calcDistance(this.getPoint(0),this.getPoint(1),c)<4&&(this.select(),!0))};var CStraightLineObject=create_class(CBiToolObject);CStraightLineObject.prototype.__construct=function(name){CStraightLineObject.__super.__construct.call(this,name),this.drawer=new DrawStraightLinesPlotter(name,this)},CStraightLineObject.prototype.isSelected=function(x,y){if(1==CStraightLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");return c.setPosXY(x,y),this.calcDistance(this.getPoint(0),this.getPoint(1),c)<4&&(this.select(),!0)};var CTriParallelLineObject=create_class(CTriToolObject);CTriParallelLineObject.prototype.__construct=function(name){CTriParallelLineObject.__super.__construct.call(this,name),this.drawer=new DrawTriParallelLinesPlotter(name,this)},CTriParallelLineObject.prototype.isSelected=function(x,y){if(1==CTriParallelLineObject.__super.isSelected.call(this,x,y))return!0;var _0x=(this.getChartObjects(),this.getPoint(0).getPosXY().x),_0y=this.getPoint(0).getPosXY().y,_1x=this.getPoint(1).getPosXY().x,_1y=this.getPoint(1).getPosXY().y,_2x=this.getPoint(2).getPosXY().x,_2y=this.getPoint(2).getPosXY().y,_a={x:_0x-_1x,y:_0y-_1y},_b={x:_0x-_2x,y:_0y-_2y},_c={x:_a.x+_b.x,y:_a.y+_b.y},_3x=_0x-_c.x,_3y=_0y-_c.y,r1={sx:_0x,sy:_0y,ex:_2x,ey:_2y},r2={sx:_1x,sy:_1y,ex:_3x,ey:_3y},_ri={x:_1x-_0x,y:_1y-_0y},_rj={x:_3x-_2x,y:_3y-_2y},_4x=Math.abs(_ri.x-_0x),_4y=Math.abs(_ri.y-_0y),_5x=Math.abs(_rj.x-_2x),_5y=Math.abs(_rj.y-_2y),r3={sx:_4x,sy:_4y,ex:_5x,ey:_5y};return!(this.calcGap(r1,x,y)>4&&this.calcGap(r2,x,y)>4&&this.calcGap(r3,x,y)>4)&&(this.select(),!0)};var CVertiStraightLineObject=create_class(CBiToolObject);CVertiStraightLineObject.prototype.__construct=function(name){CVertiStraightLineObject.__super.__construct.call(this,name),this.drawer=new DrawVertiStraightLinesPlotter(name,this)},CVertiStraightLineObject.prototype.setDrawPos=function(x,y){for(var index in this.points)this.points[index].setPosXY(x,y)},CVertiStraightLineObject.prototype.isSelected=function(x,y){if(1==CVertiStraightLineObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);var sx=this.getPoint(0).getPosXY().x;return!(x>sx+4||x<sx-4)&&(this.select(),!0)};var CPriceLineObject=create_class(CSegLineObject);CPriceLineObject.prototype.__construct=function(name){CPriceLineObject.__super.__construct.call(this,name),this.drawer=new DrawPriceLinesPlotter(name,this)},CPriceLineObject.prototype.setDrawPos=function(x,y){for(var index in this.points)this.points[index].setPosXY(x,y)},CPriceLineObject.prototype.isSelected=function(x,y){if(1==CFibRetraceObject.__super.isSelected.call(this,x,y))return!0;var c=new CPoint("frame0.k0");c.setPosXY(x,y);var sx=this.getPoint(0).getPosXY().x,sy=this.getPoint(0).getPosXY().y;this.getPoint(1).getPosXY().x,this.getPoint(1).getPosXY().y;return!(x<sx-4)&&(!(y>=sy+4||y<=sy-4)&&(this.select(),!0))};var CArrowLineObject=create_class(CSegLineObject);CArrowLineObject.prototype.__construct=function(name){CArrowLineObject.__super.__construct.call(this,name),this.drawer=new DrawArrowLinesPlotter(name,this)};var CToolManager=create_class(NamedObject);CToolManager.prototype.__construct=function(name){CToolManager.__super.__construct.call(this,name),this.selectedObject=-1,this.toolObjects=[]},CToolManager.prototype.getToolObjectCount=function(){return this.toolObjects.length},CToolManager.prototype.addToolObject=function(o){this.toolObjects.push(o)},CToolManager.prototype.getToolObject=function(i){return i<this.toolObjects.length&&i>=0?this.toolObjects[i]:null},CToolManager.prototype.getCurrentObject=function(){return this.getToolObject(this.getToolObjectCount()-1)},CToolManager.prototype.getSelectedObject=function(){return this.getToolObject(this.selectedObject)},CToolManager.prototype.delCurrentObject=function(){this.toolObjects.splice(this.getToolObjectCount()-1,1)},CToolManager.prototype.delSelectedObject=function(){this.toolObjects.splice(this.selectedObject,1),this.selectedObject=-1},CToolManager.prototype.acceptMouseMoveEvent=function(x,y){if(this.selectedObject==-1){var curr=this.toolObjects[this.getToolObjectCount()-1];if(null!=curr&&curr.getState()!=CToolObject.state.AfterDraw)return curr.acceptMouseMoveEvent(x,y)}else{var sel=this.toolObjects[this.selectedObject];if(sel.getState()==CToolObject.state.Draw)return sel.acceptMouseMoveEvent(x,y);sel.unselect(),this.selectedObject=-1}for(var index in this.toolObjects)if(this.toolObjects[index].isSelected(x,y))return this.selectedObject=index,!1;return!1},CToolManager.prototype.acceptMouseDownEvent=function(x,y){if(this.mouseDownMove=!1,this.selectedObject==-1){var curr=this.toolObjects[this.getToolObjectCount()-1];if(null!=curr&&curr.getState()!=CToolObject.state.AfterDraw)return curr.acceptMouseDownEvent(x,y)}else{var sel=this.toolObjects[this.selectedObject];if(sel.getState()!=CToolObject.state.BeforeDraw)return sel.acceptMouseDownEvent(x,y)}return!1},CToolManager.prototype.acceptMouseDownMoveEvent=function(x,y){if(this.mouseDownMove=!0,this.selectedObject==-1){var curr=this.toolObjects[this.getToolObjectCount()-1];return null!=curr&&curr.getState()==CToolObject.state.Draw&&curr.acceptMouseDownMoveEvent(x,y)}var sel=this.toolObjects[this.selectedObject];if(sel.getState()!=CToolObject.state.BeforeDraw){if(1==sel.acceptMouseDownMoveEvent(x,y))for(var point=this.toolObjects[this.selectedObject].points,i=0;i<point.length;i++)if(point[i].state==CPoint.state.Highlight||point[i].state==CPoint.state.Show)return!0;return!0}},CToolManager.prototype.acceptMouseUpEvent=function(x,y){if(1==this.mouseDownMove){if(this.selectedObject==-1){var curr=this.toolObjects[this.getToolObjectCount()-1];return null==curr||curr.getState()!=CToolObject.state.Draw||curr.acceptMouseUpEvent(x,y)}var sel=this.toolObjects[this.selectedObject];if(sel.getState()!=CToolObject.state.BeforeDraw)return sel.acceptMouseUpEvent(x,y)}if(this.selectedObject!=-1)return!0;var curr=this.toolObjects[this.getToolObjectCount()-1];if(null!=curr){if(curr.getState()==CToolObject.state.Draw)return!0;if(!curr.isValidMouseXY(x,y))return!1;if(curr.isSelected(x,y))return!0}return!1};var CToolPlotter=create_class(NamedObject);CToolPlotter.prototype.__construct=function(name,toolObject){CToolPlotter.__super.__construct.call(this,name),this.toolObject=toolObject;var pMgr=ChartManager.getInstance(),pArea=pMgr.getArea("frame0.k0.main");return null==pArea?void(this.areaPos={left:0,top:0,right:0,bottom:0}):(this.areaPos={left:pArea.getLeft(),top:pArea.getTop(),right:pArea.getRight(),bottom:pArea.getBottom()},this.crossPt={},this.normalSize=4,this.selectedSize=6,this.cursorLen=4,this.cursorGapLen=3,void(this.theme=ChartManager.getInstance().getTheme(this.getFrameName())))},CToolPlotter.prototype.drawCursor=function(context){this.drawCrossCursor(context)},CToolPlotter.prototype.drawCrossCursor=function(context){context.strokeStyle=this.theme.getColor(Theme.Color.LineColorNormal),context.fillStyle=this.theme.getColor(Theme.Color.LineColorNormal);var tempPt=this.toolObject.getPoint(0).getPosXY();if(null!=tempPt){var x=tempPt.x,y=tempPt.y,cursorLen=this.cursorLen,cursorGapLen=this.cursorGapLen;context.fillRect(x,y,1,1),Plotter.drawLine(context,x-cursorLen-cursorGapLen,y,x-cursorGapLen,y),Plotter.drawLine(context,x+cursorLen+cursorGapLen,y,x+cursorGapLen,y),Plotter.drawLine(context,x,y-cursorLen-cursorGapLen,x,y-cursorGapLen),Plotter.drawLine(context,x,y+cursorLen+cursorGapLen,x,y+cursorGapLen)}},CToolPlotter.prototype.drawCircle=function(context,center,radius){var centerX=center.x,centerY=center.y;context.beginPath(),context.arc(centerX,centerY,radius,0,2*Math.PI,!1),context.fillStyle=this.theme.getColor(Theme.Color.CircleColorFill),context.fill(),context.stroke()},CToolPlotter.prototype.drawCtrlPt=function(context){context.strokeStyle=this.theme.getColor(Theme.Color.CircleColorStroke);for(var i=0;i<this.ctrlPtsNum;i++)this.drawCircle(context,this.ctrlPts[1][i],this.normalSize)},CToolPlotter.prototype.highlightCtrlPt=function(context){context.strokeStyle=this.theme.getColor(Theme.Color.CircleColorStroke);for(var i=0;i<this.ctrlPtsNum;i++)this.toolObject.getPoint(i).getState()==CPoint.state.Highlight&&this.drawCircle(context,this.ctrlPts[1][i],this.selectedSize)},CToolPlotter.prototype.drawFibRayLines=function(context,startPoint,endPoint){for(var i=0;i<this.fiboFansSequence.length;i++){var stageY=startPoint.y+(100-this.fiboFansSequence[i])/100*(endPoint.y-startPoint.y),tempStartPt={x:startPoint.x,y:startPoint.y},tempEndPt={x:endPoint.x,y:stageY};this.drawRayLines(context,tempStartPt,tempEndPt)}},CToolPlotter.prototype.drawRayLines=function(context,startPoint,endPoint){this.getAreaPos();var tempCrossPt,tempStartPt={x:startPoint.x,y:startPoint.y},tempEndPt={x:endPoint.x,y:endPoint.y},crossPt=getRectCrossPt(this.areaPos,tempStartPt,tempEndPt);tempCrossPt=endPoint.x==startPoint.x?endPoint.y==startPoint.y?endPoint:endPoint.y>startPoint.y?{x:crossPt[1].x,y:crossPt[1].y}:{x:crossPt[0].x,y:crossPt[0].y}:endPoint.x>startPoint.x?{x:crossPt[1].x,y:crossPt[1].y}:{x:crossPt[0].x,y:crossPt[0].y},Plotter.drawLine(context,startPoint.x,startPoint.y,tempCrossPt.x,tempCrossPt.y)},CToolPlotter.prototype.lenBetweenPts=function(pt1,pt2){return Math.sqrt(Math.pow(pt2.x-pt1.x,2)+Math.pow(pt2.y-pt1.y,2))},CToolPlotter.prototype.getCtrlPts=function(){for(var i=0;i<this.ctrlPtsNum;i++)this.ctrlPts[0][i]=this.toolObject.getPoint(i)},CToolPlotter.prototype.updateCtrlPtPos=function(){for(var i=0;i<this.ctrlPtsNum;i++)this.ctrlPts[1][i]=this.ctrlPts[0][i].getPosXY()},CToolPlotter.prototype.getAreaPos=function(){var pMgr=ChartManager.getInstance(),pArea=pMgr.getArea("frame0.k0.main");return null==pArea?void(this.areaPos={left:0,top:0,right:0,bottom:0}):void(this.areaPos={left:Math.floor(pArea.getLeft()),top:Math.floor(pArea.getTop()),right:Math.floor(pArea.getRight()),bottom:Math.floor(pArea.getBottom())})},CToolPlotter.prototype.updateDraw=function(context){context.strokeStyle=this.theme.getColor(Theme.Color.LineColorNormal),this.draw(context),this.drawCtrlPt(context)},CToolPlotter.prototype.finishDraw=function(context){context.strokeStyle=this.theme.getColor(Theme.Color.LineColorNormal),this.draw(context)},CToolPlotter.prototype.highlight=function(context){context.strokeStyle=this.theme.getColor(Theme.Color.LineColorSelected),this.draw(context),this.drawCtrlPt(context),this.highlightCtrlPt(context)};var DrawStraightLinesPlotter=create_class(CToolPlotter);DrawStraightLinesPlotter.prototype.__construct=function(name,toolObject){DrawStraightLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawStraightLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.startPoint.x==this.endPoint.x&&this.startPoint.y==this.endPoint.y?Plotter.drawLine(context,this.areaPos.left,this.startPoint.y,this.areaPos.right,this.startPoint.y):(this.crossPt=getRectCrossPt(this.areaPos,this.startPoint,this.endPoint),Plotter.drawLine(context,this.crossPt[0].x,this.crossPt[0].y,this.crossPt[1].x,this.crossPt[1].y))};var DrawSegLinesPlotter=create_class(CToolPlotter);DrawSegLinesPlotter.prototype.__construct=function(name,toolObject){DrawSegLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawSegLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.startPoint.x==this.endPoint.x&&this.startPoint.y==this.endPoint.y&&(this.endPoint.x+=1),Plotter.drawLine(context,this.startPoint.x,this.startPoint.y,this.endPoint.x,this.endPoint.y)};var DrawRayLinesPlotter=create_class(CToolPlotter);DrawRayLinesPlotter.prototype.__construct=function(name,toolObject){DrawRayLinesPlotter.__super.__construct.call(this,name),this.toolObject=toolObject,this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawRayLinesPlotter.prototype.draw=function(context){
this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.startPoint.x==this.endPoint.x&&this.startPoint.y==this.endPoint.y&&(this.endPoint.x+=1),this.drawRayLines(context,this.startPoint,this.endPoint)};var DrawArrowLinesPlotter=create_class(CToolPlotter);DrawArrowLinesPlotter.prototype.__construct=function(name,toolObject){DrawArrowLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.arrowSizeRatio=.03,this.arrowSize=4,this.crossPt={x:-1,y:-1},this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawArrowLinesPlotter.prototype.drawArrow=function(context,startPoint,endPoint){var len=this.lenBetweenPts(startPoint,endPoint),vectorA=[endPoint.x-startPoint.x,endPoint.y-startPoint.y];this.crossPt.x=startPoint.x+(1-this.arrowSize/len)*vectorA[0],this.crossPt.y=startPoint.y+(1-this.arrowSize/len)*vectorA[1];var vectorAautho=[-vectorA[1],vectorA[0]],Aautho={x:vectorAautho[0],y:vectorAautho[1]},origin={x:0,y:0};vectorAautho[0]=this.arrowSize*Aautho.x/this.lenBetweenPts(Aautho,origin),vectorAautho[1]=this.arrowSize*Aautho.y/this.lenBetweenPts(Aautho,origin);var arrowEndPt=[this.crossPt.x+vectorAautho[0],this.crossPt.y+vectorAautho[1]];Plotter.drawLine(context,endPoint.x,endPoint.y,arrowEndPt[0],arrowEndPt[1]),arrowEndPt=[this.crossPt.x-vectorAautho[0],this.crossPt.y-vectorAautho[1]],Plotter.drawLine(context,endPoint.x,endPoint.y,arrowEndPt[0],arrowEndPt[1])},DrawArrowLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.startPoint.x==this.endPoint.x&&this.startPoint.y==this.endPoint.y&&(this.endPoint.x+=1),Plotter.drawLine(context,this.startPoint.x,this.startPoint.y,this.endPoint.x,this.endPoint.y),this.drawArrow(context,this.startPoint,this.endPoint)};var DrawHoriStraightLinesPlotter=create_class(CToolPlotter);DrawHoriStraightLinesPlotter.prototype.__construct=function(name,toolObject){DrawHoriStraightLinesPlotter.__super.__construct.call(this,name),this.toolObject=toolObject,this.ctrlPtsNum=1,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawHoriStraightLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],Plotter.drawLine(context,this.areaPos.left,this.startPoint.y,this.areaPos.right,this.startPoint.y)};var DrawHoriRayLinesPlotter=create_class(CToolPlotter);DrawHoriRayLinesPlotter.prototype.__construct=function(name,toolObject){DrawHoriRayLinesPlotter.__super.__construct.call(this,name),this.toolObject=toolObject,this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawHoriRayLinesPlotter.prototype.draw=function(context){if(this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.startPoint.x==this.endPoint.x)Plotter.drawLine(context,this.startPoint.x,this.startPoint.y,this.areaPos.right,this.startPoint.y);else{var tempEndPt={x:this.endPoint.x,y:this.startPoint.y};this.drawRayLines(context,this.startPoint,tempEndPt)}};var DrawHoriSegLinesPlotter=create_class(CToolPlotter);DrawHoriSegLinesPlotter.prototype.__construct=function(name,toolObject){DrawHoriSegLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawHoriSegLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.endPoint.y=this.startPoint.y,this.startPoint.x==this.endPoint.x&&this.startPoint.y==this.endPoint.y?Plotter.drawLine(context,this.startPoint.x,this.startPoint.y,this.endPoint.x+1,this.startPoint.y):Plotter.drawLine(context,this.startPoint.x,this.startPoint.y,this.endPoint.x,this.startPoint.y)};var DrawVertiStraightLinesPlotter=create_class(CToolPlotter);DrawVertiStraightLinesPlotter.prototype.__construct=function(name,toolObject){DrawVertiStraightLinesPlotter.__super.__construct.call(this,name),this.toolObject=toolObject,this.ctrlPtsNum=1,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawVertiStraightLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],Plotter.drawLine(context,this.startPoint.x,this.areaPos.top,this.startPoint.x,this.areaPos.bottom)};var DrawPriceLinesPlotter=create_class(CToolPlotter);DrawPriceLinesPlotter.prototype.__construct=function(name,toolObject){DrawPriceLinesPlotter.__super.__construct.call(this,name),this.toolObject=toolObject,this.ctrlPtsNum=1,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawPriceLinesPlotter.prototype.draw=function(context){context.font="12px Tahoma",context.textAlign="left",context.fillStyle=this.theme.getColor(Theme.Color.LineColorNormal),this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0];var text=this.ctrlPts[0][0].getPosIV().v;Plotter.drawLine(context,this.startPoint.x,this.startPoint.y,this.areaPos.right,this.startPoint.y),context.fillText(text.toFixed(2),this.startPoint.x+2,this.startPoint.y-15)};var ParallelLinesPlotter=create_class(CToolPlotter);ParallelLinesPlotter.prototype.__construct=function(name,toolObject){ParallelLinesPlotter.__super.__construct.call(this,name),this.toolObject=toolObject},ParallelLinesPlotter.prototype.getParaPt=function(){var vectorA=[];vectorA[0]=this.endPoint.x-this.startPoint.x,vectorA[1]=this.endPoint.y-this.startPoint.y;var vectorB=[];vectorB[0]=this.paraStartPoint.x-this.startPoint.x,vectorB[1]=this.paraStartPoint.y-this.startPoint.y,this.paraEndPoint={x:-1,y:-1},this.paraEndPoint.x=vectorA[0]+vectorB[0]+this.startPoint.x,this.paraEndPoint.y=vectorA[1]+vectorB[1]+this.startPoint.y};var DrawBiParallelLinesPlotter=create_class(ParallelLinesPlotter);DrawBiParallelLinesPlotter.prototype.__construct=function(name,toolObject){DrawBiParallelLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.ctrlPtsNum=3,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawBiParallelLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.paraStartPoint=this.ctrlPts[1][1],this.endPoint=this.ctrlPts[1][2],this.getParaPt(),this.getAreaPos(),this.crossPt0=getRectCrossPt(this.areaPos,this.startPoint,this.endPoint),Plotter.drawLine(context,this.crossPt0[0].x,this.crossPt0[0].y,this.crossPt0[1].x,this.crossPt0[1].y),this.crossPt1=getRectCrossPt(this.areaPos,this.paraStartPoint,this.paraEndPoint),Plotter.drawLine(context,this.crossPt1[0].x,this.crossPt1[0].y,this.crossPt1[1].x,this.crossPt1[1].y)};var DrawBiParallelRayLinesPlotter=create_class(ParallelLinesPlotter);DrawBiParallelRayLinesPlotter.prototype.__construct=function(name,toolObject){DrawBiParallelRayLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.ctrlPtsNum=3,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawBiParallelRayLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.paraStartPoint=this.ctrlPts[1][1],this.endPoint=this.ctrlPts[1][2],this.startPoint.x==this.endPoint.x&&this.startPoint.y==this.endPoint.y&&(this.endPoint.x+=1),this.getParaPt(),this.drawRayLines(context,this.startPoint,this.endPoint),this.drawRayLines(context,this.paraStartPoint,this.paraEndPoint)};var DrawTriParallelLinesPlotter=create_class(ParallelLinesPlotter);DrawTriParallelLinesPlotter.prototype.__construct=function(name,toolObject){DrawTriParallelLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.ctrlPtsNum=3,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawTriParallelLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.paraStartPoint=this.ctrlPts[1][1],this.endPoint=this.ctrlPts[1][2];var vectorA=[];vectorA[0]=this.endPoint.x-this.startPoint.x,vectorA[1]=this.endPoint.y-this.startPoint.y;var vectorB=[];vectorB[0]=this.paraStartPoint.x-this.startPoint.x,vectorB[1]=this.paraStartPoint.y-this.startPoint.y,this.para1EndPoint={x:-1,y:-1},this.para2EndPoint={x:-1,y:-1},this.para2StartPoint={x:-1,y:-1},this.para1EndPoint.x=vectorA[0]+vectorB[0]+this.startPoint.x,this.para1EndPoint.y=vectorA[1]+vectorB[1]+this.startPoint.y,this.para2StartPoint.x=this.startPoint.x-vectorB[0],this.para2StartPoint.y=this.startPoint.y-vectorB[1],this.para2EndPoint.x=this.endPoint.x-vectorB[0],this.para2EndPoint.y=this.endPoint.y-vectorB[1],this.getAreaPos(),this.crossPt0=getRectCrossPt(this.areaPos,this.startPoint,this.endPoint),Plotter.drawLine(context,this.crossPt0[0].x,this.crossPt0[0].y,this.crossPt0[1].x,this.crossPt0[1].y),this.crossPt1=getRectCrossPt(this.areaPos,this.paraStartPoint,this.para1EndPoint),Plotter.drawLine(context,this.crossPt1[0].x,this.crossPt1[0].y,this.crossPt1[1].x,this.crossPt1[1].y),this.crossPt2=getRectCrossPt(this.areaPos,this.para2StartPoint,this.para2EndPoint),Plotter.drawLine(context,this.crossPt2[0].x,this.crossPt2[0].y,this.crossPt2[1].x,this.crossPt2[1].y)};var BandLinesPlotter=create_class(CToolPlotter);BandLinesPlotter.prototype.__construct=function(name,toolObject){BandLinesPlotter.__super.__construct.call(this,name),this.toolObject=toolObject,this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},BandLinesPlotter.prototype.drawLinesAndInfo=function(context,startPoint,endPoint){context.font="12px Tahoma",context.textAlign="left",context.fillStyle=this.theme.getColor(Theme.Color.LineColorNormal);var text;this.toolObject.state==CToolObject.state.Draw&&(this.startPtValue=this.toolObject.getPoint(0).getPosIV().v,this.endPtValue=this.toolObject.getPoint(1).getPosIV().v),this.getAreaPos();for(var i=0;i<this.fiboSequence.length;i++){var stageY=startPoint.y+(100-this.fiboSequence[i])/100*(endPoint.y-startPoint.y);if(!(stageY>this.areaPos.bottom)){var stageYvalue=this.startPtValue+(100-this.fiboSequence[i])/100*(this.endPtValue-this.startPtValue);Plotter.drawLine(context,this.areaPos.left,stageY,this.areaPos.right,stageY),text=this.fiboSequence[i].toFixed(1)+"% "+stageYvalue.toFixed(1),context.fillText(text,this.areaPos.left+2,stageY-15)}}},BandLinesPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.drawLinesAndInfo(context,this.startPoint,this.endPoint)};var DrawFibRetracePlotter=create_class(BandLinesPlotter);DrawFibRetracePlotter.prototype.__construct=function(name,toolObject){DrawFibRetracePlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.fiboSequence=[100,78.6,61.8,50,38.2,23.6,0]};var DrawBandLinesPlotter=create_class(BandLinesPlotter);DrawBandLinesPlotter.prototype.__construct=function(name,toolObject){DrawBandLinesPlotter.__super.__construct.call(this,name,toolObject),this.toolObject=toolObject,this.fiboSequence=[0,12.5,25,37.5,50,62.5,75,87.5,100]};var DrawFibFansPlotter=create_class(CToolPlotter);DrawFibFansPlotter.prototype.__construct=function(name,toolObject){DrawFibFansPlotter.__super.__construct.call(this,name),this.toolObject=toolObject,this.fiboFansSequence=[0,38.2,50,61.8],this.ctrlPtsNum=2,this.ctrlPts=new Array(new Array(this.ctrlPtsNum),new Array(2)),this.getCtrlPts()},DrawFibFansPlotter.prototype.drawLinesAndInfo=function(context,startPoint,endPoint){this.drawFibRayLines(context,startPoint,endPoint)},DrawFibFansPlotter.prototype.draw=function(context){this.updateCtrlPtPos(),this.getAreaPos(),this.startPoint=this.ctrlPts[1][0],this.endPoint=this.ctrlPts[1][1],this.startPoint.x==this.endPoint.x&&this.startPoint.y==this.endPoint.y&&(this.endPoint.x+=1),this.drawLinesAndInfo(context,this.startPoint,this.endPoint)};var CDynamicLinePlotter=create_class(NamedObject);CDynamicLinePlotter.prototype.__construct=function(name){CDynamicLinePlotter.__super.__construct.call(this,name),this.flag=!0,this.context=ChartManager.getInstance()._overlayContext},CDynamicLinePlotter.prototype.getAreaPos=function(){var pMgr=ChartManager.getInstance(),pArea=pMgr.getArea("frame0.k0.main");return null==pArea?void(this.areaPos={left:0,top:0,right:0,bottom:0}):void(this.areaPos={left:Math.floor(pArea.getLeft()),top:Math.floor(pArea.getTop()),right:Math.floor(pArea.getRight()),bottom:Math.floor(pArea.getBottom())})},CDynamicLinePlotter.prototype.Draw=function(context){this.getAreaPos();var pMgr=ChartManager.getInstance(),pTDP=pMgr.getDataSource(this.getDataSourceName());if(null!=pTDP&&is_instance(pTDP,MainDataSource)){this.context.save(),this.context.rect(this.areaPos.left,this.areaPos.top,this.areaPos.right-this.areaPos.left,this.areaPos.bottom-this.areaPos.top),this.context.clip();for(var count=pTDP.getToolObjectCount(),i=0;i<count;i++){var toolObject=pTDP.getToolObject(i),state=toolObject.getState();switch(state){case CToolObject.state.BeforeDraw:toolObject.getPlotter().theme=ChartManager.getInstance().getTheme(this.getFrameName()),toolObject.getPlotter().drawCursor(this.context);break;case CToolObject.state.Draw:toolObject.getPlotter().theme=ChartManager.getInstance().getTheme(this.getFrameName()),toolObject.getPlotter().updateDraw(this.context);break;case CToolObject.state.AfterDraw:toolObject.getPlotter().theme=ChartManager.getInstance().getTheme(this.getFrameName()),toolObject.getPlotter().finishDraw(this.context)}}var sel=pTDP.getSelectToolObjcet();null!=sel&&sel!=CToolObject.state.Draw&&sel.getPlotter().highlight(this.context),this.context.restore()}};var refresh_counter=0,refresh_handler=setInterval(refresh_function,1e3),RequestData=function(showLoading){AbortRequest(),window.clearTimeout(GLOBAL_VAR.TimeOutId),1==showLoading&&$("#chart_loading").addClass("activated"),$(document).ready(GLOBAL_VAR.G_HTTP_REQUEST=$.ajax({type:"get",url:GLOBAL_VAR.url,dataType:"text",data:GLOBAL_VAR.requestParam,timeout:5e3,created:Date.now(),beforeSend:function(){this.time=GLOBAL_VAR.time_type,this.market=GLOBAL_VAR.mark_from},success:function(json){if(GLOBAL_VAR.G_HTTP_REQUEST){if(this.time!=GLOBAL_VAR.time_type||this.market!=GLOBAL_VAR.mark_from)return void(GLOBAL_VAR.TimeOutId=setTimeout(RequestData,2e3));for(var jsonData=JSON.parse(json).data,jsonArray=[],i=0;i<jsonData.length;i++)jsonArray.push([jsonData[i].createdDate,Number(jsonData[i].open),Number(jsonData[i].high),Number(jsonData[i].low),Number(jsonData[i].close),Number(jsonData[i].volume)]);if(GLOBAL_VAR.KLineData=jsonArray,1==ChartManager.getInstance().getChart()._money_type){var rate=ChartManager.getInstance().getChart()._usd_cny_rate;for(var i in GLOBAL_VAR.KLineData){var e=GLOBAL_VAR.KLineData[i];e[1]=parseFloat((e[1]*rate).toFixed(GLOBAL_VAR.digits)),e[2]=parseFloat((e[2]*rate).toFixed(GLOBAL_VAR.digits)),e[3]=parseFloat((e[3]*rate).toFixed(GLOBAL_VAR.digits)),e[4]=parseFloat((e[4]*rate).toFixed(GLOBAL_VAR.digits))}}try{if(!GLOBAL_VAR.chartMgr.updateData("frame0.k0",GLOBAL_VAR.KLineData))return GLOBAL_VAR.requestParam=setHttpRequestParam(GLOBAL_VAR.mark_from,GLOBAL_VAR.time_type,"1000",null),void(GLOBAL_VAR.TimeOutId=setTimeout(RequestData,2e3));clear_refresh_counter()}catch(err){if("calcInterval"==err)return GLOBAL_VAR.requestParam=setHttpRequestParam(GLOBAL_VAR.mark_from,GLOBAL_VAR.time_type,"1000",null),void(GLOBAL_VAR.TimeOutId=setTimeout(RequestData,2e3))}Pushing.state==Pushing.State.Enable?Pushing.Switch():GLOBAL_VAR.TimeOutId=setTimeout(TwoSecondThread,2e3),$("#chart_loading").removeClass("activated"),ChartManager.getInstance().redraw("All",!0)}},error:function(xhr,textStatus,errorThrown){GLOBAL_VAR.TimeOutId=setTimeout(function(){RequestData(!0)},1e4)},complete:function(){GLOBAL_VAR.G_HTTP_REQUEST=null}}))},main=function(){window.onPushingStarted=function(callback){Pushing.Start(callback)},window.onPushingResponse=function(marketFrom,type,coinVol,data){Pushing.Response(marketFrom,type,coinVol,data)},window.onPushingStop=function(){Pushing.Stop()},window._KlineIndex=function(content){if(Template.displayVolume=!1,refreshTemplate(),readCookie(),0==content)ChartManager.getInstance().getChart().setKlineIndex("17");else{if(3!=content)return;ChartManager.getInstance().getChart().setKlineIndex("18")}},window._display_future_list=function(){$("#chart_dropdown_symbols")[0].style.display="block"},window._set_current_language=function(content){chart_switch_language(content)},window._set_current_depth=function(content){ChartManager.getInstance().getChart().updateDepth(content)},window._set_current_coin=function(content){ChartManager.getInstance().getChart().setCurrentCoin(content)},window._set_current_url=function(content){GLOBAL_VAR.url=content},window._set_future_list=function(content){ChartManager.getInstance().getChart().setFutureList(content)},window._set_current_future=function(contractID){ChartManager.getInstance().getChart().setCurrentFuture(contractID)},window._set_init_current_future=function(contractID){ChartManager.getInstance().getChart().setCurrentFutureNoRaise(contractID)},window._set_current_contract_unit=function(str){ChartManager.getInstance().getChart().setCurrentContractUnit(str)},window._set_money_type=function(str){ChartManager.getInstance().getChart().setCurrentMoneyType(str)},window._set_usd_cny_rate=function(rate){ChartManager.getInstance().getChart()._usd_cny_rate=rate},window._setCaptureMouseWheelDirectly=function(b){ChartManager.getInstance().setCaptureMouseWheelDirectly(b)},window._current_future_change=new MEvent,window._current_theme_change=new MEvent,chart_switch_language("en-us"),KLineMouseEvent(),ChartManager.getInstance().bindCanvas("main",document.getElementById("chart_mainCanvas")),ChartManager.getInstance().bindCanvas("overlay",document.getElementById("chart_overlayCanvas")),GLOBAL_VAR.requestParam="marketFrom=13&type=2&limit=1000",GLOBAL_VAR.mark_from="13",GLOBAL_VAR.time_type="2",GLOBAL_VAR.limit="1000",refreshTemplate(),on_size(),readCookie(),$("#chart_container").css({visibility:"visible"})}();