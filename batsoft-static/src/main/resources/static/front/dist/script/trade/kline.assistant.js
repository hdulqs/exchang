function Kline(){}function getQueryString(name){var reg=new RegExp("(^|&)"+name+"=([^&]*)(&|$)"),r=window.location.search.substr(1).match(reg);return null!=r?unescape(r[2]):null}Kline.prototype={browerState:0,klineSocketIo:null,klineWebsocket:null,klineTradeInit:!1,tradeDate:new Date,tradesLimit:100,lastDepth:null,depthShowSize:15,priceDecimalDigits:6,amountDecimalDigits:4,symbol:null,curPrice:null,title:"",reset:function(a){this.refreshUrl(a),$("#markettop li a").removeClass("selected"),$("#markettop li."+a+" a").addClass("selected"),this.symbol=a,this.lastDepth=null,this.curPrice=null,this.klineTradeInit=!1,$("#trades .trades_list").empty(),$("#gasks .table").empty(),$("#gbids .table").empty(),$("#asks .table").empty(),$("#bids .table").empty()},setTitle:function(){document.title=(null==this.curPrice?"":this.curPrice+" ")+this.title},dateFormatTf:function(a){return(a<10?"0":"")+a},dateFormat:function(a){return a.getFullYear()+"-"+this.dateFormatTf(a.getMonth()+1)+"-"+this.dateFormatTf(a.getDate())+" "+this.dateFormatTf(a.getHours())+":"+this.dateFormatTf(a.getMinutes())+":"+this.dateFormatTf(a.getSeconds())},dateInit:function(b){var a=new Date;b&&a.setTime(b),$(".m_rightbot").text(this.dateFormat(a));var c=this;setInterval(function(){a.setTime(a.getTime()+1e3),$(".m_rightbot").text(c.dateFormat(a))},1e3)},websocketRedister:function(symbol){function loadTradeJson(){$.ajax({type:"get",url:"http://www.batsoft.com/kline/tradeJson",dataType:"json",klineMessage:klineMessage,success:function(data){klineMessage(data.pushEntrusMarket),klineMessage(data.pushNewListRecordMarket)}})}var $this=this;this.klineWebsocket&&1==this.klineWebsocket.readyState&&this.klineWebsocket.close(),window.onbeforeunload=function(){$this.klineWebsocket&&1==$this.klineWebsocket.readyState&&$this.klineWebsocket.close()};var target="ws://localhost:8010/front/websocket";if("WebSocket"in window)this.klineWebsocket=new WebSocket(target);else{if(!("MozWebSocket"in window))return;this.klineWebsocket=new MozWebSocket(target)}this.klineWebsocket.onmessage=function(result){var data={depths:{asks:[[3010,100],[3008,.048],[3007,.048]],bids:[[2999,.013],[2998,.037]]}};data.trades&&($this.pushTrades(data.trades),$this.klineTradeInit=!0),data.depths&&$this.updateDepth(data.depths),clear_refresh_counter()};var klineMessage=function(result){var data=result;data.trades&&($this.pushTrades(data.trades),$this.klineTradeInit=!0),data.depths&&$this.updateDepth(data.depths),clear_refresh_counter()};setInterval(loadTradeJson,1e3),this.klineWebsocket.onopen=function(){},this.klineWebsocket.onerror=function(){},this.klineWebsocket.onclose=function(){}},pushTrades:function(k){for(var g=$("#trades .trades_list"),a="",d=0;d<k.length;d++){var l=k[d];if(d>=k.length-this.tradesLimit){this.tradeDate.setTime(1e3*l.time);var b=this.dateFormatTf(this.tradeDate.getHours())+":"+this.dateFormatTf(this.tradeDate.getMinutes())+":"+this.dateFormatTf(this.tradeDate.getSeconds()),e=(l.amount+"").split(".");a=this.klineTradeInit?"<ul class='newul'><li class='tm'>"+b+"</li><li class='pr-"+("buy"==l.type?"green":"red")+"'>"+l.price+"</li><li class='vl'>"+e[0]+"<g>"+(e.length>1?"."+e[1]:"")+"</g></li></ul>"+a:"<ul><li class='tm'>"+b+"</li><li class='pr-"+("buy"==l.type?"green":"red")+"'>"+l.price+"</li><li class='vl'>"+e[0]+"<g>"+(e.length>1?"."+e[1]:"")+"</g></li></ul>"+a}}var c=0,h=this;if(this.klineTradeInit){clearInterval(f);var f=setInterval(function(){var i=k[c];h.curPrice=i.price.toFixed(2),h.setTitle(),$("div#price").attr("class","buy"==i.type?"green":"red").text(h.curPrice),c++,c>=k.length&&clearInterval(f)},100)}else k.length>0&&(this.curPrice=k[k.length-1].price.toFixed(2),this.setTitle(),$("div#price").attr("class","buy"==k[k.length-1].type?"green":"red").text(this.curPrice));this.klineTradeInit?g.prepend(a):g.append(a),a=null,g.find("ul.newul").slideDown(1e3,function(){$(this).removeClass("newul")}),g.find("ul:gt("+(this.tradesLimit-1)+")").remove()},updateDepth:function(e){if($("#gasks .table").html(this.getgview(this.getgasks(e.asks))),$("#gbids .table").html(this.getgview(this.getgbids(e.bids))),null==this.lastDepth)this.lastDepth={},this.lastDepth.asks=this.getAsks(e.asks,this.depthShowSize),this.depthInit(this.lastDepth.asks,$("#asks .table")),this.lastDepth.bids=this.getBids(e.bids,this.depthShowSize),this.depthInit(this.lastDepth.bids,$("#bids .table"));else{var b=$("#asks .table");b.find("div.remove").remove(),b.find("div.add").removeClass("add");var f=this.getAsks(e.asks,this.depthShowSize),a=this.lastDepth.asks;this.lastDepth.asks=f,this.asksAndBids(f.slice(0),a,b);var d=$("#bids .table");d.find("div.remove").remove(),d.find("div.add").removeClass("add");var g=this.getBids(e.bids,this.depthShowSize),c=this.lastDepth.bids;this.lastDepth.bids=g,this.asksAndBids(g.slice(0),c,$("#bids .table"))}},depthInit:function(f,h){if(h.empty(),f&&f.length>0){for(var g,b="",e=0;e<f.length;e++){var a=(f[e][0]+"").split("."),d=this.getPrice(a,g);g=a[0],a=(f[e][1]+"").split(".");var c=this.getAmount(a);b+="<div class='row'><span class='price'>"+d[0]+"<g>"+d[1]+"</g></span> <span class='amount'>"+c[0]+"<g>"+c[1]+"</g></span></div>"}h.append(b),b=null}},asksAndBids:function(b,c,l){for(var f=0;f<c.length;f++){for(var n=!1,d=0;d<b.length;d++)if(c[f][0]==b[d][0]){if(n=!0,c[f][1]!=b[d][1]){var a=l.find("div:eq("+f+") .amount");a.addClass(c[f][1]>b[d][1]?"red":"green");var g=this.getAmount((b[d][1]+"").split("."));setTimeout(function(j,i){return function(){j.html(i[0]+"<g>"+i[1]+"</g>"),j.removeClass("red").removeClass("green"),j=null,i=null}}(a,g),500)}b.splice(d,1);break}n||(l.find("div:eq("+f+")").addClass("remove"),c[f][2]=-1)}for(var d=0;d<c.length;d++)for(var f=0;f<b.length;f++)if(b[f][0]>c[d][0]){var k=(b[f][1]+"").split("."),g=this.getAmount(k);l.find("div:eq("+d+")").before("<div class='row add'><span class='price'></span> <span class='amount'>"+g[0]+"<g>"+g[1]+"</g></span></div>"),c.splice(d,0,b[f]),b.splice(f,1);break}for(var h="",f=0;f<b.length;f++){c.push(b[f]);var k=(b[f][1]+"").split("."),g=this.getAmount(k);h+="<div class='row add'><span class='price'></span> <span class='amount'>"+g[0]+"<g>"+g[1]+"</g></span></div>"}h.length>0&&l.append(h),h=null;for(var m,f=0;f<c.length;f++){var o=l.find("div:eq("+f+")");if(!(c[f].length>=3&&c[f][2]==-1)){var k=(c[f][0]+"").split("."),e=this.getPrice(k,m);m=k[0],o.find(".price").html(e[0]+"<g>"+e[1]+"</g>")}}b=null,c=null,l.find("div.add").slideDown(800),setTimeout(function(i,j){return function(){i.slideUp(500,function(){$(this).remove()}),j.removeClass("add")}}(l.find("div.remove"),l.find("div.add")),1e3)},getAsks:function(b,a){return b.length>a&&b.splice(0,b.length-a),b},getBids:function(b,a){return b.length>a&&b.splice(a,b.length-1),b},getgview:function(c){for(var e,d="",b=0;b<c.length;b++){var a=c[b][0].split(".");1==a.length||a[0]!=e?(d+="<div class='row'><span class='price'>"+c[b][0]+"</span> <span class='amount'>"+c[b][1]+"</span></div>",e=a[0]):d+="<div class='row'><span class='price'><h>"+a[0]+".</h>"+a[1]+"</span> <span class='amount'>"+c[b][1]+"</span></div>"}return d},getgasks:function(j){var k=j[j.length-1][0],e=j[0][0],a=e-k,d=this.getBlock(a,100),b=Math.abs(Number(Math.log(d)/Math.log(10))).toFixed(0);a/d<2&&(d/=2,b++),d>=1&&(b=0),k=parseInt(k/d)*d,e=parseInt(e/d)*d;for(var h=[],g=0,f=j.length-1;f>=0;f--){if(j[f][0]>k){var c=parseInt(g,10);if(c>0&&h.unshift([Number(k).toFixed(b),c]),k>=e)break;k+=d}g+=j[f][1]}return h},getgbids:function(j){var k=j[j.length-1][0],e=j[0][0],a=e-k,d=this.getBlock(a,100),b=Math.abs(Number(Math.log(d)/Math.log(10))).toFixed(0);a/d<2&&(d/=2,b++),d>=1&&(b=0),k=parseInt(k/d)*d,e=parseInt(e/d)*d;for(var h=[],g=0,f=0;f<j.length;f++){if(j[f][0]<e){var c=parseInt(g,10);if(c>0&&h.push([Number(e).toFixed(b),c]),e<=k)break;e-=d}g+=j[f][1]}return h},getBlock:function(a,c){return a>c?c:(c/=10,this.getBlock(a,c))},getZeros:function(b){for(var a="";b>0;)b--,a+="0";return a},getPrice:function(a,d){var c=a[0];d==c?c="<h>"+c+".</h>":c+=".";var b="";return 1==a.length?(c+="0",b=this.getZeros(this.priceDecimalDigits-1)):(c+=a[1],b=this.getZeros(this.priceDecimalDigits-a[1].length)),[c,b]},getAmount:function(a){var c=a[0],b="",d=this.amountDecimalDigits-c.length+1;return d>0&&(b=".",b+=1==a.length?this.getZeros(d):d>a[1].length?a[1]+this.getZeros(d-a[1].length):d==a[1].length?a[1]:a[1].substring(0,d)),[c,b]},setTopTickers:function(c){if(c)for(var a=0;a<c.length;a++){var b=c[a];0==b.moneyType&&1==b.exeByRate?$("#markettop li."+b.symbol).find("span").text(b.ticker.dollar):$("#markettop li."+b.symbol).find("span").text(b.ticker.last)}},setMarketShow:function(e,b,d,c){var a=e+"  "+(b+"/"+d).toUpperCase();$("#market a:eq(0)").attr("href",c).attr("title",a).text(a)},refreshPage:function(a){a?window.location.href=this.basePath+"/market?symbol="+a:window.location.href=this.basePath+"/market"},refreshUrl:function(a){try{this.browerState++,$("#countView").find("iframe").attr("src","https://www.btc123.com/kline/marketCount/"+a+"?symbol="+a),History.pushState({state:this.browerState},this.title,"?symbol="+a)}catch(b){}}};