define(["backbone","template","Calculate","ajax"],function(){var socketObj,Backbone=require("backbone"),Calculate=require("Calculate"),template=require("template"),thisView=null,MarketLang=null,currentSymbol=null,$entrustList=$("#entrustList"),ajax=require("ajax"),tenNoDeal={init:function(socketHolder){socketObj=socketHolder,thisView=new this.view({model:new this.model})},ajaxLoad:function(symbol){currentSymbol=symbol,require(["i18n!../page/market/nls/lang"],function(lang){MarketLang=lang,thisView.model.set("symbol",symbol),thisView.render()})},socketRefresh:function(data,symbol){if(currentSymbol=symbol,data.base+"_"+data.quote===currentSymbol){data=data.data,$entrustList.find(".no-data").remove();var prevListLength=$entrustList.find("li").length,status=Number(data.status);if(0===status){var row=template("entrustRowTemplate",{Calculate:Calculate,MarketLang:MarketLang,priceTruncate:ok.priceTruncate(currentSymbol),amountTruncate:ok.amountTruncate(currentSymbol),currentSymbol:currentSymbol,data:data}),rows=$entrustList.find("li");rows.length>=10&&rows.last().remove(),$entrustList.prepend(row)}else if(1===status||3===status){var orderId=data.id,orderRow=$entrustList.find("#entrust"+orderId),price=0==data.orderType?Calculate.ShowDownTruncation(data.price,ok.priceTruncate(currentSymbol)):MarketLang.market_price;orderRow.find(".tree-price").html(price+"<br/>"+Calculate.ShowDownTruncation(data.size-data.filledSize,ok.amountTruncate(currentSymbol)));var text=1===status?MarketLang.trade_entrust_ten_partfulfilled:MarketLang.trade_entrust_ten_cancelling;orderRow.find(".tree-status").html(text)}else 2!==status&&status!==-1||$entrustList.find("#entrust"+data.id).remove();var currListLength=$entrustList.find("li").length;10===prevListLength&&9===currListLength&&setTimeout(function(){tenNoDeal.ajaxLoad(symbol)},500),0===currListLength&&$entrustList.html('<li class="no-data" style="text-align:center;">'+MarketLang.trade_entrust_ten_yhnoo+"</li>")}},view:Backbone.View.extend({el:$("#lastEntrusts"),events:{"click .operation":"cancelOrder"},initialize:function(){this.model.bind("change:data",this.updateTenNoDeal,this)},render:function(){this.model.fetch()},updateTenNoDeal:function(){var data=this.model.get("data").orders;tenNoDeal.entrustTemplate(data)},cancelOrder:function(e){var orderId=jQuery(e.target).attr("data-id");ajax.cancelOrder({opt:{orderId:orderId,symbol:currentSymbol},success:function(data){socketObj.isOnline||tenNoDeal.ajaxLoad(currentSymbol)},fail:function(err){}})}}),entrustTemplate:function(data){thisView.$el.find("#entrustLink").attr("href","/spot/trade/spotEntrust.do?symbol="+currentSymbol),thisView.$el.find("#entrustList").html(template("entrustTemplate",{Calculate:Calculate,MarketLang:MarketLang,priceTruncate:ok.priceTruncate(currentSymbol),amountTruncate:ok.amountTruncate(currentSymbol),currentSymbol:currentSymbol,orders:data}))},model:Backbone.Model.extend({defaults:{data:{}},sync:function(){var thisModel=this,symbol=this.get("symbol");ajax.getUnsettledOrders({data:{page:1,perPage:10,symbol:symbol},success:function(data){for(var orders=data.orders,i=0;i<orders.length;)orders[i].status!==-1&&2!==orders[i].status?i++:orders.splice(i,1);thisModel.set("data",data),thisView.updateTenNoDeal()},fail:function(err){}})}})};return tenNoDeal});